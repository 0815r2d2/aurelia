(function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("@aurelia/kernel"),require("@aurelia/runtime")):"function"==typeof define&&define.amd?define(["exports","@aurelia/kernel","@aurelia/runtime"],s):s((t=t||self).router={},t.kernel,t.runtime)})(this,function(t,kernel,runtime){"use strict";function s(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const h=t.replace("+"," ").split("&");for(const t of h){const h=t.split("="),e=decodeURIComponent(h.shift());if(!h.length){i.push(e);continue}const value=decodeURIComponent(h.shift());s[e]=value}return{t:s,list:i}}function i(t,s,i,h){var e,n,r=arguments.length,o=3>r?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,s,i,h);else for(n=t.length-1;n>=0;n--)(e=t[n])&&(o=(3>r?e(o):r>3?e(s,i,o):e(s,i))||o);return r>3&&o&&Object.defineProperty(s,i,o),o}class h{constructor(){this.s=(async t=>this.i(this,"popstate",[t])),this.window=window,this.history=window.history,this.h=[],this.o=0,this.l=null,this.u=null,this.p=null,this.v=null}g(t){if(this.o)throw kernel.Reporter.error(2003);this.o=1,this.u=t,kernel.PLATFORM.m.add(this.$,this),this.window.addEventListener("popstate",this.s)}C(){this.window.removeEventListener("popstate",this.s),kernel.PLATFORM.m.remove(this.$,this),this.u=null,this.o=0}get length(){return this.history.length}get state(){return this.history.state}get O(){return this.history.O}async go(t,s=0){if(!s)return this.i(this,"_go",[t],1);const i=this.i(this,"suppressPopstate",[],1);return this.i(this.history,"go",[t]).catch(t=>{throw t}),i}back(){return this.go(-1)}forward(){return this.go(1)}async pushState(t,s,i){return this.i(this.history,"pushState",[t,s,i])}async replaceState(t,s,i){return this.i(this.history,"replaceState",[t,s,i])}async S(t){if(this.v){const t=this.v;this.v=null,t()}else{if(this.p){const t=this.p;this.p=null,t(),await Promise.resolve()}this.u(t)}}P(t,s){this.p=s,this.history.go(t)}R(t){this.v=t}i(t,s,i,h=0){let e;const n=new Promise(t=>{e=t});return h&&(i.push(e),e=null),this.h.push({target:t,V:s,t:i,resolve:e}),n}async $(t){if(!this.h.length||null!==this.l)return;this.l=this.h.shift();const s=this.l.target[this.l.V];kernel.Reporter.write(1e4,"DEQUEUE",this.l.V,this.l.t),s.apply(this.l.target,this.l.t);const i=this.l.resolve;this.l=null,i&&i()}}class e{constructor(){this.j=(async()=>{const t=this.k(),s=this.H();kernel.Reporter.write(1e4,"path changed to",t,this.I,this.A);const i={};let h,e=this.N("HistoryEntry");if(this.I&&this.I.path===t){i.T=1;const t=this.q?this.A.index:this.history.length-this.U;h=this.A,this.A=this.I,this.A.index=t,this.q?(this._=0,this.D[this.A.index]=this.A,this.L?(i.F=1,this.L=0):i.J=1,this.q=0):(this._=1,this.D=this.D.slice(0,this.A.index),this.D.push(this.A)),await this.G({M:this.D,B:this.U,W:this.A})}else this.D=this.D||this.N("HistoryEntries")||[],this.U=this.U||this.N("HistoryOffset")||0,e||this.A?e?this.A?e.index>this.A.index?i.K=1:this.A.index>e.index&&(i.X=1):i.F=1:i.T=1:(i.T=1,i.Y=1,this.U=this.history.length),e||(e={path:t,Z:null,index:this.history.length-this.U,tt:s},i.Y&&(e.st=1),this.D=this.D.slice(0,e.index),this.D.push(e),await this.G({M:this.D,B:this.U,W:e})),this._=this.A?e.index-this.A.index:0,h=this.A,this.A=e;this.I=null,kernel.Reporter.write(1e4,"navigated",this.N("HistoryEntry"),this.D,this.N("HistoryOffset")),this.u(this.A,i,h)}),this.location=window.location,this.history=new h,this.A=null,this.D=null,this.U=null,this.it=null,this.I=null,this.options=null,this.o=0,this._=null,this.q=0,this.L=0}g(t){if(this.o)throw kernel.Reporter.error(0);return this.o=1,this.options=Object.assign({},t),this.history.g(this.j),Promise.resolve().then(()=>{this.ht(this.k(),1).catch(t=>{throw t})})}C(){this.history.C(),this.o=0}et(t,s,i){return this.I={path:t,Z:null,title:s,data:i},this.ht(t)}replace(t,s,i){return this.q=1,this.I={path:t,Z:null,title:s,data:i},this.ht(t,1)}async refresh(){if(this.A)return this.L=1,this.replace(this.A.path,this.A.title,this.A.data)}back(){return this.history.go(-1)}forward(){return this.history.go(1)}cancel(){const t=this._;return t?(this._=0,this.history.go(-t,1)):this.replace(this.it.path,this.it.title,this.it.data)}async pop(){await this.history.go(-1,1);const t=""+this.location,s=this.history.state;if(!s.W.st)return await this.history.go(-1,1),this.history.pushState(s,null,t)}async G(t,value){const{pathname:s,search:i,hash:h}=this.location;let e=Object.assign({},this.history.state);return"string"==typeof t?e[t]=JSON.parse(JSON.stringify(value)):e=Object.assign({},e,JSON.parse(JSON.stringify(t))),this.history.replaceState(e,null,`${s}${i}${h}`)}N(t){return Object.assign({},this.history.state)[t]}nt(t){return this.A.title=t,this.D[this.A.index]=this.A,this.G({M:this.D,W:this.A})}rt(t,s,i){if(i.index!==this.A.index)return;const h=`#/${t}`,{pathname:e,search:n,hash:r}=this.location;if(h===r&&this.A.path===t&&this.A.Z===s)return;this.A.path=t,this.A.Z=s;const o=Object.assign({},this.history.state,{W:this.A,M:this.D});return this.history.replaceState(o,null,`${e}${n}${h}`)}ot(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get lt(){return this.D?this.D.slice(0,this.A.index+1).map(value=>value.title):[]}k(){return this.location.hash.substring(1).split("?")[0]}async ht(t,s=0){if(this.A&&this.A.path===t&&!this.L)return;const{pathname:i,search:h}=this.location,e=`#${t}`;return s?(this.it=this.A,await this.history.replaceState({},null,`${i}${h}${e}`)):await this.history.pushState({},null,`${i}${h}${e}`),this.j()}H(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}u(t,s,i){const h=Object.assign({},t,s);h.ct=i,kernel.Reporter.write(1e4,"callback",t,s),this.options.u&&this.options.u(h)}}class n{constructor(){this.o=0,this.at=(t=>{const s=n.ut(t);s.ft&&(t.preventDefault(),this.options.u(s))}),this.document=document}static ut(t){const s={ft:0,href:null,anchor:null},i=n.pt(t.target);if(!i||!n.dt(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const h=i.getAttribute("href");return s.anchor=i,s.href=h,s.ft=1===t.which,s}static pt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static dt(t){const s=t.getAttribute("target");return!s||s===n.window.name||"_self"===s}g(t){if(this.o)throw kernel.Reporter.error(2004);this.o=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.at,1)}C(){this.document.removeEventListener("click",this.at,1),this.o=0}}class r{constructor(component,t,s,i){this.wt(component),t&&this.vt(t),s&&this.gt(s),this.scope=!!i}wt(component){"string"==typeof component?(this.yt=component,this.component=null):(this.component=component,this.yt=component.description.name)}vt(t){"string"==typeof t?(this.bt=t,this.viewport=null):(this.viewport=t,t&&(this.bt=t.name))}gt(t){"string"==typeof t?(this.$t=t,this.t={id:t}):this.t=t}Ct(t){if(null!==this.component)return this.component;const s=t.get(kernel.IContainer),i=s.Et(runtime.CustomElementResource.Ot(this.yt));return null!==i?i.Pt(s).St:null}Rt(router){return null!==this.viewport?this.viewport:router.Vt()[this.bt]}jt(t,s=0,i=0){return s&&this.$t!==t.$t?0:i?this.component===t.component:this.yt===t.yt}}class o{constructor(t,s){this.active="",this.kt=t,Object.assign(this,{title:s.title,children:null,Ht:s.Ht,active:""}),this.instructions=this.It(s.At),this.link=this.Nt(this.instructions),this.xt=s.Tt?this.Nt(this.It(s.Tt)):this.link,this.qt=this.kt.router.Ut.get(runtime.IObserverLocator),this._t=this.qt.Dt(0,this.kt.router,"activeComponents"),this._t.subscribe(this)}get Lt(){return this.children&&this.children.length?"nav-has-children":""}zt(){this.active=this.link&&this.link.length?this.Ft():"nav-active"===this.active?"nav-active":this.Jt()?"nav-active-child":""}Ft(){const t=this.kt.router.Mt.Gt(this.xt),s=this.kt.router.Bt.map(t=>this.kt.router.Mt.Qt(t));for(const component of t)if(!s.find(t=>t.jt(component)))return"";return"nav-active"}Wt(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}Nt(instructions){return this.kt.router.Mt.Kt(instructions)}It(t){if(!Array.isArray(t))return this.It([t]);const instructions=[];for(const s of t)instructions.push("string"==typeof s?this.kt.router.Mt.Qt(s):s instanceof r?s:s.component?new r(s.component,s.viewport,s.t):new r(s));return instructions}Jt(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.Jt())return 1;return 0}}class l{constructor(router,name){this.router=router,this.name=name,this.Xt=[]}Yt(t){for(const s of t)this.Zt(this.Xt,s)}Zt(t,s){const i=new o(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.Zt(i.children,t)}}}class c{constructor(t,s){this.at=t,this.names=s}}class a{constructor(t,s){this.ts=t,this.ss=s}}class u{constructor(){this.hs=0,this.es=0,this.ns=0}}class f{constructor(t,s,i){this.at=t,this.rs=s,this.os=i}}class p{constructor(t,s,i){this.ls=t,this.cs=s,this.repeat=i}as(t){return this.cs===t.cs&&this.ls===t.ls}}class State{constructor(t){this.us=t,this.fs=[]}put(t){let s=this.fs.find(s=>s.us.as(t));return void 0===s&&(s=new State(t),this.fs.push(s),t.repeat&&s.fs.push(s)),s}}const d=/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g;class w{constructor(t,s){this.name=t,this.ps=t,this.ds=s,this.optional=0}ws(t){const s=this.ps,i=s.length;let h=0,e="";if(this.ds)for(;i>h;++h)e=s.charAt(h),t(new p(null,e,0));else for(;i>h;++h)e=s.charAt(h),t(new p(null,e.toUpperCase()+e.toLowerCase(),0))}vs(){return this.ps.replace(d,"\\$1")}gs(t,s){return this.ps}}class v{constructor(name,optional){this.name=name,this.optional=optional}ws(t){t(new p("/",null,1))}vs(){return"([^/]+)"}gs(t,s){return s[this.name]=1,t[this.name]}}class g{constructor(name){this.name=name,this.optional=0}ws(t){t(new p("",null,1))}vs(){return"(.+)"}gs(t,s){return s[this.name]=1,t[this.name]}}class m{ws(t){}vs(){return""}gs(t,s){return""}}class y{g(t){this.ms=Object.assign({viewport:"@",ys:"+",scope:"/",bs:"!",t:"=",add:"+",clear:"-",action:"."},t.ms)}get $s(){return this.ms.clear}Qt(t){let component,s,i,h;const[e,n]=t.split(this.ms.viewport);return void 0===n?([component,...i]=e.split(this.ms.t),component.endsWith(this.ms.bs)&&(h=1,component=component.slice(0,component.length-1))):(component=e,[s,...i]=n.split(this.ms.t),s.endsWith(this.ms.bs)&&(h=1,s=s.slice(0,s.length-1))),i=i.length?i.join(this.ms.t):void 0,new r(component,s,i,h)}Cs(t,s=0){if("string"==typeof t)return this.Cs(this.Qt(t),s);{let i=t.yt;return t.bt&&!s&&(i+=this.ms.viewport+t.bt),t.$t&&(i+=this.ms.t+t.$t),i}}Es(t){return t.split(this.ms.scope).map(t=>this.Qt(t))}Os(instructions){return Array.isArray(instructions)?instructions.map(t=>this.Cs(t)).join(this.ms.scope):this.Os([instructions])}Ss(t,s){return t&&(s=`/${t}${this.ms.scope}${s}`),s}Ps(t){return{Rs:t===this.ms.clear||t.startsWith(this.ms.clear+this.ms.add),Vs:t.startsWith(this.ms.clear)?t.substring(1):t}}js(t){const s={};t.startsWith("/")&&(t=t.substring(1));const i=t.split(this.ms.ys);let h=0;for(;i.length;){const t=i.shift().split(this.ms.scope),parts=t.pop().split(this.ms.viewport),component=parts[0];t.push(parts.length?parts.join(this.ms.viewport):`?${h++}`);const name=t.join(this.ms.scope);component&&(s[name]=component)}return s}Kt(instructions){const t=[];for(const s of instructions)t.push(this.Cs(s));return t.join(this.ms.ys)}Gt(t){const instructions=[],s=t.split(this.ms.ys);for(const t of s)instructions.push(this.Qt(t));return instructions}ks(t){let s=t.slice().sort((t,s)=>s.split(this.ms.scope).length-t.split(this.ms.scope).length),i=[];if((s=s.map(value=>`${this.ms.scope}${value}${this.ms.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.ms.scope).length-s.split(this.ms.scope).length),i}Hs(t,s=0){const i=t.slice();return s&&i.unshift(this.$s),i.join(this.ms.ys)}}class b{constructor(){this.Is=(t=>t),this.As=(instructions=>instructions)}}var $;(function(t){t[t.Ns=0]="none",t[t.loaded=1]="loaded",t[t.xs=2]="initialized",t[t.Ts=3]="entered",t[t.qs=4]="added"})($||($={}));class C{constructor(t=null,s=null,i=null,h=null){this.content=t,this.t=s,this.Us=i,this.component=null,this._s=0,this.Ds=0,null!==this.content&&"string"==typeof this.content&&null!==h&&(this.content=this.Ct(h))}Ls(t){return"string"==typeof t.content&&this.yt()!==t.content||"string"!=typeof t.content&&this.content!==t.content||this.t!==t.t||!this.Us||this.Us.tt!==t.Us.tt}zs(t){return("string"==typeof t.content&&this.yt()===t.content||"string"!=typeof t.content&&this.content===t.content)&&this.t===t.t}loadComponent(t,s){return this.Ds||(this.component=this.Fs(t),this.component.Js(0,t,s)),this._s=1,Promise.resolve()}Gs(){1===this._s&&(this._s=0)}Ms(){this.Ds||this.component.Bs(2560,null),this._s=2}Qs(t=0){2===this._s&&(t||(this.component.Ws(5120),this._s=1))}addComponent(t){if(this.component.Ks(512),this.Ds){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)if(t.hasAttribute("au-element-scroll")){const[s,i]=t.getAttribute("au-element-scroll").split(",");t.removeAttribute("au-element-scroll"),t.scrollTo(+i,+s)}}this._s=4}Xs(t,s=0){if(4===this._s){if(s){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)(t.scrollTop>0||t.scrollLeft)&&t.setAttribute("au-element-scroll",`${t.scrollTop},${t.scrollLeft}`)}this.component.Ys(1024),this._s=4}}async Zs(t,s=0){switch(this._s){case 4:this.Xs(t,s);case 3:this.component.ti&&await this.component.ti(),this._s=2;case 2:this.Qs(s);case 1:this.Gs()}this._s=0}yt(){return null===this.content?null:"string"==typeof this.content?this.content:this.content.description.name}Ct(t){if(null===this.content)return null;if("string"!=typeof this.content)return this.content;{const s=t.get(kernel.IContainer),i=s.Et(runtime.CustomElementResource.Ot(this.content));return null!==i?i.Pt(s).St:null}}Fs(t){if(null===this.content)return null;const component=this.yt();return t.get(kernel.IContainer).get("string"!=typeof component?component:runtime.CustomElementResource.Ot(component))}}class E{constructor(router,name,t,s,i,h,e){this.router=router,this.name=name,this.si=t,this.context=s,this.ii=i,this.scope=h,this.options=e,this.clear=0,this.content=new C,this.hi=null,this.ei=null,this.ni=null,this.cache=[],this.enabled=1}ri(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.Mt.$s)this.clear=1,t=null;else{const s=this.router.Mt.Qt(t);t=s.yt,i=s.$t}if(this.hi=new C(t,i,s,this.context),this.options.oi){const t=this.cache.find(t=>this.hi.zs(t));t?(this.hi=t,this.hi.Ds=1):this.cache.push(this.hi)}return this.content.Ls(this.hi)||s.F}li(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.si&&(this.scope.si=t),this.si!==t&&(this.ni=Object.assign({},this),this.ci(),this.si=t,i&&i.ai&&(this.options.ai=i.ai),i&&i.default&&(this.options.default=i.default),i&&i.ui&&(this.options.ui=i.ui),i&&i.fi&&(this.options.fi=i.fi),i&&i.oi&&(this.options.oi=i.oi),this.ei&&this.ei()),this.context!==s&&(this.context=s),this.content.component||this.hi&&this.hi.component||!this.options.default||this.router.pi(this.options.default,this)}remove(t,s){return this.si===t&&this.context===s?(this.content.component&&this.content.Zs(this.si,this.options.oi).catch(t=>{throw t}),1):0}async di(){if(!this.content.component)return 1;const component=this.content.component;return component.di?(kernel.Reporter.write(1e4,"viewport canLeave",component.di(this.content.Us,this.hi.Us)),component.di(this.content.Us,this.hi.Us)):1}async wi(){if(this.clear)return 1;if(!this.hi.content)return 0;if(await this.vi(),await this.hi.loadComponent(this.context,this.si),!this.hi.component)return 0;const component=this.hi.component;if(!component.wi)return 1;const t=component.wi(this.hi.Us,this.content.Us);return kernel.Reporter.write(1e4,"viewport canEnter",t),"boolean"==typeof t?t:"string"==typeof t?[new r(t,this)]:t}async gi(){if(kernel.Reporter.write(1e4,"Viewport enter",this.name),this.clear)return 1;if(!this.hi.component)return 0;if(this.hi.component.gi){const t=(function(t,i,h){const e=s(i),n=s(t),r=Object.assign({},e.t,n.t),o=[...e.list,...n.list];if(o.length&&h&&h.length)for(const t of h)r[t]=o.shift();let l;return o.length&&Object.keys(r).length&&(r["mi"]=o.splice(0,o.length)),{yi:r,bi:o,$i:l=o.length?o:r}})(this.hi.t,this.hi.Us.tt,this.hi.content.t);this.hi.Us.t=t.yi,this.hi.Us.bi=t.bi,await this.hi.component.gi(t.$i,this.hi.Us,this.content.Us),this.hi._s=3}return this.hi.Ms(),1}async Ci(){return kernel.Reporter.write(1e4,"Viewport loadContent",this.name),this.content.component&&(this.content.component.ti&&await this.content.component.ti(this.content.Us,this.hi.Us),this.hi.component||(this.content.Xs(this.si,this.options.oi),this.content.Qs(this.options.oi),this.content.Gs())),this.hi.component&&(this.content.component&&(this.content.Xs(this.si,this.options.oi),this.content.Qs(this.options.oi),this.content.Gs()),this.hi.addComponent(this.si),this.content=this.hi),this.clear&&(this.content=new C(null,null,this.hi.Us)),this.hi=null,1}Ei(){this.ni=null}async Oi(){await this.hi.Zs(this.si,this.options.oi),this.ni&&Object.assign(this,this.ni)}description(t=0){if(this.content.content){const component=this.content.yt();if(t||this.scope||this.options.Si)return this.router.Mt.Cs(new r(component,this,this.content.t,null!==this.scope));const s={};s[component]=component;const i=this.ii.Pi(s);return this.router.Mt.Cs(new r(component,i?null:this,this.content.t))}}Ri(t=0){const s=[this.ii.Vi(t),this.description(t)];return this.router.Mt.Os(s.filter(value=>value&&value.length))}ji(component){let t=this.options.ai||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}ki(component){if("-"===component||null===component)return 1;let t=this.options.ai;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}Hi(t){this.content.component&&this.content.Ms()}Ii(t){kernel.Reporter.write(1e4,"ATTACHING viewport",this.name,this.content,this.hi),this.enabled=1,this.content.component&&this.content.addComponent(this.si)}Ai(t){kernel.Reporter.write(1e4,"DETACHING viewport",this.name),this.content.component&&this.content.Xs(this.si,this.options.oi),this.enabled=0}Ni(t){this.content.component&&this.content.Qs(this.options.oi)}ci(){this.options={},this.content=new C,this.cache=[]}async vi(){return this.si?Promise.resolve():new Promise(t=>{this.ei=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.si=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.xi=[],this.Ti={},this.qi=null,this.parent&&this.parent.Ui(this)}_i(){return this.xi.filter(t=>t.enabled).reduce((t,s)=>(t[s.name]=s,t),{})}Pi(t){const instructions=[];let s=0;t&&(this.qi={},this.Ti={}),this.qi=Object.assign({},this._i(),this.qi);for(const s in t){const parts=this.router.Mt.Es(s),t=this.router.Mt.Cs(parts.shift());this.Ti[t]||(this.Ti[t]=[]),this.Ti[t].push(parts)}for(const i in this.Ti){const h=this.router.Mt.Qt(i);for(const name in this.qi){const e=this.qi[name];if(e&&e.ji(h.yt)){const n=this.Di(t,this.Ti,h,e);instructions.push(...n.Li),s=s||n.zi,this.qi[name]=null,Reflect.deleteProperty(this.Ti,i);break}}}for(const i in this.Ti){const h=this.router.Mt.Qt(i),name=h.bt;if(!name||!name.length||name.startsWith("?"))continue;const e=h.scope;this._i()[name]||(this.Fi(name,null,null,{scope:e,Si:1}),this.qi[name]=this._i()[name]);const n=this.qi[name];if(n&&n.ki(h.yt)){const e=this.Di(t,this.Ti,h,n);instructions.push(...e.Li),s=s||e.zi,this.qi[name]=null,Reflect.deleteProperty(this.Ti,i)}}for(const i in this.Ti){const h=this.router.Mt.Qt(i),e=[];for(const name in this.qi){const t=this.qi[name];t&&t.ki(h.yt)&&e.push(t)}if(1===e.length){const n=e.shift(),r=this.Di(t,this.Ti,h,n);instructions.push(...r.Li),s=s||r.zi,this.qi[n.name]=null,Reflect.deleteProperty(this.Ti,i);break}}if(s=s||Object.keys(this.Ti).length>0,!t)for(const t of this.children){const i=t.Pi();instructions.push(...i.Li),s=s||i.zi}return{Li:instructions,zi:s}}Di(t,s,i,h){const e=this.router.Mt.Cs(i);i.vt(h);const instructions=[i];let n=0;if(s[e].length){const i=h.scope||h.ii;for(const h of s[e])if(h.length){const s={};s[this.router.Mt.Os(h)]=t[this.router.Mt.Os([e,...h])];const r=i.Pi(s);instructions.push(...r.Li),n=n||r.zi}}return{Li:instructions,zi:n}}Fi(name,t,s,i){let h=this._i()[name];if(t&&h&&null!==h.si&&h.si!==t&&(h.enabled=0,(h=this.xi.find(s=>s.name===name&&s.si===t))&&(h.enabled=1)),!h){let e;i.scope&&(e=new Scope(this.router,t,s,this),this.router.Ji.push(e)),h=new E(this.router,name,null,null,this,e,i),this.xi.push(h)}return(t||s)&&h.li(t,s,i),h}Gi(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.Mi(t.scope),this.xi.splice(this.xi.indexOf(t),1)),Object.keys(this.xi).length}Mi(){for(const t of this.children)t.Mi();const t=this._i();for(const name in t)this.router.Gi(t[name],null,null)}Bi(t){return t.wi().then(()=>t.Ci())}Ui(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Qi(t=0,s=0){const i=[];for(const h in this._i()){const e=this._i()[h];(e.options.fi||e.options.ui&&!t)&&!s||i.push(e.Ri(t))}for(const s of this.children)i.push(...s.Qi(t));return i.filter(value=>value&&value.length)}Vt(){const t=this.xi.filter(t=>t.enabled);for(const s of this.children)t.push(...s.Vt());return t}Vi(t=0){if(!this.si||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.Wi(this.context.get(kernel.IContainer).parent);for(;i&&i.ii===this.parent;)s.unshift(i.description(t)),i=this.Wi(i.context.get(kernel.IContainer).parent);return s.unshift(this.parent.Vi(t)),this.router.Mt.Os(s.filter(value=>value&&value.length))}Wi(t){const s=Object.values(this._i());for(;t;){const i=s.find(s=>s.context.get(kernel.IContainer)===t);if(i)return i;t=t.parent}return null}}const O=kernel.DI.Xi("IRouteTransformer").Ki(t=>t.singleton(b));class S{constructor(t,s){this.Ut=t,this.Ji=[],this.Yi={},this.Bt=[],this.Zi=[],this.o=0,this.th=[],this.sh=null,this.ih=null,this.hh=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.eh(t.anchor).Vi();s=this.Mt.Ss(i,s)}this.nh.ot(s)}),this.nh=new e,this.rh=new n,this.Mt=new y,this.oh=s}get lh(){return null!==this.sh}g(t){if(this.o)throw kernel.Reporter.error(2001);return this.o=1,this.options=Object.assign({u:t=>{this.ah(t)},Is:this.oh.Is,As:this.oh.As},t),this.Mt.g({ms:this.options.ms}),this.rh.g({u:this.hh}),this.nh.g(this.options).catch(t=>{throw t})}C(){if(!this.o)throw kernel.Reporter.error(2e3);this.rh.C(),this.nh.C()}ah(t){this.th.push(t),this.uh().catch(t=>{throw t})}async uh(){if(null!==this.sh||!this.th.length)return Promise.resolve();const t=this.th.shift();this.sh=t,this.options.fh&&this.options.fh(t);let i=0;(t.X||t.K)&&t.Z&&(t.path=t.Z,i=1);let h=t.path;if(this.options.Is&&!i){const t=this.options.Is(h,this);h=Array.isArray(t)?this.Mt.Kt(t):t}const{Rs:e,Vs:n}=this.Mt.Ps(h);e&&(h=n);const r=s(t.tt);t.t=r.t,t.bi=r.list;const o=this.Mt.js(h);if(!o&&!Object.keys(o).length&&!e)return this.sh=null,this.uh();const l=e?this.Vt().filter(value=>null!==value.content.component):[],c=this.Vt().filter(value=>value.options.default&&null===value.content.component),a=[];let{Li:u,zi:f}=this.ph.Pi(o),p=100;for(;u.length||f||c.length;){if(!p--)throw kernel.Reporter.error(2002);const s=[];for(const i of u){const h=i.viewport,e=this.Mt.Cs(i,1);h.ri(e,t)&&s.push(h);const n=l.findIndex(value=>value===h);0>n||l.splice(n,1);const r=c.findIndex(value=>value===h);0>r||c.splice(r,1)}for(const i of l)i.ri(this.Mt.$s,t)&&s.push(i);let i;for(;i=c.shift();)i.ri(i.options.default,t)&&s.push(i);let h=await Promise.all(s.map(value=>value.di()));if(h.findIndex(value=>0==value)>=0)return this.dh([...s,...a],t);if((h=await Promise.all(s.map(async value=>{const t=await value.wi();if("boolean"==typeof t)return t?value.gi():0;for(const s of t)this.pi(s.component,s.viewport);return value.Oi().catch(t=>{throw t}),1}))).some(t=>0==t))return this.dh([...s,...a],t);for(const t of s)a.find(value=>value===t)||a.push(t);const e=this.ph.Pi();let n;for(u=[];n=this.Zi.shift();)e.Li.find(value=>value.viewport===n.viewport)||u.push(n);u=[...u,...e.Li],f=e.zi}await Promise.all(a.map(value=>value.Ci())),await this.wh(t),t.Y||t.vh||!a.every(t=>t.options.fi)||await this.nh.pop(),a.forEach(t=>{t.Ei()}),this.ih=this.sh,this.ih.vh&&(this.ih.vh=0),this.sh=null,this.uh().catch(t=>{throw t})}pi(component,t){this.sh?("string"==typeof t&&(t=this.Vt().find(s=>s.name===t)),this.Zi.push(new r(component,t))):this.ih&&(this.th.unshift({path:"",Z:"",vh:1}),this.uh().catch(t=>{throw t}))}gh(t){return this.mh(),this.eh(t)}Fi(name,t,s,i){return kernel.Reporter.write(1e4,"Viewport added",name,t),this.gh(t).Fi(name,t,s,i)}Gi(t,s,i){const h=t.ii;h.Gi(t,s,i)||this.Mi(h)}Vt(){return this.mh(),this.ph.Vt()}Mi(t){if(t!==this.ph){t.Mi();const s=this.Ji.indexOf(t);0>s||this.Ji.splice(s,1)}}et(t,s,i){if("string"==typeof t)return this.nh.et(t,s,i)}replace(t,s,i){if("string"==typeof t)return this.nh.replace(t,s,i)}refresh(){return this.nh.refresh()}back(){return this.nh.back()}forward(){return this.nh.forward()}yh(name,t){const s=this.bh(name);s&&(s.Xt=[]),this.$h(name,t)}$h(name,t){let s=this.Yi[name];s||(s=this.Yi[name]=new l(this,name)),s.Yt(t)}bh(name){return this.Yi[name]}async dh(t,s){t.forEach(t=>{t.Oi().catch(t=>{throw t})}),s.T?await this.nh.pop():await this.nh.cancel(),this.sh=null,this.uh().catch(t=>{throw t})}mh(){if(!this.ph){const t=this.Ut.get(runtime.Aurelia).root();this.ph=new Scope(this,t.Ch,t.$context,null),this.Ji.push(this.ph)}}eh(t){let s=(function(t){for(;t&&!t.$customElement;)t=t.parentElement;return t})(t).$customElement.$context.get(kernel.IContainer);for(;s;){const t=this.Ji.find(t=>t.context.get(kernel.IContainer)===s);if(t)return t;s=s.parent}}wh(t){this.Bt=this.ph.Qi(1,1),this.Bt=this.Mt.ks(this.Bt);let s=this.ph.Qi();s=this.Mt.ks(s);let i=this.Mt.Hs(s);if(this.options.As){const t=this.options.As(this.Mt.Gt(i),this);i=Array.isArray(t)?this.Mt.Kt(t):t}let h=this.ph.Qi(1);h=this.Mt.ks(h);const e=t.tt&&t.tt.length?`?${t.tt}`:"";return this.nh.rt(i+e,this.Mt.Hs(h,1)+e,t)}}S.inject=[kernel.IContainer,O];class P{constructor(router,t,s){this.router=router,this.si=t,this.Eh=s,this.name="default",this.scope=null,this.ai=null,this.default=null,this.ui=null,this.fi=null,this.oi=null,this.viewport=null}Oh(t,host,parts,s){const i=this.constructor,dom=s.get(runtime.IDOM),template=this.Eh.Sh(dom,i.description,s,i);template.Ph=runtime.createRenderContext(dom,s,i.description.dependencies,i),template.Oh(this,host,parts)}bound(){this.connect()}Rh(){this.disconnect()}connect(){const t={scope:this.si.hasAttribute("scope")};this.ai&&this.ai.length&&(t.ai=this.ai),this.default&&this.default.length&&(t.default=this.default),this.si.hasAttribute("no-link")&&(t.ui=1),this.si.hasAttribute("no-history")&&(t.fi=1),this.si.hasAttribute("stateful")&&(t.oi=1),this.viewport=this.router.Fi(this.name,this.si,this.$context,t)}disconnect(){this.router.Gi(this.viewport,this.si,this.$context)}Hi(t){this.viewport&&this.viewport.Hi(t)}Ii(t){this.viewport&&this.viewport.Ii(t)}Ai(t){this.viewport&&this.viewport.Ai(t)}Ni(t){this.viewport&&this.viewport.Ni(t)}}P.inject=[S,runtime.INode,runtime.IRenderingEngine],i([runtime.bindable],P.prototype,"name",void 0),i([runtime.bindable],P.prototype,"scope",void 0),i([runtime.bindable],P.prototype,"usedBy",void 0),i([runtime.bindable],P.prototype,"default",void 0),i([runtime.bindable],P.prototype,"noLink",void 0),i([runtime.bindable],P.prototype,"noHistory",void 0),i([runtime.bindable],P.prototype,"stateful",void 0),runtime.CustomElementResource.Vh({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},P),t.jh=class{constructor(router){this.router=router,this.name=null,this.Xt=null,this.level=0}get kh(){const t=this.router.bh(this.name);return t?t.Xt:[]}active(t){return"Active"}},i([runtime.bindable],t.jh.prototype,"name",void 0),i([runtime.bindable],t.jh.prototype,"routes",void 0),i([runtime.bindable],t.jh.prototype,"level",void 0),t.jh=i([kernel.inject(S,Element),runtime.customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],t.jh),t.Hh=e,t.Ih=n,t.Ah=l,t.Nh=h,t.xh=c,t.Th=a,t.qh=u,t.Uh=f,t._h=p,t.State=State,t.Dh=w,t.Lh=v,t.zh=g,t.Fh=m,t.Jh=class{constructor(){this.Gh=new State,this.names={},this.Xt=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.Gh;const i=[];let h="^";const e=new u,n=[],r=t.at.name;let o=1,l=t.path;"/"===l.charAt(0)&&(l=l.slice(1));const f=[],d=l.split("/");let y,b;for(let r=0,l=d.length;l>r;++r){let l=(y=d[r]).match(/^:([^?]+)(\?)?$/);if(l){const[,name,optional]=l;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);f.push(b=new v(name,!!optional)),n.push(name),e.es++}else if(l=y.match(/^\*(.+)$/))f.push(b=new g(l[1])),n.push(l[1]),e.ns++;else{if(""===y){f.push(new m);continue}f.push(b=new w(y,t.ds)),e.hs++}const c=s.put(new p(null,"/",0));let a=c;b.ws(t=>{a=a.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].fs.push(c);b.optional?(i.push(a),h+=`(?:/${b.vs()})?`):(s=a,h+=`/${b.vs()}`,i.length=0,o=0)}o&&(s=s.put(new p(null,"/",0)),h+="/?");const $=[new c(t.at,n)];if(this.Xt.set(t.at,new a(f,$)),r){const t=Array.isArray(r)?r:[r];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new a(f,$))}for(let s=0;i.length>s;s++){const n=i[s];n.ss=$,n.vs=RegExp(`${h}$`,t.ds?"":"i"),n.types=e}return s.ss=$,s.vs=RegExp(`${h}$`,t.ds?"":"i"),s.types=e,s}Mh(t){return"string"==typeof t?this.names[t]:this.Xt.get(t)}Bh(t){const s=this.Mh(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.ss]}Qh(t){return!!this.Mh(t)}gs(t,s){const i=this.Mh(t);if(!i)throw Error(`There is no route named ${t}`);const h=i.ss[0].at;if(h.Wh)return h.href;const e=Object.assign({},s),n=i.ts,r={};let o="";for(let s=0,i=n.length;i>s;s++){const i=n[s];if(i instanceof m)continue;const h=i.gs(e,r);if(null==h){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else o+="/",o+=h}"/"!==o.charAt(0)&&(o=`/${o}`);for(const t in r)Reflect.deleteProperty(e,t);const l=kernel.buildQueryString(e);return o+(l?`?${l}`:"")}Kh(t){let s=[this.Gh],i={},h=0,e=t;const n=e.indexOf("?");if(-1!==n){const t=e.slice(n+1);e=e.slice(0,n),i=kernel.parseQueryString(t)}"/"!==(e=decodeURI(e)).charAt(0)&&(e=`/${e}`);let r=e.length;r>1&&"/"===e.charAt(r-1)&&(e=e.slice(0,-1),h=1,--r);for(let t=0;r>t;++t){const i=[],h=e.charAt(t);if(s.forEach(t=>{t.fs.forEach(t=>{null!==t.us.cs?-1!==t.us.cs.indexOf(h)&&i.push(t):null!==t.us.ls&&-1===t.us.ls.indexOf(h)&&i.push(t)})}),0===(s=i).length)break}const o=[];for(let t=0,i=s.length;i>t;t++)s[t].ss&&o.push(s[t]);o.sort((t,s)=>{if(t.types.ns!==s.types.ns)return t.types.ns-s.types.ns;if(t.types.ns){if(t.types.hs!==s.types.hs)return s.types.hs-t.types.hs;if(t.types.es!==s.types.es)return s.types.es-t.types.es}return t.types.es!==s.types.es?t.types.es-s.types.es:t.types.hs!==s.types.hs?s.types.hs-t.types.hs:0});const l=o[0];if(l&&l.ss){h&&"(.+)$"===l.vs.source.slice(-5)&&(e=`${e}/`);const t=e.match(l.vs);let s=1;const n=[];return n.Xh=i,l.ss.forEach(i=>{const h={};i.names.forEach(name=>{h[name]=t[s++]}),n.push(new f(i.at,h,i.names.length>0))}),n}}},t.Yh=O,t.Zh=S,t.Scope=Scope,t.te=E,t.se=P,Object.defineProperty(t,"ie",{value:1})});
