(function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("@aurelia/runtime"),require("@aurelia/kernel")):"function"==typeof define&&define.t?define(["exports","@aurelia/runtime","@aurelia/kernel"],s):s((t=t||self).router={},t.runtime,t.kernel)})(this,function(t,runtime,kernel){"use strict";function s(t){const s={},i=[];if(!t||!t.length)return{s,list:i};const h=t.replace("+"," ").split("&");for(const t of h){const h=t.split("="),e=decodeURIComponent(h.shift());if(!h.length){i.push(e);continue}const value=decodeURIComponent(h.shift());s[e]=value}return{s,list:i}}function i(t,s,i,h){var e,n,o=arguments.length,r=3>o?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.i)r=Reflect.i(t,s,i,h);else for(n=t.length-1;n>=0;n--)(e=t[n])&&(r=(3>o?e(r):o>3?e(s,i,r):e(s,i))||r);return o>3&&r&&Object.defineProperty(s,i,r),r}class h{constructor(){this.h=null,this.o=0,this.l=0,this.u=0,this.p=0,this.m=(()=>{const t=this.v(),s=this.$(),i={};let h=this.P("HistoryEntry");if(this.h&&this.h.path===t){i.O=1;const t=this.u?this.j.index:this.history.length-this.k;this.j=this.h,this.j.index=t,this.u?(this.S=0,this.V[this.j.index]=this.j,this.l?(i.H=1,this.l=0):this.p?(i.C=1,this.p=0):i.N=1,this.u=0):(this.S=1,this.V=this.V.slice(0,this.j.index),this.V.push(this.j)),this.A({_:this.V,J:this.k,q:this.j})}else this.V=this.V||this.P("HistoryEntries")||[],this.k=this.k||this.P("HistoryOffset")||0,h||this.j?h?this.j?h.index>this.j.index?i.D=1:this.j.index>h.index&&(i.I=1):i.C=1:i.O=1:(i.O=1,i.L=1,this.k=this.history.length),h||(this.V=this.V.slice(0,(h={path:t,T:null,index:this.history.length-this.k,U:s}).index),this.V.push(h),this.A({_:this.V,J:this.k,q:h})),this.S=this.j?h.index-this.j.index:0,this.j=h,this.l&&(i.H=1,this.l=0);this.h=null,this.g&&this.g--,this.G(this.j,i)}),this.location=window.location,this.history=window.history}K(t){if(this.o)throw Error("History has already been activated.");return this.o=1,this.options=Object.assign({},t),window.addEventListener("popstate",this.m),Promise.resolve().then(()=>{this.X(this.v(),1)})}Y(){window.removeEventListener("popstate",this.m),this.o=0}Z(t,s,i){this.h={path:t,T:null,title:s,data:i},this.X(t)}replace(t,s,i){this.u=1,this.h={path:t,T:null,title:s,data:i},this.X(t,1)}B(t,s,i){this.g=this.S+1,this.replace(t,s,i)}refresh(){this.j&&(this.p=1,this.replace(this.j.path,this.j.title,this.j.data))}back(){this.history.go(-1)}forward(){this.history.go(1)}cancel(){this.l=1;const t=this.S||this.g;t?this.history.go(-t):this.replace(this.R.path,this.R.title,this.R.data)}A(t,value){const{pathname:s,search:i,hash:h}=this.location;let e=Object.assign({},this.history.state);"string"==typeof t?e[t]=JSON.parse(JSON.stringify(value)):e=Object.assign({},e,JSON.parse(JSON.stringify(t))),this.history.replaceState(e,null,`${s}${i}${h}`)}P(t){return Object.assign({},this.history.state)[t]}W(t){this.j.title=t,this.V[this.j.index]=this.j,this.A({_:this.V,q:this.j})}M(t,s,i){if(i.index!==this.j.index)return;const h=`#/${t}`,{pathname:e,search:n,hash:o}=this.location;if(h===o)return;this.j.path=t,this.j.T=s;const r=Object.assign({},this.history.state,{q:this.j,_:this.V});this.history.replaceState(r,null,`${e}${n}${h}`)}F(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get tt(){return this.V?this.V.slice(0,this.j.index+1).map(value=>value.title):[]}v(){return this.location.hash.substr(1).split("?")[0]}X(t,s=0){if(this.j&&this.j.path===t&&!this.p)return;const{pathname:i,search:h}=this.location,e=`#${t}`;s?(this.R=this.j,this.history.replaceState({},null,`${i}${h}${e}`)):this.history.pushState({},null,`${i}${h}${e}`),this.m()}$(){const t=this.location.hash.substr(1).split("?");return t.shift(),t.length>0?t.shift():""}G(t,s){const i=Object.assign({},t,s);this.options.G&&this.options.G(i)}}class e{constructor(){this.o=0,this.st=(t=>{const s=e.it(t);s.ht&&(t.preventDefault(),this.options.G(s))}),this.document=document}static it(t){const s={ht:0,href:null,anchor:null},i=e.et(t.target);if(!i||!e.nt(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const h=i.getAttribute("href");return s.anchor=i,s.href=h,s.ht=1===t.which,s}static et(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static nt(t){const s=t.getAttribute("target");return!s||s===e.window.name||"_self"===s}K(t){if(this.o)throw Error("LinkHandler has already been activated.");this.o=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.st,1)}Y(){this.document.removeEventListener("click",this.st),this.o=0}}class n{constructor(t,s){this.active="",this.ot=t,Object.assign(this,{rt:s.rt,title:s.title,lt:s.lt,active:""}),this.link=this.ct(),this.at=this.ot.router.ut.get(runtime.IObserverLocator),this.ft=this.at.dt(this.ot.router,"activeComponents"),this.ft.subscribe(this)}get pt(){return this.children&&this.children.length?"nav-has-children":""}bt(){this.active=this.link&&this.link.length?this.vt():"nav-active"===this.active?"nav-active":this.wt()?"nav-active-child":""}vt(){const t=this.link.split(this.ot.router.$t.add),s=this.ot.router.Pt;for(let component of t)if(0>component.indexOf(this.ot.router.$t.viewport)){if(component+=this.ot.router.$t.viewport,0>s.findIndex(value=>value.startsWith(component)))return""}else if(0>s.indexOf(component))return"";return"nav-active"}Ot(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}ct(){return Array.isArray(this.rt)?this.rt.map(value=>this.jt(value)).join(this.ot.router.$t.kt):this.jt(this.rt)}wt(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.wt())return 1;return 0}jt(component){return component?"string"==typeof component?component:component.description?component.description.name:component.component?this.jt(component.component)+(component.viewport?`@${component.viewport}`:""):void 0:""}}class o{constructor(router,name){this.St=[],this.router=router,this.name=name}Vt(t){for(const s of t)this.Ht(this.St,s)}Ht(t,s){const i=new n(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.Ht(i.children,t)}}}class r{constructor(router,name,t,s,i,h){this.router=router,this.name=name,this.Ct=t,this.Nt=s,this.scope=i,this.options=h,this.clear=0,this.content=null,this.At=null,this.s=null,this._t=null,this.Jt=null,this.qt=null,this.component=null,this.yt=null,this.Dt=null}It(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.$t.clear)this.clear=1,t=null;else{const s=t.split(this.router.$t.s);t=s.shift(),i=s.length?s.join(this.router.$t.s):null;const h=this.router.ut.Lt(runtime.CustomElementResource.Tt(t));null!==h&&(t=h.gt(this.router.ut).Ut)}return this.At=t,this.qt=s,this._t=i,this.content!==t||this.s!==i||!this.Jt||this.Jt.U!==s.U||s.C?1:0}zt(t,s){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.Ct&&(this.scope.Ct=t),this.Ct||(this.Ct=t,s&&s.Gt&&(this.options.Gt=s.Gt),this.Dt&&this.Dt())}Kt(){if(!this.component)return Promise.resolve(1);const component=this.component;if(!component.Kt)return Promise.resolve(1);const t=component.Kt(this.Jt,this.qt);return"boolean"==typeof t?Promise.resolve(t):t}Qt(){if(this.clear)return Promise.resolve(1);if(!this.At)return Promise.resolve(0);if(this.loadComponent(this.At),!this.yt)return Promise.resolve(0);const component=this.yt;if(!component.Qt)return Promise.resolve(1);const t=component.Qt(this.qt,this.Jt);return"boolean"==typeof t?Promise.resolve(t):t}async Xt(){if(this.component&&(this.component.Yt&&await this.component.Yt(this.Jt,this.qt),this.yt||this.Zt(this.component)),this.yt){if(this.yt.Bt){const t=(function(t,i,h){const e=s(i),n=s(t),o=Object.assign({},e.s,n.s),r=[...e.list,...n.list];if(r.length&&h&&h.length)for(const t of h)o[t]=r.shift();let l;return r.length&&Object.keys(o).length&&(o["Rt"]=r.splice(0,r.length)),{s:o,list:r,Wt:l=r.length?r:o}})(this._t,this.qt.U,this.At.s);this.qt.s=t.s,this.qt.Mt=t.list,await this.yt.Bt(t.Wt,this.qt,this.Jt)}if(!this.Ct&&(await this.xt(),!this.Ct))return Promise.resolve(0);this.component&&this.Zt(this.component),this.Et(this.yt),this.content=this.At,this.s=this._t,this.Jt=this.qt,this.component=this.yt}return this.clear&&(this.content=this.s=this.component=null,this.Jt=this.qt),this.At=this._t=this.qt=this.yt=null,Promise.resolve(1)}description(t=0){if(this.content){const component=this.content.description.name,s=this.scope?this.router.$t.Ft:"",i=this.s?this.router.$t.s+this.s:"";if(t||s.length||this.options.ts)return`${component}${this.router.$t.viewport}${this.name}${s}${i}`;const h={};return h[component]=component,this.Nt.ss(h)?`${component}${i}`:`${component}${this.router.$t.viewport}${this.name}${s}${i}`}}hs(t=0){return[this.Nt.context(t),this.description(t)].filter(value=>value&&value.length).join(this.router.$t.scope)}es(component){let t=this.options.Gt||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}ns(component){if("-"===component||null===component)return 1;let t=this.options.Gt;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}os(t){this.component&&this.component.rs(t)}ls(t){this.component&&this.component.cs(t)}as(t){this.component&&this.component.us(t)}fs(t){this.component&&this.component.ds(t)}loadComponent(component){this.yt=this.router.ut.get(runtime.CustomElementResource.Tt(component.description.name))}Et(component){const host=this.Ct,t=this.router.ut,dom=t.get(runtime.IDOM),s=t.get(runtime.IProjectorLocator),i=t.get(runtime.IRenderingEngine);component.ps(dom,s,i,host,null),component.rs(runtime.LifecycleFlags.ms|runtime.LifecycleFlags.bs,null),component.cs(runtime.LifecycleFlags.ms)}Zt(component){component.us(runtime.LifecycleFlags.vs),component.ds(runtime.LifecycleFlags.vs|runtime.LifecycleFlags.ws)}async xt(){return this.Ct?Promise.resolve():new Promise(t=>{this.Dt=t})}}class Scope{constructor(router,t,s){this.children=[],this.$s={},this.Ps={},this.router=router,this.Ct=t,this.parent=s,this.viewport=null,this.children=[],this.$s={},this.Ps={},this.Os=null,this.parent&&this.parent.js(this)}ss(t){const s=[];let i=0;t&&(this.Os={},this.Ps={}),this.Os=Object.assign({},this.$s,this.Os);for(const s in t){const parts=s.split(this.router.$t.scope),t=parts.shift();this.Ps[t]||(this.Ps[t]=[]),this.Ps[t].push(parts)}for(const h in this.Ps){const e=h.split(this.router.$t.s),component=e.shift().split(this.router.$t.viewport).shift(),n=component+(e.length?this.router.$t.s+e.join(this.router.$t.s):"");for(const name in this.Os){const e=this.Os[name];if(e&&e.es(component)){const o=this.ks(t,this.Ps,h,n,e);s.push(...o.Ss),i=i||o.Vs,this.Os[name]=null,delete this.Ps[h];break}}}for(const h in this.Ps){const e=h.split(this.router.$t.s),parts=e.shift().split(this.router.$t.viewport),component=parts.shift(),n=component+(e.length?this.router.$t.s+e.join(this.router.$t.s):"");let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let o=0;name.endsWith(this.router.$t.Ft)&&(o=1,name=name.substr(0,name.length-1)),this.$s[name]||(this.Hs(name,null,{scope:o,ts:1}),this.Os[name]=this.$s[name]);const r=this.Os[name];if(r&&r.ns(component)){const e=this.ks(t,this.Ps,h,n,r);s.push(...e.Ss),i=i||e.Vs,this.Os[name]=null,delete this.Ps[h]}}for(const h in this.Ps){const e=h.split(this.router.$t.s),component=e.shift().split(this.router.$t.viewport).shift(),n=component+(e.length?this.router.$t.s+e.join(this.router.$t.s):""),o=[];for(const name in this.Os){const t=this.Os[name];t&&t.ns(component)&&o.push(t)}if(1===o.length){const e=o.shift(),r=this.ks(t,this.Ps,h,n,e);s.push(...r.Ss),i=i||r.Vs,this.Os[e.name]=null,delete this.Ps[h];break}}if(i=i||Object.keys(this.Ps).length>0,!t)for(const t of this.children){const h=t.ss();s.push(...h.Ss),i=i||h.Vs}return{Ss:s,Vs:i}}ks(t,s,i,component,h){const e=[{component,viewport:h}];let n=0;if(s[i].length){const o=h.scope||h.Nt;for(const h of s[i])if(h.length){const s=h.join(this.router.$t.scope),r={};r[s]=t[i+this.router.$t.scope+s];const l=o.ss(r);e.push(...l.Ss),n=n||l.Vs}}return{Ss:e,Vs:n}}Hs(name,t,s){let i=this.$s[name];if(!i){let h;s.scope&&(h=new Scope(this.router,t,this),this.router.Cs.push(h)),i=this.$s[name]=new r(this.router,name,t,this,h,s)}return t&&i.zt(t,s),i}Ns(t){return t.scope&&this.router.As(t.scope),delete this.$s[t.name],Object.keys(this.$s).length}As(){for(const t of this.children)t.As();for(const t in this.$s)this.router.Ns(this.$s[t])}_s(t){return t.Qt().then(()=>t.Xt())}js(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Js(t=0){const s=[];for(const i in this.$s)s.push(this.$s[i].hs(t));for(const i of this.children)s.push(...i.Js(t));return s.filter(value=>value&&value.length)}qs(){const t=[];for(const s in this.$s)t.push(this.$s[s]);for(const s of this.children)t.push(...s.qs());return t}context(t=0){if(!this.Ct||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.ys(this.Ct.parentElement);for(;i&&i.Nt===this.parent;)s.unshift(i.description(t)),i=this.ys(i.Ct.parentElement);return s.unshift(this.parent.context(t)),s.filter(value=>value&&value.length).join(this.router.$t.scope)}Ds(component){if("string"==typeof component){const t=this.router.ut.Lt(runtime.CustomElementResource.Tt(component));null!==t&&(component=t.gt(this.router.ut).Ut)}return component}ys(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h in this.$s){const e=this.$s[h].Ct;let n=t,o=0;for(;n&&n!==e;)o++,n=n.parentElement;i>o&&(i=o,s=this.$s[h])}return s}}class l{constructor(t){this.ut=t,this.St=[],this.$s={},this.Cs=[],this.Is={},this.Pt=[],this.o=0,this.Ls=0,this.Ts=[],this.Us=null,this.gs=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substr(1)),!s.startsWith("/")){const i=this.zs(t.anchor).context();i&&(s=`/${i}${this.$t.scope}${s}`)}this.Gs.F(s)}),this.Gs=new h,this.Ks=new e}K(t){if(this.o)throw Error("Router has already been activated.");return this.o=1,this.options=Object.assign({G:t=>{this.Qs(t)}},t),this.$t=Object.assign({viewport:"@",kt:"+",scope:"/",Ft:"!",s:"=",add:"+",clear:"-",action:"."},this.options.$t),this.Ks.K({G:this.gs}),this.Gs.K(this.options).catch(t=>{throw t})}Y(){if(!this.o)throw Error("Router has not been activated.");this.Ks.Y(),this.Gs.Y()}Qs(t){this.Ts.push(t),this.Xs().catch(t=>{throw t})}async Xs(){if(null!==this.Us||!this.Ts.length)return Promise.resolve();const t=this.Ts.shift();if(this.Us=t,this.options.Ys&&this.options.Ys(t),t.H)return this.Us=null,Promise.resolve();let i=0;(t.I||t.D)&&t.T&&(t.path=t.T);const h=t.path;(h===this.$t.clear||h.startsWith(this.$t.clear+this.$t.add))&&(i=1,h.startsWith(this.$t.clear)&&(t.path=h.substr(1)));const e=s(t.U);let n,o;t.s=e.s,t.Mt=e.list;let r=this.Zs(t);if(r){if(r.B)return r=this.Bs(r,t.data),this.Ls=1,this.Gs.B(r.path,r.title,t.data),this.Us=null,Promise.resolve();r.title&&(n=r.title),o=r.$s}else o=this.Rs(t);if(!o&&!Object.keys(o).length&&!i)return this.Us=null,Promise.resolve();n&&this.Gs.W(n);const l=i?this.Ws.qs().filter(value=>null!==value.component):[];let{Ss:c,Vs:a}=this.Ws.ss(o),u=100;for(;(c.length||a)&&u--;){const s=[];for(const i of c){const{component,viewport:h}=i;h.It(component,t)&&s.push(h);const e=l.findIndex(value=>value===h);0>e||l.splice(e,1)}for(const i of l)i.It(this.$t.clear,t)&&s.push(i);!s.length&&this.Ls&&(this.Gs.cancel(),this.Ls=0);let i=await Promise.all(s.map(value=>value.Kt()));if(i.findIndex(value=>0==value)>=0)return this.Gs.cancel(),this.Us=null,Promise.resolve();if((i=await Promise.all(s.map(value=>value.Qt()))).findIndex(value=>0==value)>=0)return this.Gs.cancel(),this.Us=null,Promise.resolve();await Promise.all(s.map(value=>value.Xt()));const h=this.Ws.ss();c=h.Ss,a=h.Vs}this.Ms(t),this.Us=null,this.Ts.length&&this.Xs().catch(t=>{throw t})}Zs(t){return this.St.find(value=>value.path===t.path)}Bs(t,s){for(;t.B;){const i=this.Zs({path:t.B,T:null,data:s});if(!i)break;t=i}return t}Rs(t){const s={};let i=t.path;i.startsWith("/")&&(i=i.substr(1));const h=i.split(this.$t.kt);let e=0;for(;h.length;){const t=h.shift().split(this.$t.scope),parts=t.pop().split(this.$t.viewport),component=parts[0];t.push(parts.length?parts.join(this.$t.viewport):`?${e++}`);const name=t.join(this.$t.scope);component&&(s[name]=component)}return s}xs(t){if(!this.Ws){const t=this.ut.get(runtime.Aurelia).root().Es;this.Ws=new Scope(this,t,null),this.Cs.push(this.Ws)}return this.zs(t)}Hs(name,t,s){return this.xs(t).Hs(name,t,s)}Ns(t){const s=t.Nt;s.Ns(t)||this.As(s)}As(t){if(t!==this.Ws){t.As();const s=this.Cs.indexOf(t);0>s||this.Cs.splice(s,1)}}Ht(t){this.St.push(t)}Z(t,s,i){"string"==typeof t&&this.Gs.Z(t,s,i)}replace(t,s,i){"string"==typeof t&&this.Gs.replace(t,s,i)}refresh(){this.Gs.refresh()}back(){this.Gs.back()}forward(){this.Gs.forward()}Fs(name,t){let s=this.Is[name];s||(s=this.Is[name]=new o(this,name)),s.Vt(t)}ti(name){return this.Is[name]}zs(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h of this.Cs){let e=t,n=0;for(;e&&e!==h.Ct;)n++,e=e.parentElement;i>n&&(i=n,s=h)}return s}si(t){let s=t.slice().sort((t,s)=>s.split(this.$t.scope).length-t.split(this.$t.scope).length),i=[];if((s=s.map(value=>`${this.$t.scope}${value}${this.$t.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.$t.scope).length-s.split(this.$t.scope).length),i}Ms(t){let s=this.Ws.Js();s=this.si(s);let i=this.Ws.Js(1);i=this.si(i),this.Pt=i,i.unshift(this.$t.clear);const h=t.U&&t.U.length?`?${t.U}`:"";this.Gs.M(s.join(this.$t.kt)+h,i.join(this.$t.kt)+h,t)}}l.inject=[kernel.IContainer];class c{constructor(router,t){this.router=router,this.Ct=t,this.name="default",this.scope=null,this.Gt=null,this.viewport=null}ii(){const t={scope:this.Ct.hasAttribute("scope")};this.Gt&&this.Gt.length&&(t.Gt=this.Gt),this.viewport=this.router.Hs(this.name,this.Ct,t)}hi(){this.router.Ns(this.viewport)}os(t){this.viewport&&this.viewport.os(t)}ls(t){this.viewport&&this.viewport.ls(t)}as(t){this.viewport&&this.viewport.as(t)}fs(t){this.viewport&&this.viewport.fs(t)}}c.inject=[l,runtime.INode],i([runtime.bindable],c.prototype,"name",void 0),i([runtime.bindable],c.prototype,"scope",void 0),i([runtime.bindable],c.prototype,"usedBy",void 0),runtime.CustomElementResource.ei({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},c),t.ni=class{constructor(router){this.router=router,this.name=null,this.St=null,this.level=0}get oi(){const t=this.router.ti(this.name);return t?t.St:[]}active(t){return"Active"}},i([runtime.bindable],t.ni.prototype,"name",void 0),i([runtime.bindable],t.ni.prototype,"routes",void 0),i([runtime.bindable],t.ni.prototype,"level",void 0),t.ni=i([kernel.inject(l,Element),runtime.customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],t.ni),t.ri=h,t.li=e,t.ci=o,t.ai=l,t.Scope=Scope,t.ui=r,t.fi=c,Object.defineProperty(t,"di",{value:1})});
