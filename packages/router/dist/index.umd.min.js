(function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("@aurelia/runtime"),require("@aurelia/kernel")):"function"==typeof define&&define.t?define(["exports","@aurelia/runtime","@aurelia/kernel"],s):s((t=t||self).router={},t.runtime,t.kernel)})(this,function(t,runtime,kernel){"use strict";function s(t,s,i,h){var e,o,n=arguments.length,r=3>n?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.s)r=Reflect.s(t,s,i,h);else for(o=t.length-1;o>=0;o--)(e=t[o])&&(r=(3>n?e(r):n>3?e(s,i,r):e(s,i))||r);return n>3&&r&&Object.defineProperty(s,i,r),r}class i{constructor(){this.i=null,this.h=0,this.o=0,this.l=0,this.u=0,this.p=(()=>{const t=this.m(),s={};let i=this.$("HistoryEntry");if(this.i&&this.i.path===t){s.P=1;const t=this.l?this.O.index:this.history.length-this.j;this.O=this.i,this.O.index=t,this.l?(this.v=0,this.S[this.O.index]=this.O,this.o?(s.V=1,this.o=0):this.u?(s.H=1,this.u=0):s.k=1,this.l=0):(this.v=1,this.S=this.S.slice(0,this.O.index),this.S.push(this.O)),this.N({C:this.S,J:this.j,D:this.O})}else this.S=this.S||this.$("HistoryEntries")||[],this.j=this.j||this.$("HistoryOffset")||0,i||this.O?i?this.O?i.index>this.O.index?s._=1:this.O.index>i.index&&(s.q=1):s.H=1:s.P=1:(s.P=1,s.A=1,this.j=this.history.length),i||(this.S=this.S.slice(0,(i={path:t,I:t,index:this.history.length-this.j}).index),this.S.push(i),this.N({C:this.S,J:this.j,D:i})),this.v=this.O?i.index-this.O.index:0,this.O=i,this.o&&(s.V=1,this.o=0);this.i=null,this.L&&this.L--,this.T(this.O,s)}),this.location=window.location,this.history=window.history}W(t){if(this.h)throw Error("History has already been activated.");return this.h=1,this.options=Object.assign({},t),window.addEventListener("popstate",this.p),Promise.resolve().then(()=>{this.G(this.m(),1)})}K(){window.removeEventListener("popstate",this.p),this.h=0}U(t,s,i){this.i={path:t,I:t,title:s,data:i},this.G(t)}replace(t,s,i){this.l=1,this.i={path:t,I:t,title:s,data:i},this.G(t,1)}X(t,s,i){this.L=this.v+1,this.replace(t,s,i)}refresh(){this.O&&(this.u=1,this.replace(this.O.path,this.O.title,this.O.data))}back(){this.history.go(-1)}forward(){this.history.go(1)}cancel(){this.o=1;const t=this.v||this.L;t?this.history.go(-t):this.replace(this.Y.path,this.Y.title,this.Y.data)}N(t,value){const{pathname:s,search:i,hash:h}=this.location;let e=Object.assign({},this.history.state);"string"==typeof t?e[t]=JSON.parse(JSON.stringify(value)):e=Object.assign({},e,JSON.parse(JSON.stringify(t))),this.history.replaceState(e,null,`${s}${i}${h}`)}$(t){return Object.assign({},this.history.state)[t]}Z(t){this.O.title=t,this.S[this.O.index]=this.O,this.N({C:this.S,D:this.O})}B(t,s){const i=`#/${t}`,{pathname:h,search:e,hash:o}=this.location;if(i===o)return;this.O.path=t,this.O.I=s;const n=Object.assign({},this.history.state,{D:this.O,C:this.S});this.history.replaceState(n,null,`${h}${e}${i}`)}M(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get F(){return this.S?this.S.slice(0,this.O.index+1).map(value=>value.title):[]}m(){return this.location.hash.substr(1)}G(t,s=0){if(this.O&&this.O.path===t&&!this.u)return;const{pathname:i,search:h}=this.location,e=`#${t}`;s?(this.Y=this.O,this.history.replaceState({},null,`${i}${h}${e}`)):this.history.pushState({},null,`${i}${h}${e}`),this.p()}T(t,s){const i=Object.assign({},t,s);this.options.T&&this.options.T(i)}}class h{constructor(){this.h=0,this.R=(t=>{const s=h.g(t);s.tt&&(t.preventDefault(),this.options.T(s))}),this.document=document}static g(t){const s={tt:0,href:null,anchor:null},i=h.st(t.target);if(!i||!h.it(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const e=i.getAttribute("href");return s.anchor=i,s.href=e,s.tt=1===t.which,s}static st(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static it(t){const s=t.getAttribute("target");return!s||s===h.window.name||"_self"===s}W(t){if(this.h)throw Error("LinkHandler has already been activated.");this.h=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.R,1)}K(){this.document.removeEventListener("click",this.R),this.h=0}}class e{constructor(router,name,t,s,i,h){this.router=router,this.name=name,this.ht=t,this.et=s,this.scope=i,this.options=h,this.clear=0}ot(t,s){if(this.clear=0,"string"==typeof t)if(t===this.router.nt.clear)this.clear=1,t=null;else{const s=this.router.ct.rt(runtime.CustomElementResource.ft(t));null!==s&&(t=s.at(this.router.ct).lt)}return this.ut=t,this.pt=s,this.content!==t||s.H?1:0}wt(){if(!this.component)return Promise.resolve(1);const component=this.component;if(!component.wt)return Promise.resolve(1);const t=component.wt(this.dt,this.pt);return"boolean"==typeof t?Promise.resolve(t):t}bt(){if(this.clear)return Promise.resolve(1);if(!this.ut)return Promise.resolve(0);if(this.loadComponent(this.ut),!this.$t)return Promise.resolve(0);const component=this.$t;if(!component.bt)return Promise.resolve(1);const t=component.bt(this.pt,this.dt);return"boolean"==typeof t?Promise.resolve(t):t}async Pt(t){if(!this.ht&&(await this.Ot(50),!this.ht))return Promise.resolve(0);const host=this.ht,s=this.router.ct,dom=s.get(runtime.IDOM),i=s.get(runtime.IProjectorLocator),h=s.get(runtime.IRenderingEngine);return this.component&&(this.component.jt&&this.component.jt(this.dt,this.pt),this.component.vt(runtime.LifecycleFlags.St),this.component.Vt(runtime.LifecycleFlags.St|runtime.LifecycleFlags.Ht)),this.$t&&(this.$t.kt&&this.$t.kt(this.pt,this.dt),this.$t.Nt(dom,i,h,host,null),this.$t.Ct(runtime.LifecycleFlags.Jt|runtime.LifecycleFlags.Dt,null),this.$t._t(runtime.LifecycleFlags.Jt),this.content=this.ut,this.dt=this.pt,this.component=this.$t),this.clear&&(this.content=this.component=null,this.dt=this.pt),this.ut=this.pt=this.$t=null,Promise.resolve(1)}description(t=0){if(this.content){const component=this.content.description.name,s=this.scope?this.router.nt.qt:"";if(t||s.length||this.options.At)return`${component}${this.router.nt.viewport}${this.name}${s}`;const i={};return i[component]=component,this.et.It(i)?component:`${component}${this.router.nt.viewport}${this.name}${s}`}}Lt(t=0){return[this.et.context(t),this.description(t)].filter(value=>value&&value.length).join(this.router.nt.scope)}Tt(component){let t=this.options.yt||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Wt(component){if("-"===component||null===component)return 1;let t=this.options.yt;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}loadComponent(component){this.$t=this.router.ct.get(runtime.CustomElementResource.ft(component.description.name))}async Ot(t){return this.ht?Promise.resolve():t?(await this.zt(100),this.Ot(--t)):Promise.resolve()}async zt(t=0){await new Promise(s=>{kernel.PLATFORM.global.setTimeout(s,t)})}}class Scope{constructor(router,t,s){this.router=router,this.ht=t,this.parent=s,this.children=[],this.Gt={},this.Kt={},this.parent&&this.parent.Qt(this)}It(t){const s=[];let i=0;t&&(this.Ut={},this.Kt={}),this.Ut=Object.assign({},this.Gt,this.Ut);for(const s in t){const parts=s.split(this.router.nt.scope),t=parts.shift();this.Kt[t]||(this.Kt[t]=[]),this.Kt[t].push(parts)}for(const h in this.Kt){const component=h.split(this.router.nt.viewport).shift();for(const name in this.Ut){const e=this.Ut[name];if(e&&e.Tt(component)){const o=this.Xt(t,this.Kt,h,component,e);s.push(...o.Yt),i=i||o.Zt,this.Ut[name]=null,delete this.Kt[h];break}}}for(const h in this.Kt){const parts=h.split(this.router.nt.viewport),component=parts.shift();let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let e=0;name.endsWith(this.router.nt.qt)&&(e=1,name=name.substr(0,name.length-1)),this.Gt[name]||(this.Bt(name,null,{scope:e,At:1}),this.Ut[name]=this.Gt[name]);const o=this.Ut[name];if(o&&o.Wt(component)){const e=this.Xt(t,this.Kt,h,component,o);s.push(...e.Yt),i=i||e.Zt,this.Ut[name]=null,delete this.Kt[h]}}for(const h in this.Kt){const component=h.split(this.router.nt.viewport).shift(),e=[];for(const name in this.Ut){const t=this.Ut[name];t&&t.Wt(component)&&e.push(t)}if(1===e.length){const o=e.shift(),n=this.Xt(t,this.Kt,h,component,o);s.push(...n.Yt),i=i||n.Zt,this.Ut[o.name]=null,delete this.Kt[h];break}}if(i=i||Object.keys(this.Kt).length>0,!t)for(const t of this.children){const h=t.It();s.push(...h.Yt),i=i||h.Zt}return{Yt:s,Zt:i}}Xt(t,s,i,component,h){const e=[{component,viewport:h}];let o=0;if(s[i].length){const n=h.scope||h.et;for(const h of s[i])if(h.length){const s=h.join(this.router.nt.scope),r={};r[s]=t[i+this.router.nt.scope+s];const c=n.It(r);e.push(...c.Yt),o=o||c.Zt}}return{Yt:e,Zt:o}}Bt(name,t,s){let i=this.Gt[name];if(!i){let h;s.scope&&(h=new Scope(this.router,t,this),this.router.Mt.push(h)),i=this.Gt[name]=new e(this.router,name,t,this,h,s)}return t&&(i.scope&&i.scope.parent&&!i.scope.viewport&&(i.scope.viewport=i),i.scope&&!i.scope.ht&&(i.scope.ht=t),i.ht||(i.ht=t,i.ht.children||this.xt(i).catch(t=>{throw t}))),i}Ft(t){return t.scope&&this.router.Rt(t.scope),delete this.Gt[t.name],Object.keys(this.Gt).length}Rt(){for(const t of this.children)t.Rt();for(const t in this.Gt)this.router.Ft(this.Gt[t])}xt(t){return t.bt().then(()=>t.Pt())}Qt(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Et(t=0){const s=[];for(const i in this.Gt)s.push(this.Gt[i].Lt(t));for(const i of this.children)s.push(...i.Et(t));return s.filter(value=>value&&value.length)}gt(){const t=[];for(const s in this.Gt)t.push(this.Gt[s]);for(const s of this.children)t.push(...s.gt());return t}context(t=0){if(!this.ht||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.ts(this.ht.parentElement);for(;i&&i.et===this.parent;)s.unshift(i.description(t)),i=this.ts(i.ht.parentElement);return s.unshift(this.parent.context(t)),s.filter(value=>value&&value.length).join(this.router.nt.scope)}ss(component){if("string"==typeof component){const t=this.router.ct.rt(runtime.CustomElementResource.ft(component));null!==t&&(component=t.at(this.router.ct).lt)}return component}ts(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h in this.Gt){const e=this.Gt[h].ht;let o=t,n=0;for(;o&&o!==e;)n++,o=o.parentElement;i>n&&(i=n,s=this.Gt[h])}return s}}class o{constructor(t){this.ct=t,this.hs=[],this.Gt={},this.Mt=[],this.h=0,this.es=0,this.os=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substr(1)),!s.startsWith("/")){const i=this.ns(t.anchor).context();i&&(s=`/${i}${this.nt.scope}${s}`)}this.rs.M(s)}),this.rs=new i,this.cs=new h}W(t){if(this.h)throw Error("Router has already been activated.");return this.h=1,this.options=Object.assign({T:t=>{this.fs(t).catch(t=>{throw t})}},t),this.nt=Object.assign({viewport:"@",ls:"+",scope:"/",qt:"!",as:"=",add:"+",clear:"-",action:"."},this.options.nt),this.cs.W({T:this.os}),this.rs.W(this.options).catch(t=>{throw t})}K(){if(!this.h)throw Error("Router has not been activated.");this.cs.K(),this.rs.K()}async fs(t){if(this.options.us&&this.options.us(t),t.V)return Promise.resolve();let s=0;(t.q||t._)&&(t.path=t.I);const i=t.path;let h,e;(i===this.nt.clear||i.startsWith(this.nt.clear+this.nt.add))&&(s=1,i.startsWith(this.nt.clear)&&(t.path=i.substr(1)));let o=this.ps(t);if(o){if(o.X)return o=this.ms(o,t.data),this.es=1,this.rs.X(o.path,o.title,t.data),Promise.resolve();o.title&&(h=o.title),e=o.Gt}else e=this.ws(t);if(!e&&!Object.keys(e).length&&!s)return Promise.resolve();h&&this.rs.Z(h);const n=s?this.ds.gt().filter(value=>null!==value.component):[];let{Yt:r,Zt:c}=this.ds.It(e),f=100;for(;(r.length||c)&&f--;){const s=[];for(const i of r){const{component,viewport:h}=i;h.ot(component,t)&&s.push(h);const e=n.findIndex(value=>value===h);0>e||n.splice(e,1)}for(const i of n)i.ot(this.nt.clear,t)&&s.push(i);!s.length&&this.es&&(this.rs.cancel(),this.es=0);let i=await Promise.all(s.map(value=>value.wt()));if(i.findIndex(value=>0==value)>=0)return this.rs.cancel(),Promise.resolve();if((i=await Promise.all(s.map(value=>value.bt()))).findIndex(value=>0==value)>=0)return this.rs.cancel(),Promise.resolve();i=await Promise.all(s.map(value=>value.Pt()));const h=this.ds.It();r=h.Yt,c=h.Zt}this.bs()}ps(t){return this.hs.find(value=>value.path===t.path)}ms(t,s){for(;t.X;){const i=this.ps({path:t.X,I:t.X,data:s});if(!i)break;t=i}return t}ws(t){const s={};let i=t.path;i.startsWith("/")&&(i=i.substr(1));let h=i.split(this.nt.ls),e=0;for(;h.length;){const t=h.shift().split(this.nt.scope),parts=t.pop().split(this.nt.viewport),component=parts[0];t.push(parts.length?parts.join(this.nt.viewport):`?${e++}`);const name=t.join(this.nt.scope);component&&(s[name]=component)}return s}$s(t){if(!this.ds){const t=this.ct.get(runtime.Aurelia).root().Ps;this.ds=new Scope(this,t,null),this.Mt.push(this.ds)}return this.ns(t)}Bt(name,t,s){return this.$s(t).Bt(name,t,s)}Ft(t){const s=t.et;s.Ft(t)||this.Rt(s)}Rt(t){if(t!==this.ds){t.Rt();const s=this.Mt.indexOf(t);0>s||this.Mt.splice(s,1)}}Os(t){this.hs.push(t)}U(t,s,i){"string"==typeof t&&this.rs.U(t,s,i)}replace(t,s,i){"string"==typeof t&&this.rs.replace(t,s,i)}refresh(){this.rs.refresh()}back(){this.rs.back()}forward(){this.rs.forward()}ns(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h of this.Mt){let e=t,o=0;for(;e&&e!==h.ht;)o++,e=e.parentElement;i>o&&(i=o,s=h)}return s}js(t){let s=t.slice().sort((t,s)=>s.split(this.nt.scope).length-t.split(this.nt.scope).length),i=[];if((s=s.map(value=>`${this.nt.scope}${value}${this.nt.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.nt.scope).length-s.split(this.nt.scope).length),i}bs(){let t=this.ds.Et();t=this.js(t);let s=this.ds.Et(1);(s=this.js(s)).unshift(this.nt.clear),this.rs.B(t.join(this.nt.ls),s.join(this.nt.ls))}}o.inject=[kernel.IContainer];class n{constructor(router,t){this.router=router,this.ht=t,this.name="default"}vs(){const t={scope:this.ht.hasAttribute("scope")};this.yt&&this.yt.length&&(t.yt=this.yt),this.viewport=this.router.Bt(this.name,this.ht,t)}Ss(){this.router.Ft(this.viewport)}}n.inject=[o,runtime.INode],s([runtime.bindable],n.prototype,"name",void 0),s([runtime.bindable],n.prototype,"scope",void 0),s([runtime.bindable],n.prototype,"usedBy",void 0),runtime.CustomElementResource.Vs({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},n),t.Hs=n,t.ks=i,t.Ns=h,t.Cs=o,t.Scope=Scope,t.Js=e,Object.defineProperty(t,"Ds",{value:1})});
