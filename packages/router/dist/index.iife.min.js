this.au=this.au||{},this.au.router=(function(t,kernel,runtime){"use strict";function s(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const h=t.replace("+"," ").split("&");for(const t of h){const h=t.split("="),e=decodeURIComponent(h.shift());if(!h.length){i.push(e);continue}const value=decodeURIComponent(h.shift());s[e]=value}return{t:s,list:i}}function i(t,s,i,h){var e,n,r=arguments.length,o=3>r?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,s,i,h);else for(n=t.length-1;n>=0;n--)(e=t[n])&&(o=(3>r?e(o):r>3?e(s,i,o):e(s,i))||o);return r>3&&o&&Object.defineProperty(s,i,o),o}class h{constructor(){this.s=(async t=>this.i(this,"popstate",[t])),this.window=window,this.history=window.history,this.h=[],this.o=0,this.l=null,this.u=null,this.p=null,this.v=null}g(t){if(this.o)throw kernel.Reporter.error(2003);this.o=1,this.u=t,kernel.PLATFORM.m.add(this.$,this),this.window.addEventListener("popstate",this.s)}C(){this.window.removeEventListener("popstate",this.s),kernel.PLATFORM.m.remove(this.$,this),this.u=null,this.o=0}get length(){return this.history.length}get state(){return this.history.state}get O(){return this.history.O}async go(t,s=0){if(!s)return this.i(this,"_go",[t],1);const i=this.i(this,"suppressPopstate",[],1);return this.i(this.history,"go",[t]).catch(t=>{throw t}),i}back(){return this.go(-1)}forward(){return this.go(1)}async pushState(t,s,i){return this.i(this.history,"pushState",[t,s,i])}async replaceState(t,s,i){return this.i(this.history,"replaceState",[t,s,i])}async S(t){if(this.v){const t=this.v;this.v=null,t()}else{if(this.p){const t=this.p;this.p=null,t(),await Promise.resolve()}this.u(t)}}P(t,s){this.p=s,this.history.go(t)}V(t){this.v=t}i(t,s,i,h=0){let e;const n=new Promise(t=>{e=t});return h&&(i.push(e),e=null),this.h.push({target:t,R:s,t:i,resolve:e}),n}async $(t){if(!this.h.length||null!==this.l)return;this.l=this.h.shift();const s=this.l.target[this.l.R];kernel.Reporter.write(1e4,"DEQUEUE",this.l.R,this.l.t),s.apply(this.l.target,this.l.t);const i=this.l.resolve;this.l=null,i&&i()}}class e{constructor(){this.k=(async()=>{if(null!==this.j){kernel.Reporter.write(1e4,"=== ignore path change",this.H());const t=this.j;return this.j=null,void t()}const t=this.H(),s=this.A();kernel.Reporter.write(1e4,"path changed to",t,this.N,this.I);const i={};let h,e=this.T("HistoryEntry");if(this.N&&this.N.path===t){i.q=1;const t=this.D?this.I.index:this.history.length-this.L;h=this.I,this.I=this.N,this.I.index=t,this.D?(this.U=0,this._[this.I.index]=this.I,this.J?(i.F=1,this.J=0):this.G?(i.B=1,this.G=0):i.M=1,this.D=0):(this.U=1,this._=this._.slice(0,this.I.index),this._.push(this.I)),await this.W({K:this._,X:this.L,Y:this.I})}else this._=this._||this.T("HistoryEntries")||[],this.L=this.L||this.T("HistoryOffset")||0,e||this.I?e?this.I?e.index>this.I.index?i.Z=1:this.I.index>e.index&&(i.tt=1):i.B=1:i.q=1:(i.q=1,i.st=1,this.L=this.history.length),e||(e={path:t,it:null,index:this.history.length-this.L,ht:s},i.st&&(e.et=1),this._=this._.slice(0,e.index),this._.push(e),await this.W({K:this._,X:this.L,Y:e})),this.U=this.I?e.index-this.I.index:0,h=this.I,this.I=e,this.J&&(i.F=1,this.J=0);this.N=null,this.nt&&this.nt--,kernel.Reporter.write(1e4,"navigated",this.T("HistoryEntry"),this._,this.T("HistoryOffset")),this.u(this.I,i,h)}),this.location=window.location,this.history=new h,this.I=null,this._=null,this.L=null,this.rt=null,this.N=null,this.options=null,this.o=0,this.U=null,this.nt=null,this.J=0,this.D=0,this.G=0,this.j=null}g(t){if(this.o)throw kernel.Reporter.error(0);return this.o=1,this.options=Object.assign({},t),this.history.g(this.k),Promise.resolve().then(()=>{this.ot(this.H(),1).catch(t=>{throw t})})}C(){this.history.C(),this.o=0}lt(t,s,i){return this.N={path:t,it:null,title:s,data:i},this.ot(t)}replace(t,s,i){return this.D=1,this.N={path:t,it:null,title:s,data:i},this.ot(t,1)}ct(t,s,i){return this.nt=this.U+1,this.replace(t,s,i)}async refresh(){if(this.I)return this.G=1,this.replace(this.I.path,this.I.title,this.I.data)}back(){return this.history.go(-1)}forward(){return this.history.go(1)}cancel(){this.J=1;const t=this.U||this.nt;return t?this.history.go(-t):this.replace(this.rt.path,this.rt.title,this.rt.data)}async pop(){let t,s=new Promise(t=>{this.j=t});await this.history.go(-1),await s;const i=""+this.location;if(!(t=this.history.state).Y.et)return s=new Promise(t=>{this.j=t}),await this.history.go(-1),await s,this.history.pushState(t,null,i)}async W(t,value){const{pathname:s,search:i,hash:h}=this.location;let e=Object.assign({},this.history.state);return"string"==typeof t?e[t]=JSON.parse(JSON.stringify(value)):e=Object.assign({},e,JSON.parse(JSON.stringify(t))),this.history.replaceState(e,null,`${s}${i}${h}`)}T(t){return Object.assign({},this.history.state)[t]}at(t){return this.I.title=t,this._[this.I.index]=this.I,this.W({K:this._,Y:this.I})}ut(t,s,i){if(i.index!==this.I.index)return;const h=`#/${t}`,{pathname:e,search:n,hash:r}=this.location;if(h===r&&this.I.path===t&&this.I.it===s)return;this.I.path=t,this.I.it=s;const o=Object.assign({},this.history.state,{Y:this.I,K:this._});return this.history.replaceState(o,null,`${e}${n}${h}`)}ft(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get pt(){return this._?this._.slice(0,this.I.index+1).map(value=>value.title):[]}H(){return this.location.hash.substring(1).split("?")[0]}async ot(t,s=0){if(this.I&&this.I.path===t&&!this.G)return;const{pathname:i,search:h}=this.location,e=`#${t}`;return s?(this.rt=this.I,await this.history.replaceState({},null,`${i}${h}${e}`)):await this.history.pushState({},null,`${i}${h}${e}`),this.k()}A(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}u(t,s,i){const h=Object.assign({},t,s);h.wt=i,kernel.Reporter.write(1e4,"callback",t,s),this.options.u&&this.options.u(h)}}class n{constructor(){this.o=0,this.dt=(t=>{const s=n.vt(t);s.gt&&(t.preventDefault(),this.options.u(s))}),this.document=document}static vt(t){const s={gt:0,href:null,anchor:null},i=n.yt(t.target);if(!i||!n.$t(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const h=i.getAttribute("href");return s.anchor=i,s.href=h,s.gt=1===t.which,s}static yt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static $t(t){const s=t.getAttribute("target");return!s||s===n.window.name||"_self"===s}g(t){if(this.o)throw kernel.Reporter.error(2004);this.o=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.dt,1)}C(){this.document.removeEventListener("click",this.dt,1),this.o=0}}class r{constructor(component,t,s){this.initialize(component,t,s)}initialize(component,t,s){"string"==typeof component?(this.bt=component,this.component=null):(this.component=component,this.bt=component.description.name),"string"==typeof t?(this.Ct=t,this.viewport=null):(this.viewport=t,t&&(this.Ct=t.name)),"string"==typeof s?(this.Et=s,this.t={id:s}):this.t=s}Ot(t){if(null!==this.component)return this.component;const s=t.get(kernel.IContainer),i=s.St(runtime.CustomElementResource.Pt(this.bt));return null!==i?i.Rt(s).Vt:null}kt(router){return null!==this.viewport?this.viewport:router.jt()[this.Ct]}Ht(t,s=0,i=0){return s&&this.Et!==t.Et?0:i?this.component===t.component:this.bt===t.bt}}class o{constructor(t,s){this.active="",this.At=t,Object.assign(this,{title:s.title,children:null,Nt:s.Nt,active:""}),this.instructions=this.It(s.Tt),this.link=this.xt(this.instructions),this.qt=s.zt?this.xt(this.It(s.zt)):this.link,this.Dt=this.At.router.Lt.get(runtime.IObserverLocator),this.Ut=this.Dt._t(0,this.At.router,"activeComponents"),this.Ut.subscribe(this)}get Jt(){return this.children&&this.children.length?"nav-has-children":""}Ft(){this.active=this.link&&this.link.length?this.Gt():"nav-active"===this.active?"nav-active":this.Bt()?"nav-active-child":""}Gt(){const t=this.At.router.Qt.Mt(this.qt),s=this.At.router.Wt.map(t=>this.At.router.Qt.Kt(t));for(const component of t)if(!s.find(t=>t.Ht(component)))return"";return"nav-active"}Xt(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}xt(instructions){return this.At.router.Qt.Yt(instructions)}It(t){if(!Array.isArray(t))return this.It([t]);const instructions=[];for(const s of t)instructions.push("string"==typeof s?this.At.router.Qt.Kt(s):s instanceof r?s:s.component?new r(s.component,s.viewport,s.t):new r(s));return instructions}Bt(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.Bt())return 1;return 0}}class l{constructor(router,name){this.router=router,this.name=name,this.Zt=[]}ts(t){for(const s of t)this.ss(this.Zt,s)}ss(t,s){const i=new o(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.ss(i.children,t)}}}class c{constructor(t,s){this.dt=t,this.names=s}}class a{constructor(t,s){this.hs=t,this.es=s}}class u{constructor(){this.ns=0,this.rs=0,this.os=0}}class f{constructor(t,s,i){this.dt=t,this.ls=s,this.cs=i}}class p{constructor(t,s,i){this.as=t,this.us=s,this.repeat=i}fs(t){return this.us===t.us&&this.as===t.as}}class State{constructor(t){this.ps=t,this.ws=[]}put(t){let s=this.ws.find(s=>s.ps.fs(t));return void 0===s&&(s=new State(t),this.ws.push(s),t.repeat&&s.ws.push(s)),s}}const w=/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g;class d{constructor(t,s){this.name=t,this.ds=t,this.vs=s,this.optional=0}gs(t){const s=this.ds,i=s.length;let h=0,e="";if(this.vs)for(;i>h;++h)e=s.charAt(h),t(new p(null,e,0));else for(;i>h;++h)e=s.charAt(h),t(new p(null,e.toUpperCase()+e.toLowerCase(),0))}ms(){return this.ds.replace(w,"\\$1")}ys(t,s){return this.ds}}class v{constructor(name,optional){this.name=name,this.optional=optional}gs(t){t(new p("/",null,1))}ms(){return"([^/]+)"}ys(t,s){return s[this.name]=1,t[this.name]}}class g{constructor(name){this.name=name,this.optional=0}gs(t){t(new p("",null,1))}ms(){return"(.+)"}ys(t,s){return s[this.name]=1,t[this.name]}}class m{gs(t){}ms(){return""}ys(t,s){return""}}class y{g(t){this.$s=Object.assign({viewport:"@",bs:"+",scope:"/",Cs:"!",t:"=",add:"+",clear:"-",action:"."},t.$s)}get Es(){return this.$s.clear}Kt(t){let component,s,i;const[h,e]=t.split(this.$s.viewport);return void 0===e?[component,i]=h.split(this.$s.t):(component=h,[s,i]=e.split(this.$s.t)),new r(component,s,i)}Os(t){let s=t.bt;return t.Ct&&(s+=this.$s.viewport+t.Ct),t.Et&&(s+=this.$s.t+t.Et),s}Ss(t,s){return t&&(s=`/${t}${this.$s.scope}${s}`),s}Ps(t){return{Vs:t===this.$s.clear||t.startsWith(this.$s.clear+this.$s.add),Rs:t.startsWith(this.$s.clear)?t.substring(1):t}}ks(t){const s={};t.startsWith("/")&&(t=t.substring(1));const i=t.split(this.$s.bs);let h=0;for(;i.length;){const t=i.shift().split(this.$s.scope),parts=t.pop().split(this.$s.viewport),component=parts[0];t.push(parts.length?parts.join(this.$s.viewport):`?${h++}`);const name=t.join(this.$s.scope);component&&(s[name]=component)}return s}Yt(instructions){const t=[];for(const s of instructions)t.push(this.Os(s));return t.join(this.$s.bs)}Mt(t){const instructions=[],s=t.split(this.$s.bs);for(const t of s)instructions.push(this.Kt(t));return instructions}js(t){let s=t.slice().sort((t,s)=>s.split(this.$s.scope).length-t.split(this.$s.scope).length),i=[];if((s=s.map(value=>`${this.$s.scope}${value}${this.$s.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.$s.scope).length-s.split(this.$s.scope).length),i}Hs(t,s=0){const i=t.slice();return s&&i.unshift(this.Es),i.join(this.$s.bs)}}var $;(function(t){t[t.As=0]="none",t[t.loaded=1]="loaded",t[t.Ns=2]="initialized",t[t.Is=3]="entered",t[t.Ts=4]="added"})($||($={}));class b{constructor(t=null,s=null,i=null,h=null){this.content=t,this.t=s,this.xs=i,this.component=null,this.qs=0,this.zs=0,null!==this.content&&"string"==typeof this.content&&null!==h&&(this.content=this.Ot(h))}Ds(t){return"string"==typeof t.content&&this.bt()!==t.content||"string"!=typeof t.content&&this.content!==t.content||this.t!==t.t||!this.xs||this.xs.ht!==t.xs.ht}Ls(t){return("string"==typeof t.content&&this.bt()===t.content||"string"!=typeof t.content&&this.content===t.content)&&this.t===t.t}loadComponent(t,s){return this.zs||(this.component=this.Us(t),this.component._s(0,t,s)),this.qs=1,Promise.resolve()}Js(){1===this.qs&&(this.qs=0)}Fs(){this.zs||this.component.Gs(2560,null),this.qs=2}Bs(t=0){2===this.qs&&(t||this.component.Ms(5120),this.qs=1)}addComponent(t){if(this.component.Qs(512),this.zs){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)if(t.hasAttribute("au-element-scroll")){const[s,i]=t.getAttribute("au-element-scroll").split(",");t.removeAttribute("au-element-scroll"),t.scrollTo(+i,+s)}}this.qs=4}Ws(t,s=0){if(4===this.qs){if(s){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)(t.scrollTop>0||t.scrollLeft)&&t.setAttribute("au-element-scroll",`${t.scrollTop},${t.scrollLeft}`)}this.component.Ks(1024),this.qs=4}}async Xs(t,s=0){switch(this.qs){case 4:this.Ws(t,s);case 3:this.component.Ys&&await this.component.Ys(),this.qs=2;case 2:this.Bs(s);case 1:this.Js()}this.qs=0}bt(){return null===this.content?null:"string"==typeof this.content?this.content:this.content.description.name}Ot(t){if(null===this.content)return null;if("string"!=typeof this.content)return this.content;{const s=t.get(kernel.IContainer),i=s.St(runtime.CustomElementResource.Pt(this.content));return null!==i?i.Rt(s).Vt:null}}Us(t){if(null===this.content)return null;const component=this.bt();return t.get(kernel.IContainer).get("string"!=typeof component?component:runtime.CustomElementResource.Pt(component))}}class C{constructor(router,name,t,s,i,h,e){this.router=router,this.name=name,this.Zs=t,this.context=s,this.ti=i,this.scope=h,this.options=e,this.clear=0,this.content=new b,this.si=null,this.ii=null,this.hi=null,this.cache=[],this.enabled=1}ei(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.Qt.Es)this.clear=1,t=null;else{const s=t.split(this.router.Qt.$s.t);t=s.shift(),i=s.length?s.join(this.router.Qt.$s.t):null}if(this.si=new b(t,i,s,this.context),this.options.ni){const t=this.cache.find(t=>this.si.Ls(t));t?(this.si=t,this.si.zs=1):this.cache.push(this.si)}return this.content.Ds(this.si)||s.B}ri(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.Zs&&(this.scope.Zs=t),this.Zs!==t&&(this.hi=Object.assign({},this),this.oi(),this.Zs=t,i&&i.li&&(this.options.li=i.li),i&&i.default&&(this.options.default=i.default),i&&i.ci&&(this.options.ci=i.ci),i&&i.ai&&(this.options.ai=i.ai),i&&i.ni&&(this.options.ni=i.ni),this.ii&&this.ii()),this.context!==s&&(this.context=s),this.content.component||this.si&&this.si.component||!this.options.default||this.router.ui(this.options.default,this)}remove(t,s){return this.Zs===t&&this.context===s?(this.content.component&&this.content.Xs(this.Zs,this.options.ni).catch(t=>{throw t}),1):0}async fi(){if(!this.content.component)return 1;const component=this.content.component;return component.fi?(kernel.Reporter.write(1e4,"viewport canLeave",component.fi(this.content.xs,this.si.xs)),component.fi(this.content.xs,this.si.xs)):1}async pi(){if(this.clear)return 1;if(!this.si.content)return 0;if(await this.wi(),await this.si.loadComponent(this.context,this.Zs),!this.si.component)return 0;const component=this.si.component;if(!component.pi)return 1;const t=component.pi(this.si.xs,this.content.xs);return kernel.Reporter.write(1e4,"viewport canEnter",t),"boolean"==typeof t?t:"string"==typeof t?[new r(t,this)]:t}async di(){if(kernel.Reporter.write(1e4,"Viewport enter",this.name),this.clear)return 1;if(!this.si.component)return 0;if(this.si.component.di){const t=(function(t,i,h){const e=s(i),n=s(t),r=Object.assign({},e.t,n.t),o=[...e.list,...n.list];if(o.length&&h&&h.length)for(const t of h)r[t]=o.shift();let l;return o.length&&Object.keys(r).length&&(r["vi"]=o.splice(0,o.length)),{gi:r,mi:o,yi:l=o.length?o:r}})(this.si.t,this.si.xs.ht,this.si.content.t);this.si.xs.t=t.gi,this.si.xs.mi=t.mi,await this.si.component.di(t.yi,this.si.xs,this.content.xs),this.si.qs=3}return this.si.Fs(),1}async $i(){return kernel.Reporter.write(1e4,"Viewport loadContent",this.name),this.content.component&&(this.content.component.Ys&&await this.content.component.Ys(this.content.xs,this.si.xs),this.si.component||(this.content.Ws(this.Zs,this.options.ni),this.content.Bs(this.options.ni),this.content.Js())),this.si.component&&(this.content.component&&(this.content.Ws(this.Zs,this.options.ni),this.content.Bs(this.options.ni),this.content.Js()),this.si.addComponent(this.Zs),this.content=this.si),this.clear&&(this.content=new b(null,null,this.si.xs)),this.si=null,1}bi(){this.hi=null}async Ci(){await this.si.Xs(this.Zs,this.options.ni),this.hi&&Object.assign(this,this.hi)}description(t=0){if(this.content.content){const component=this.content.bt(),s=this.scope?this.router.Qt.$s.Cs:"",i=this.content.t?this.router.Qt.$s.t+this.content.t:"";if(t||s.length||this.options.Ei)return`${component}${this.router.Qt.$s.viewport}${this.name}${s}${i}`;const h={};return h[component]=component,this.ti.Oi(h)?`${component}${i}`:`${component}${this.router.Qt.$s.viewport}${this.name}${s}${i}`}}Si(t=0){return[this.ti.Pi(t),this.description(t)].filter(value=>value&&value.length).join(this.router.Qt.$s.scope)}Vi(component){let t=this.options.li||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Ri(component){if("-"===component||null===component)return 1;let t=this.options.li;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}ki(t){this.content.component&&this.content.Fs()}ji(t){kernel.Reporter.write(1e4,"ATTACHING viewport",this.name,this.content,this.si),this.enabled=1,this.content.component&&this.content.addComponent(this.Zs)}Hi(t){kernel.Reporter.write(1e4,"DETACHING viewport",this.name),this.content.component&&this.content.Ws(this.Zs,this.options.ni),this.enabled=0}Ai(t){this.content.component&&this.content.Bs(this.options.ni)}oi(){this.options={},this.content=new b,this.cache=[]}async wi(){return this.Zs?Promise.resolve():new Promise(t=>{this.ii=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.Zs=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.Ni=[],this.Ii={},this.Ti=null,this.parent&&this.parent.xi(this)}qi(){return this.Ni.filter(t=>t.enabled).reduce((t,s)=>(t[s.name]=s,t),{})}Oi(t){const s=[];let i=0;t&&(this.Ti={},this.Ii={}),this.Ti=Object.assign({},this.qi(),this.Ti);for(const s in t){const parts=s.split(this.router.Qt.$s.scope),t=parts.shift();this.Ii[t]||(this.Ii[t]=[]),this.Ii[t].push(parts)}for(const h in this.Ii){const e=h.split(this.router.Qt.$s.t),component=e.shift().split(this.router.Qt.$s.viewport).shift(),n=component+(e.length?this.router.Qt.$s.t+e.join(this.router.Qt.$s.t):"");for(const name in this.Ti){const e=this.Ti[name];if(e&&e.Vi(component)){const r=this.zi(t,this.Ii,h,n,e);s.push(...r.Di),i=i||r.Li,this.Ti[name]=null,Reflect.deleteProperty(this.Ii,h);break}}}for(const h in this.Ii){const e=h.split(this.router.Qt.$s.t),parts=e.shift().split(this.router.Qt.$s.viewport),component=parts.shift(),n=component+(e.length?this.router.Qt.$s.t+e.join(this.router.Qt.$s.t):"");let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let r=0;name.endsWith(this.router.Qt.$s.Cs)&&(r=1,name=name.substring(0,name.length-1)),this.qi()[name]||(this.Ui(name,null,null,{scope:r,Ei:1}),this.Ti[name]=this.qi()[name]);const o=this.Ti[name];if(o&&o.Ri(component)){const e=this.zi(t,this.Ii,h,n,o);s.push(...e.Di),i=i||e.Li,this.Ti[name]=null,Reflect.deleteProperty(this.Ii,h)}}for(const h in this.Ii){const e=h.split(this.router.Qt.$s.t),component=e.shift().split(this.router.Qt.$s.viewport).shift(),n=component+(e.length?this.router.Qt.$s.t+e.join(this.router.Qt.$s.t):""),r=[];for(const name in this.Ti){const t=this.Ti[name];t&&t.Ri(component)&&r.push(t)}if(1===r.length){const e=r.shift(),o=this.zi(t,this.Ii,h,n,e);s.push(...o.Di),i=i||o.Li,this.Ti[e.name]=null,Reflect.deleteProperty(this.Ii,h);break}}if(i=i||Object.keys(this.Ii).length>0,!t)for(const t of this.children){const h=t.Oi();s.push(...h.Di),i=i||h.Li}return{Di:s,Li:i}}zi(t,s,i,component,h){const e=[{component,viewport:h}];let n=0;if(s[i].length){const r=h.scope||h.ti;for(const h of s[i])if(h.length){const s=h.join(this.router.Qt.$s.scope),o={};o[s]=t[i+this.router.Qt.$s.scope+s];const l=r.Oi(o);e.push(...l.Di),n=n||l.Li}}return{Di:e,Li:n}}Ui(name,t,s,i){let h=this.qi()[name];if(t&&h&&null!==h.Zs&&h.Zs!==t&&(h.enabled=0,(h=this.Ni.find(s=>s.name===name&&s.Zs===t))&&(h.enabled=1)),!h){let e;i.scope&&(e=new Scope(this.router,t,s,this),this.router._i.push(e)),h=new C(this.router,name,null,null,this,e,i),this.Ni.push(h)}return(t||s)&&h.ri(t,s,i),h}Ji(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.Fi(t.scope),this.Ni.splice(this.Ni.indexOf(t),1)),Object.keys(this.Ni).length}Fi(){for(const t of this.children)t.Fi();const t=this.qi();for(const name in t)this.router.Ji(t[name],null,null)}Gi(t){return t.pi().then(()=>t.$i())}xi(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Bi(t=0,s=0){const i=[];for(const h in this.qi()){const e=this.qi()[h];(e.options.ai||e.options.ci&&!t)&&!s||i.push(e.Si(t))}for(const s of this.children)i.push(...s.Bi(t));return i.filter(value=>value&&value.length)}jt(){const t=this.Ni.filter(t=>t.enabled);for(const s of this.children)t.push(...s.jt());return t}Pi(t=0){if(!this.Zs||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.Mi(this.context.get(kernel.IContainer).parent);for(;i&&i.ti===this.parent;)s.unshift(i.description(t)),i=this.Mi(i.context.get(kernel.IContainer).parent);return s.unshift(this.parent.Pi(t)),s.filter(value=>value&&value.length).join(this.router.Qt.$s.scope)}Mi(t){const s=Object.values(this.qi());for(;t;){const i=s.find(s=>s.context.get(kernel.IContainer)===t);if(i)return i;t=t.parent}return null}}class E{constructor(t){this.Lt=t,this._i=[],this.Qi={},this.Wt=[],this.Wi=[],this.o=0,this.Ki=0,this.Xi=[],this.Yi=null,this.Zi=null,this.th=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.sh(t.anchor).Pi();s=this.Qt.Ss(i,s)}this.ih.ft(s)}),this.ih=new e,this.hh=new n,this.Qt=new y}get eh(){return null!==this.Yi}g(t){if(this.o)throw kernel.Reporter.error(2001);return this.o=1,this.options=Object.assign({u:t=>{this.nh(t)}},t),this.Qt.g({$s:this.options.$s}),this.hh.g({u:this.th}),this.ih.g(this.options).catch(t=>{throw t})}C(){if(!this.o)throw kernel.Reporter.error(2e3);this.hh.C(),this.ih.C()}nh(t){this.Xi.push(t),this.rh().catch(t=>{throw t})}async rh(){if(null!==this.Yi||!this.Xi.length)return Promise.resolve();const t=this.Xi.shift();if(this.Yi=t,this.options.oh&&this.options.oh(t),t.F)return this.Yi=null,this.rh();let i=0;(t.tt||t.Z)&&t.it&&(t.path=t.it,i=1);let h=t.path;this.options.lh&&!i&&(h=this.options.lh(h,this),Array.isArray(h)&&(h=this.Qt.Yt(h)));const{Vs:e,Rs:n}=this.Qt.Ps(h);e&&(h=n);const r=s(t.ht);t.t=r.t,t.mi=r.list;const o=this.Qt.ks(h);if(!o&&!Object.keys(o).length&&!e)return this.Yi=null,this.rh();const l=e?this.jt().filter(value=>null!==value.content.component):[],c=this.jt().filter(value=>value.options.default&&null===value.content.component),a=[];let{Di:u,Li:f}=this.ah.Oi(o),p=100;for(;u.length||f||c.length;){if(!p--)throw kernel.Reporter.error(2002);const s=[];for(const i of u){const{component,viewport:h}=i;h.ei(component,t)&&s.push(h);const e=l.findIndex(value=>value===h);0>e||l.splice(e,1);const n=c.findIndex(value=>value===h);0>n||c.splice(n,1)}for(const i of l)i.ei(this.Qt.Es,t)&&s.push(i);let i;for(;i=c.shift();)i.ei(i.options.default,t)&&s.push(i);if(!s.length&&this.Ki){const i=this.uh([...s,...a],t);return this.Ki=0,await this.rh(),i}let h=await Promise.all(s.map(value=>value.fi()));if(h.findIndex(value=>0==value)>=0)return this.uh([...s,...a],t);if((h=await Promise.all(s.map(async value=>{const t=await value.pi();if("boolean"==typeof t)return t?value.di():0;for(const s of t)this.ui(s.component,s.viewport);return value.Ci().catch(t=>{throw t}),1}))).some(t=>0==t))return this.uh([...s,...a],t);for(const t of s)a.find(value=>value===t)||a.push(t);const e=this.ah.Oi();let n;for(u=[];n=this.Wi.shift();)e.Di.find(value=>value.viewport===n.viewport)||u.push(n);u=[...u,...e.Di],f=e.Li}await Promise.all(a.map(value=>value.$i())),await this.fh(t),t.st||t.ph||!a.every(t=>t.options.ai)||await this.ih.pop(),a.forEach(t=>{t.bi()}),this.Zi=this.Yi,this.Zi.ph&&(this.Zi.ph=0),this.Yi=null,this.rh().catch(t=>{throw t})}ui(component,t){this.Yi?("string"==typeof t&&(t=this.jt().find(s=>s.name===t)),this.Wi.push({viewport:t,component})):this.Zi&&(this.Xi.unshift({path:"",it:"",ph:1}),this.rh().catch(t=>{throw t}))}wh(t){return this.dh(),this.sh(t)}Ui(name,t,s,i){return kernel.Reporter.write(1e4,"Viewport added",name,t),this.wh(t).Ui(name,t,s,i)}Ji(t,s,i){const h=t.ti;h.Ji(t,s,i)||this.Fi(h)}jt(){return this.dh(),this.ah.jt()}Fi(t){if(t!==this.ah){t.Fi();const s=this._i.indexOf(t);0>s||this._i.splice(s,1)}}lt(t,s,i){if("string"==typeof t)return this.ih.lt(t,s,i)}replace(t,s,i){if("string"==typeof t)return this.ih.replace(t,s,i)}refresh(){return this.ih.refresh()}back(){return this.ih.back()}forward(){return this.ih.forward()}vh(name,t){const s=this.gh(name);s&&(s.Zt=[]),this.mh(name,t)}mh(name,t){let s=this.Qi[name];s||(s=this.Qi[name]=new l(this,name)),s.ts(t)}gh(name){return this.Qi[name]}async uh(t,s){t.forEach(t=>{t.Ci().catch(t=>{throw t})}),s.q?await this.ih.pop():await this.ih.cancel(),this.Yi=null,this.rh().catch(t=>{throw t})}dh(){if(!this.ah){const t=this.Lt.get(runtime.Aurelia).root();this.ah=new Scope(this,t.yh,t.$context,null),this._i.push(this.ah)}}sh(t){let s=(function(t){for(;t&&!t.$customElement;)t=t.parentElement;return t})(t).$customElement.$context.get(kernel.IContainer);for(;s;){const t=this._i.find(t=>t.context.get(kernel.IContainer)===s);if(t)return t;s=s.parent}}fh(t){this.Wt=this.ah.Bi(1,1),this.Wt=this.Qt.js(this.Wt);let s=this.ah.Bi();s=this.Qt.js(s);let i=this.Qt.Hs(s);this.options.$h&&(i=this.options.$h(this.Qt.Mt(i),this));let h=this.ah.Bi(1);h=this.Qt.js(h);const e=t.ht&&t.ht.length?`?${t.ht}`:"";return this.ih.ut(i+e,this.Qt.Hs(h,1)+e,t)}}E.inject=[kernel.IContainer];class O{constructor(router,t,s){this.router=router,this.Zs=t,this.bh=s,this.name="default",this.scope=null,this.li=null,this.default=null,this.ci=null,this.ai=null,this.ni=null,this.viewport=null}Ch(t,host,parts,s){const i=this.constructor,dom=s.get(runtime.IDOM),template=this.bh.Eh(dom,i.description,s,i);template.Oh=runtime.createRenderContext(dom,s,i.description.dependencies,i),template.Ch(this,host,parts)}bound(){this.connect()}Sh(){this.disconnect()}connect(){const t={scope:this.Zs.hasAttribute("scope")};this.li&&this.li.length&&(t.li=this.li),this.default&&this.default.length&&(t.default=this.default),this.Zs.hasAttribute("no-link")&&(t.ci=1),this.Zs.hasAttribute("no-history")&&(t.ai=1),this.Zs.hasAttribute("stateful")&&(t.ni=1),this.viewport=this.router.Ui(this.name,this.Zs,this.$context,t)}disconnect(){this.router.Ji(this.viewport,this.Zs,this.$context)}ki(t){this.viewport&&this.viewport.ki(t)}ji(t){this.viewport&&this.viewport.ji(t)}Hi(t){this.viewport&&this.viewport.Hi(t)}Ai(t){this.viewport&&this.viewport.Ai(t)}}return O.inject=[E,runtime.INode,runtime.IRenderingEngine],i([runtime.bindable],O.prototype,"name",void 0),i([runtime.bindable],O.prototype,"scope",void 0),i([runtime.bindable],O.prototype,"usedBy",void 0),i([runtime.bindable],O.prototype,"default",void 0),i([runtime.bindable],O.prototype,"noLink",void 0),i([runtime.bindable],O.prototype,"noHistory",void 0),i([runtime.bindable],O.prototype,"stateful",void 0),runtime.CustomElementResource.Ph({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},O),t.Vh=class{constructor(router){this.router=router,this.name=null,this.Zt=null,this.level=0}get Rh(){const t=this.router.gh(this.name);return t?t.Zt:[]}active(t){return"Active"}},i([runtime.bindable],t.Vh.prototype,"name",void 0),i([runtime.bindable],t.Vh.prototype,"routes",void 0),i([runtime.bindable],t.Vh.prototype,"level",void 0),t.Vh=i([kernel.inject(E,Element),runtime.customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],t.Vh),t.kh=e,t.jh=n,t.Hh=l,t.Ah=h,t.Nh=c,t.Ih=a,t.Th=u,t.xh=f,t.qh=p,t.State=State,t.zh=d,t.Dh=v,t.Lh=g,t.Uh=m,t._h=class{constructor(){this.Jh=new State,this.names={},this.Zt=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.Jh;const i=[];let h="^";const e=new u,n=[],r=t.dt.name;let o=1,l=t.path;"/"===l.charAt(0)&&(l=l.slice(1));const f=[],w=l.split("/");let y,$;for(let r=0,l=w.length;l>r;++r){let l=(y=w[r]).match(/^:([^?]+)(\?)?$/);if(l){const[,name,optional]=l;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);f.push($=new v(name,!!optional)),n.push(name),e.rs++}else if(l=y.match(/^\*(.+)$/))f.push($=new g(l[1])),n.push(l[1]),e.os++;else{if(""===y){f.push(new m);continue}f.push($=new d(y,t.vs)),e.ns++}const c=s.put(new p(null,"/",0));let a=c;$.gs(t=>{a=a.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].ws.push(c);$.optional?(i.push(a),h+=`(?:/${$.ms()})?`):(s=a,h+=`/${$.ms()}`,i.length=0,o=0)}o&&(s=s.put(new p(null,"/",0)),h+="/?");const b=[new c(t.dt,n)];if(this.Zt.set(t.dt,new a(f,b)),r){const t=Array.isArray(r)?r:[r];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new a(f,b))}for(let s=0;i.length>s;s++){const n=i[s];n.es=b,n.ms=RegExp(`${h}$`,t.vs?"":"i"),n.types=e}return s.es=b,s.ms=RegExp(`${h}$`,t.vs?"":"i"),s.types=e,s}Fh(t){return"string"==typeof t?this.names[t]:this.Zt.get(t)}Gh(t){const s=this.Fh(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.es]}Bh(t){return!!this.Fh(t)}ys(t,s){const i=this.Fh(t);if(!i)throw Error(`There is no route named ${t}`);const h=i.es[0].dt;if(h.Mh)return h.href;const e=Object.assign({},s),n=i.hs,r={};let o="";for(let s=0,i=n.length;i>s;s++){const i=n[s];if(i instanceof m)continue;const h=i.ys(e,r);if(null==h){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else o+="/",o+=h}"/"!==o.charAt(0)&&(o=`/${o}`);for(const t in r)Reflect.deleteProperty(e,t);const l=kernel.buildQueryString(e);return o+(l?`?${l}`:"")}Qh(t){let s=[this.Jh],i={},h=0,e=t;const n=e.indexOf("?");if(-1!==n){const t=e.slice(n+1);e=e.slice(0,n),i=kernel.parseQueryString(t)}"/"!==(e=decodeURI(e)).charAt(0)&&(e=`/${e}`);let r=e.length;r>1&&"/"===e.charAt(r-1)&&(e=e.slice(0,-1),h=1,--r);for(let t=0;r>t;++t){const i=[],h=e.charAt(t);if(s.forEach(t=>{t.ws.forEach(t=>{null!==t.ps.us?-1!==t.ps.us.indexOf(h)&&i.push(t):null!==t.ps.as&&-1===t.ps.as.indexOf(h)&&i.push(t)})}),0===(s=i).length)break}const o=[];for(let t=0,i=s.length;i>t;t++)s[t].es&&o.push(s[t]);o.sort((t,s)=>{if(t.types.os!==s.types.os)return t.types.os-s.types.os;if(t.types.os){if(t.types.ns!==s.types.ns)return s.types.ns-t.types.ns;if(t.types.rs!==s.types.rs)return s.types.rs-t.types.rs}return t.types.rs!==s.types.rs?t.types.rs-s.types.rs:t.types.ns!==s.types.ns?s.types.ns-t.types.ns:0});const l=o[0];if(l&&l.es){h&&"(.+)$"===l.ms.source.slice(-5)&&(e=`${e}/`);const t=e.match(l.ms);let s=1;const n=[];return n.Wh=i,l.es.forEach(i=>{const h={};i.names.forEach(name=>{h[name]=t[s++]}),n.push(new f(i.dt,h,i.names.length>0))}),n}}},t.Kh=E,t.Scope=Scope,t.Xh=C,t.Yh=O,t})({},kernel,runtime);
