this.au=this.au||{},this.au.router=(function(t,runtime,kernel){"use strict";function s(t,s,i,h){var o,e,n=arguments.length,r=3>n?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.t)r=Reflect.t(t,s,i,h);else for(e=t.length-1;e>=0;e--)(o=t[e])&&(r=(3>n?o(r):n>3?o(s,i,r):o(s,i))||r);return n>3&&r&&Object.defineProperty(s,i,r),r}class i{constructor(){this.s=null,this.i=0,this.h=0,this.o=0,this.l=0,this.u=(()=>{const t=this.p(),s={};let i=this.m("HistoryEntry");if(this.s&&this.s.path===t){s.$=1;const t=this.o?this.P.index:this.history.length-this.O;this.P=this.s,this.P.index=t,this.o?(this.j=0,this.S[this.P.index]=this.P,this.h?(s.v=1,this.h=0):this.l?(s.V=1,this.l=0):s.H=1,this.o=0):(this.j=1,this.S=this.S.slice(0,this.P.index),this.S.push(this.P)),this.k({N:this.S,C:this.O,J:this.P})}else this.S=this.S||this.m("HistoryEntries")||[],this.O=this.O||this.m("HistoryOffset")||0,i||this.P?i?this.P?i.index>this.P.index?s.D=1:this.P.index>i.index&&(s.A=1):s.V=1:s.$=1:(s.$=1,s.I=1,this.O=this.history.length),i||(this.S=this.S.slice(0,(i={path:t,L:t,index:this.history.length-this.O}).index),this.S.push(i),this.k({N:this.S,C:this.O,J:i})),this.j=this.P?i.index-this.P.index:0,this.P=i,this.h&&(s.v=1,this.h=0);this.s=null,this.T&&this.T--,this.W(this.P,s)}),this.location=window.location,this.history=window.history}_(t){if(this.i)throw Error("History has already been activated.");return this.i=1,this.options=Object.assign({},t),window.addEventListener("popstate",this.u),Promise.resolve().then(()=>{this.q(this.p(),1)})}G(){window.removeEventListener("popstate",this.u),this.i=0}K(t,s,i){this.s={path:t,L:t,title:s,data:i},this.q(t)}replace(t,s,i){this.o=1,this.s={path:t,L:t,title:s,data:i},this.q(t,1)}U(t,s,i){this.T=this.j+1,this.replace(t,s,i)}refresh(){this.P&&(this.l=1,this.replace(this.P.path,this.P.title,this.P.data))}back(){this.history.go(-1)}forward(){this.history.go(1)}cancel(){this.h=1;const t=this.j||this.T;t?this.history.go(-t):this.replace(this.X.path,this.X.title,this.X.data)}k(t,value){const{pathname:s,search:i,hash:h}=this.location;let o=Object.assign({},this.history.state);"string"==typeof t?o[t]=JSON.parse(JSON.stringify(value)):o=Object.assign({},o,JSON.parse(JSON.stringify(t))),this.history.replaceState(o,null,`${s}${i}${h}`)}m(t){return Object.assign({},this.history.state)[t]}Y(t){this.P.title=t,this.S[this.P.index]=this.P,this.k({N:this.S,J:this.P})}Z(t,s){const i=`#/${t}`,{pathname:h,search:o,hash:e}=this.location;if(i===e)return;this.P.path=t,this.P.L=s;const n=Object.assign({},this.history.state,{J:this.P,N:this.S});this.history.replaceState(n,null,`${h}${o}${i}`)}B(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get M(){return this.S?this.S.slice(0,this.P.index+1).map(value=>value.title):[]}p(){return this.location.hash.substr(1)}q(t,s=0){if(this.P&&this.P.path===t&&!this.l)return;const{pathname:i,search:h}=this.location,o=`#${t}`;s?(this.X=this.P,this.history.replaceState({},null,`${i}${h}${o}`)):this.history.pushState({},null,`${i}${h}${o}`),this.u()}W(t,s){const i=Object.assign({},t,s);this.options.W&&this.options.W(i)}}class h{constructor(){this.i=0,this.F=(t=>{const s=h.R(t);s.g&&(t.preventDefault(),this.options.W(s))}),this.document=document}static R(t){const s={g:0,href:null,anchor:null},i=h.tt(t.target);if(!i||!h.st(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const o=i.getAttribute("href");return s.anchor=i,s.href=o,s.g=1===t.which,s}static tt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static st(t){const s=t.getAttribute("target");return!s||s===h.window.name||"_self"===s}_(t){if(this.i)throw Error("LinkHandler has already been activated.");this.i=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.F,1)}G(){this.document.removeEventListener("click",this.F),this.i=0}}class o{constructor(router,name,t,s,i,h){this.router=router,this.name=name,this.it=t,this.ht=s,this.scope=i,this.options=h,this.clear=0}ot(t,s){if(this.clear=0,"string"==typeof t)if(t===this.router.et.clear)this.clear=1,t=null;else{const s=this.router.rt.nt(runtime.CustomElementResource.ct(t));null!==s&&(t=s.lt(this.router.rt).ft)}return this.at=t,this.ut=s,this.content!==t||s.V?1:0}pt(){if(!this.component)return Promise.resolve(1);const component=this.component;if(!component.pt)return Promise.resolve(1);const t=component.pt(this.wt,this.ut);return"boolean"==typeof t?Promise.resolve(t):t}bt(){if(this.clear)return Promise.resolve(1);if(!this.at)return Promise.resolve(0);if(this.loadComponent(this.at),!this.dt)return Promise.resolve(0);const component=this.dt;if(!component.bt)return Promise.resolve(1);const t=component.bt(this.ut,this.wt);return"boolean"==typeof t?Promise.resolve(t):t}async $t(t){if(!this.it&&(await this.Pt(50),!this.it))return Promise.resolve(0);const host=this.it,s=this.router.rt,dom=s.get(runtime.IDOM),i=s.get(runtime.IProjectorLocator),h=s.get(runtime.IRenderingEngine);return this.component&&(this.component.Ot&&this.component.Ot(this.wt,this.ut),this.component.jt(runtime.LifecycleFlags.St),this.component.vt(runtime.LifecycleFlags.St|runtime.LifecycleFlags.Vt)),this.dt&&(this.dt.Ht&&this.dt.Ht(this.ut,this.wt),this.dt.kt(dom,i,h,host,null),this.dt.Nt(runtime.LifecycleFlags.Ct|runtime.LifecycleFlags.Jt,null),this.dt.Dt(runtime.LifecycleFlags.Ct),this.content=this.at,this.wt=this.ut,this.component=this.dt),this.clear&&(this.content=this.component=null,this.wt=this.ut),this.at=this.ut=this.dt=null,Promise.resolve(1)}description(t=0){if(this.content){const component=this.content.description.name,s=this.scope?this.router.et.At:"";if(t||s.length||this.options.It)return`${component}${this.router.et.viewport}${this.name}${s}`;const i={};return i[component]=component,this.ht.Lt(i)?component:`${component}${this.router.et.viewport}${this.name}${s}`}}Tt(t=0){return[this.ht.context(t),this.description(t)].filter(value=>value&&value.length).join(this.router.et.scope)}Wt(component){let t=this.options._t||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}qt(component){if("-"===component||null===component)return 1;let t=this.options._t;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}loadComponent(component){this.dt=this.router.rt.get(runtime.CustomElementResource.ct(component.description.name))}async Pt(t){return this.it?Promise.resolve():t?(await this.zt(100),this.Pt(--t)):Promise.resolve()}async zt(t=0){await new Promise(s=>{kernel.PLATFORM.global.setTimeout(s,t)})}}class Scope{constructor(router,t,s){this.router=router,this.it=t,this.parent=s,this.children=[],this.Gt={},this.Kt={},this.parent&&this.parent.Qt(this)}Lt(t){const s=[];let i=0;t&&(this.Ut={},this.Kt={}),this.Ut=Object.assign({},this.Gt,this.Ut);for(const s in t){const parts=s.split(this.router.et.scope),t=parts.shift();this.Kt[t]||(this.Kt[t]=[]),this.Kt[t].push(parts)}for(const h in this.Kt){const component=h.split(this.router.et.viewport).shift();for(const name in this.Ut){const o=this.Ut[name];if(o&&o.Wt(component)){const e=this.Xt(t,this.Kt,h,component,o);s.push(...e.Yt),i=i||e.Zt,this.Ut[name]=null,delete this.Kt[h];break}}}for(const h in this.Kt){const parts=h.split(this.router.et.viewport),component=parts.shift();let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let o=0;name.endsWith(this.router.et.At)&&(o=1,name=name.substr(0,name.length-1)),this.Gt[name]||(this.Bt(name,null,{scope:o,It:1}),this.Ut[name]=this.Gt[name]);const e=this.Ut[name];if(e&&e.qt(component)){const o=this.Xt(t,this.Kt,h,component,e);s.push(...o.Yt),i=i||o.Zt,this.Ut[name]=null,delete this.Kt[h]}}for(const h in this.Kt){const component=h.split(this.router.et.viewport).shift(),o=[];for(const name in this.Ut){const t=this.Ut[name];t&&t.qt(component)&&o.push(t)}if(1===o.length){const e=o.shift(),n=this.Xt(t,this.Kt,h,component,e);s.push(...n.Yt),i=i||n.Zt,this.Ut[e.name]=null,delete this.Kt[h];break}}if(i=i||Object.keys(this.Kt).length>0,!t)for(const t of this.children){const h=t.Lt();s.push(...h.Yt),i=i||h.Zt}return{Yt:s,Zt:i}}Xt(t,s,i,component,h){const o=[{component,viewport:h}];let e=0;if(s[i].length){const n=h.scope||h.ht;for(const h of s[i])if(h.length){const s=h.join(this.router.et.scope),r={};r[s]=t[i+this.router.et.scope+s];const c=n.Lt(r);o.push(...c.Yt),e=e||c.Zt}}return{Yt:o,Zt:e}}Bt(name,t,s){let i=this.Gt[name];if(!i){let h;s.scope&&(h=new Scope(this.router,t,this),this.router.yt.push(h)),i=this.Gt[name]=new o(this.router,name,t,this,h,s)}return t&&(i.scope&&i.scope.parent&&!i.scope.viewport&&(i.scope.viewport=i),i.scope&&!i.scope.it&&(i.scope.it=t),i.it||(i.it=t,i.it.children||this.Mt(i).catch(t=>{throw t}))),i}Ft(t){return t.scope&&this.router.Rt(t.scope),delete this.Gt[t.name],Object.keys(this.Gt).length}Rt(){for(const t of this.children)t.Rt();for(const t in this.Gt)this.router.Ft(this.Gt[t])}Mt(t){return t.bt().then(()=>t.$t())}Qt(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}xt(t=0){const s=[];for(const i in this.Gt)s.push(this.Gt[i].Tt(t));for(const i of this.children)s.push(...i.xt(t));return s.filter(value=>value&&value.length)}Et(){const t=[];for(const s in this.Gt)t.push(this.Gt[s]);for(const s of this.children)t.push(...s.Et());return t}context(t=0){if(!this.it||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.gt(this.it.parentElement);for(;i&&i.ht===this.parent;)s.unshift(i.description(t)),i=this.gt(i.it.parentElement);return s.unshift(this.parent.context(t)),s.filter(value=>value&&value.length).join(this.router.et.scope)}ts(component){if("string"==typeof component){const t=this.router.rt.nt(runtime.CustomElementResource.ct(component));null!==t&&(component=t.lt(this.router.rt).ft)}return component}gt(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h in this.Gt){const o=this.Gt[h].it;let e=t,n=0;for(;e&&e!==o;)n++,e=e.parentElement;i>n&&(i=n,s=this.Gt[h])}return s}}class e{constructor(t){this.rt=t,this.ss=[],this.Gt={},this.yt=[],this.i=0,this.hs=0,this.os=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substr(1)),!s.startsWith("/")){const i=this.es(t.anchor).context();i&&(s=`/${i}${this.et.scope}${s}`)}this.ns.B(s)}),this.ns=new i,this.rs=new h}_(t){if(this.i)throw Error("Router has already been activated.");return this.i=1,this.options=Object.assign({W:t=>{this.cs(t).catch(t=>{throw t})}},t),this.et=Object.assign({viewport:"@",fs:"+",scope:"/",At:"!",ls:"=",add:"+",clear:"-",action:"."},this.options.et),this.rs._({W:this.os}),this.ns._(this.options).catch(t=>{throw t})}G(){if(!this.i)throw Error("Router has not been activated.");this.rs.G(),this.ns.G()}async cs(t){if(this.options.as&&this.options.as(t),t.v)return Promise.resolve();let s=0;(t.A||t.D)&&(t.path=t.L);const i=t.path;let h,o;(i===this.et.clear||i.startsWith(this.et.clear+this.et.add))&&(s=1,i.startsWith(this.et.clear)&&(t.path=i.substr(1)));let e=this.us(t);if(e){if(e.U)return e=this.ps(e,t.data),this.hs=1,this.ns.U(e.path,e.title,t.data),Promise.resolve();e.title&&(h=e.title),o=e.Gt}else o=this.ms(t);if(!o&&!Object.keys(o).length&&!s)return Promise.resolve();h&&this.ns.Y(h);const n=s?this.ws.Et().filter(value=>null!==value.component):[];let{Yt:r,Zt:c}=this.ws.Lt(o),f=100;for(;(r.length||c)&&f--;){const s=[];for(const i of r){const{component,viewport:h}=i;h.ot(component,t)&&s.push(h);const o=n.findIndex(value=>value===h);0>o||n.splice(o,1)}for(const i of n)i.ot(this.et.clear,t)&&s.push(i);!s.length&&this.hs&&(this.ns.cancel(),this.hs=0);let i=await Promise.all(s.map(value=>value.pt()));if(i.findIndex(value=>0==value)>=0)return this.ns.cancel(),Promise.resolve();if((i=await Promise.all(s.map(value=>value.bt()))).findIndex(value=>0==value)>=0)return this.ns.cancel(),Promise.resolve();i=await Promise.all(s.map(value=>value.$t()));const h=this.ws.Lt();r=h.Yt,c=h.Zt}this.bs()}us(t){return this.ss.find(value=>value.path===t.path)}ps(t,s){for(;t.U;){const i=this.us({path:t.U,L:t.U,data:s});if(!i)break;t=i}return t}ms(t){const s={};let i=t.path;i.startsWith("/")&&(i=i.substr(1));let h=i.split(this.et.fs),o=0;for(;h.length;){const t=h.shift().split(this.et.scope),parts=t.pop().split(this.et.viewport),component=parts[0];t.push(parts.length?parts.join(this.et.viewport):`?${o++}`);const name=t.join(this.et.scope);component&&(s[name]=component)}return s}ds(t){if(!this.ws){const t=this.rt.get(runtime.Aurelia).root().$s;this.ws=new Scope(this,t,null),this.yt.push(this.ws)}return this.es(t)}Bt(name,t,s){return this.ds(t).Bt(name,t,s)}Ft(t){const s=t.ht;s.Ft(t)||this.Rt(s)}Rt(t){if(t!==this.ws){t.Rt();const s=this.yt.indexOf(t);0>s||this.yt.splice(s,1)}}Ps(t){this.ss.push(t)}K(t,s,i){"string"==typeof t&&this.ns.K(t,s,i)}replace(t,s,i){"string"==typeof t&&this.ns.replace(t,s,i)}refresh(){this.ns.refresh()}back(){this.ns.back()}forward(){this.ns.forward()}es(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h of this.yt){let o=t,e=0;for(;o&&o!==h.it;)e++,o=o.parentElement;i>e&&(i=e,s=h)}return s}Os(t){let s=t.slice().sort((t,s)=>s.split(this.et.scope).length-t.split(this.et.scope).length),i=[];if((s=s.map(value=>`${this.et.scope}${value}${this.et.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.et.scope).length-s.split(this.et.scope).length),i}bs(){let t=this.ws.xt();t=this.Os(t);let s=this.ws.xt(1);(s=this.Os(s)).unshift(this.et.clear),this.ns.Z(t.join(this.et.fs),s.join(this.et.fs))}}e.inject=[kernel.IContainer];class n{constructor(router,t){this.router=router,this.it=t,this.name="default"}js(){const t={scope:this.it.hasAttribute("scope")};this._t&&this._t.length&&(t._t=this._t),this.viewport=this.router.Bt(this.name,this.it,t)}Ss(){this.router.Ft(this.viewport)}}return n.inject=[e,runtime.INode],s([runtime.bindable],n.prototype,"name",void 0),s([runtime.bindable],n.prototype,"scope",void 0),s([runtime.bindable],n.prototype,"usedBy",void 0),runtime.CustomElementResource.vs({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},n),t.Vs=n,t.Hs=i,t.ks=h,t.Ns=e,t.Scope=Scope,t.Cs=o,t})({},runtime,kernel);
