System.register("router",["@aurelia/runtime","@aurelia/kernel"],function(t){"use strict";var CustomElementResource,IDOM,IProjectorLocator,IRenderingEngine,LifecycleFlags,Aurelia,INode,bindable,PLATFORM,IContainer;return{t:[function(t){CustomElementResource=t.CustomElementResource,IDOM=t.IDOM,IProjectorLocator=t.IProjectorLocator,IRenderingEngine=t.IRenderingEngine,LifecycleFlags=t.LifecycleFlags,Aurelia=t.Aurelia,INode=t.INode,bindable=t.bindable},function(t){PLATFORM=t.PLATFORM,IContainer=t.IContainer}],s(){function s(t,s,i,h){var o,e,n=arguments.length,r=3>n?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.i)r=Reflect.i(t,s,i,h);else for(e=t.length-1;e>=0;e--)(o=t[e])&&(r=(3>n?o(r):n>3?o(s,i,r):o(s,i))||r);return n>3&&r&&Object.defineProperty(s,i,r),r}class i{constructor(){this.h=null,this.o=0,this.l=0,this.u=0,this.p=0,this.m=(()=>{const t=this.$(),s={};let i=this.P("HistoryEntry");if(this.h&&this.h.path===t){s.O=1;const t=this.u?this.S.index:this.history.length-this.j;this.S=this.h,this.S.index=t,this.u?(this.V=0,this.v[this.S.index]=this.S,this.l?(s.H=1,this.l=0):this.p?(s.k=1,this.p=0):s.C=1,this.u=0):(this.V=1,this.v=this.v.slice(0,this.S.index),this.v.push(this.S)),this.N({J:this.v,D:this.j,L:this.S})}else this.v=this.v||this.P("HistoryEntries")||[],this.j=this.j||this.P("HistoryOffset")||0,i||this.S?i?this.S?i.index>this.S.index?s.A=1:this.S.index>i.index&&(s.I=1):s.k=1:s.O=1:(s.O=1,s.T=1,this.j=this.history.length),i||(this.v=this.v.slice(0,(i={path:t,W:t,index:this.history.length-this.j}).index),this.v.push(i),this.N({J:this.v,D:this.j,L:i})),this.V=this.S?i.index-this.S.index:0,this.S=i,this.l&&(s.H=1,this.l=0);this.h=null,this._&&this._--,this.q(this.S,s)}),this.location=window.location,this.history=window.history}B(t){if(this.o)throw Error("History has already been activated.");return this.o=1,this.options=Object.assign({},t),window.addEventListener("popstate",this.m),Promise.resolve().then(()=>{this.G(this.$(),1)})}K(){window.removeEventListener("popstate",this.m),this.o=0}U(t,s,i){this.h={path:t,W:t,title:s,data:i},this.G(t)}replace(t,s,i){this.u=1,this.h={path:t,W:t,title:s,data:i},this.G(t,1)}X(t,s,i){this._=this.V+1,this.replace(t,s,i)}refresh(){this.S&&(this.p=1,this.replace(this.S.path,this.S.title,this.S.data))}back(){this.history.go(-1)}forward(){this.history.go(1)}cancel(){this.l=1;const t=this.V||this._;t?this.history.go(-t):this.replace(this.Y.path,this.Y.title,this.Y.data)}N(t,value){const{pathname:s,search:i,hash:h}=this.location;let o=Object.assign({},this.history.state);"string"==typeof t?o[t]=JSON.parse(JSON.stringify(value)):o=Object.assign({},o,JSON.parse(JSON.stringify(t))),this.history.replaceState(o,null,`${s}${i}${h}`)}P(t){return Object.assign({},this.history.state)[t]}Z(t){this.S.title=t,this.v[this.S.index]=this.S,this.N({J:this.v,L:this.S})}M(t,s){const i=`#/${t}`,{pathname:h,search:o,hash:e}=this.location;if(i===e)return;this.S.path=t,this.S.W=s;const n=Object.assign({},this.history.state,{L:this.S,J:this.v});this.history.replaceState(n,null,`${h}${o}${i}`)}R(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get F(){return this.v?this.v.slice(0,this.S.index+1).map(value=>value.title):[]}$(){return this.location.hash.substr(1)}G(t,s=0){if(this.S&&this.S.path===t&&!this.p)return;const{pathname:i,search:h}=this.location,o=`#${t}`;s?(this.Y=this.S,this.history.replaceState({},null,`${i}${h}${o}`)):this.history.pushState({},null,`${i}${h}${o}`),this.m()}q(t,s){const i=Object.assign({},t,s);this.options.q&&this.options.q(i)}}t("HistoryBrowser",i);class h{constructor(){this.o=0,this.g=(t=>{const s=h.tt(t);s.st&&(t.preventDefault(),this.options.q(s))}),this.document=document}static tt(t){const s={st:0,href:null,anchor:null},i=h.it(t.target);if(!i||!h.ht(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const o=i.getAttribute("href");return s.anchor=i,s.href=o,s.st=1===t.which,s}static it(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static ht(t){const s=t.getAttribute("target");return!s||s===h.window.name||"_self"===s}B(t){if(this.o)throw Error("LinkHandler has already been activated.");this.o=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.g,1)}K(){this.document.removeEventListener("click",this.g),this.o=0}}t("LinkHandler",h);class o{constructor(router,name,t,s,i,h){this.router=router,this.name=name,this.ot=t,this.et=s,this.scope=i,this.options=h,this.clear=0}nt(t,s){if(this.clear=0,"string"==typeof t)if(t===this.router.rt.clear)this.clear=1,t=null;else{const s=this.router.ft.ct(CustomElementResource.lt(t));null!==s&&(t=s.ut(this.router.ft).at)}return this.pt=t,this.wt=s,this.content!==t||s.k?1:0}bt(){if(!this.component)return Promise.resolve(1);const component=this.component;if(!component.bt)return Promise.resolve(1);const t=component.bt(this.dt,this.wt);return"boolean"==typeof t?Promise.resolve(t):t}$t(){if(this.clear)return Promise.resolve(1);if(!this.pt)return Promise.resolve(0);if(this.loadComponent(this.pt),!this.Pt)return Promise.resolve(0);const component=this.Pt;if(!component.$t)return Promise.resolve(1);const t=component.$t(this.wt,this.dt);return"boolean"==typeof t?Promise.resolve(t):t}async Ot(t){if(!this.ot&&(await this.St(50),!this.ot))return Promise.resolve(0);const host=this.ot,s=this.router.ft,dom=s.get(IDOM),i=s.get(IProjectorLocator),h=s.get(IRenderingEngine);return this.component&&(this.component.jt&&this.component.jt(this.dt,this.wt),this.component.Vt(LifecycleFlags.vt),this.component.Ht(LifecycleFlags.vt|LifecycleFlags.kt)),this.Pt&&(this.Pt.Ct&&this.Pt.Ct(this.wt,this.dt),this.Pt.Nt(dom,i,h,host,null),this.Pt.Jt(LifecycleFlags.Dt|LifecycleFlags.Lt,null),this.Pt.At(LifecycleFlags.Dt),this.content=this.pt,this.dt=this.wt,this.component=this.Pt),this.clear&&(this.content=this.component=null,this.dt=this.wt),this.pt=this.wt=this.Pt=null,Promise.resolve(1)}description(t=0){if(this.content){const component=this.content.description.name,s=this.scope?this.router.rt.It:"";if(t||s.length||this.options.Tt)return`${component}${this.router.rt.viewport}${this.name}${s}`;const i={};return i[component]=component,this.et.Wt(i)?component:`${component}${this.router.rt.viewport}${this.name}${s}`}}_t(t=0){return[this.et.context(t),this.description(t)].filter(value=>value&&value.length).join(this.router.rt.scope)}qt(component){let t=this.options.yt||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}zt(component){if("-"===component||null===component)return 1;let t=this.options.yt;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}loadComponent(component){this.Pt=this.router.ft.get(CustomElementResource.lt(component.description.name))}async St(t){return this.ot?Promise.resolve():t?(await this.Bt(100),this.St(--t)):Promise.resolve()}async Bt(t=0){await new Promise(s=>{PLATFORM.global.setTimeout(s,t)})}}t("Viewport",o);class Scope{constructor(router,t,s){this.router=router,this.ot=t,this.parent=s,this.children=[],this.Gt={},this.Kt={},this.parent&&this.parent.Qt(this)}Wt(t){const s=[];let i=0;t&&(this.Ut={},this.Kt={}),this.Ut=Object.assign({},this.Gt,this.Ut);for(const s in t){const parts=s.split(this.router.rt.scope),t=parts.shift();this.Kt[t]||(this.Kt[t]=[]),this.Kt[t].push(parts)}for(const h in this.Kt){const component=h.split(this.router.rt.viewport).shift();for(const name in this.Ut){const o=this.Ut[name];if(o&&o.qt(component)){const e=this.Xt(t,this.Kt,h,component,o);s.push(...e.Yt),i=i||e.Zt,this.Ut[name]=null,delete this.Kt[h];break}}}for(const h in this.Kt){const parts=h.split(this.router.rt.viewport),component=parts.shift();let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let o=0;name.endsWith(this.router.rt.It)&&(o=1,name=name.substr(0,name.length-1)),this.Gt[name]||(this.Mt(name,null,{scope:o,Tt:1}),this.Ut[name]=this.Gt[name]);const e=this.Ut[name];if(e&&e.zt(component)){const o=this.Xt(t,this.Kt,h,component,e);s.push(...o.Yt),i=i||o.Zt,this.Ut[name]=null,delete this.Kt[h]}}for(const h in this.Kt){const component=h.split(this.router.rt.viewport).shift(),o=[];for(const name in this.Ut){const t=this.Ut[name];t&&t.zt(component)&&o.push(t)}if(1===o.length){const e=o.shift(),n=this.Xt(t,this.Kt,h,component,e);s.push(...n.Yt),i=i||n.Zt,this.Ut[e.name]=null,delete this.Kt[h];break}}if(i=i||Object.keys(this.Kt).length>0,!t)for(const t of this.children){const h=t.Wt();s.push(...h.Yt),i=i||h.Zt}return{Yt:s,Zt:i}}Xt(t,s,i,component,h){const o=[{component,viewport:h}];let e=0;if(s[i].length){const n=h.scope||h.et;for(const h of s[i])if(h.length){const s=h.join(this.router.rt.scope),r={};r[s]=t[i+this.router.rt.scope+s];const c=n.Wt(r);o.push(...c.Yt),e=e||c.Zt}}return{Yt:o,Zt:e}}Mt(name,t,s){let i=this.Gt[name];if(!i){let h;s.scope&&(h=new Scope(this.router,t,this),this.router.Rt.push(h)),i=this.Gt[name]=new o(this.router,name,t,this,h,s)}return t&&(i.scope&&i.scope.parent&&!i.scope.viewport&&(i.scope.viewport=i),i.scope&&!i.scope.ot&&(i.scope.ot=t),i.ot||(i.ot=t,i.ot.children||this.xt(i).catch(t=>{throw t}))),i}Ft(t){return t.scope&&this.router.Et(t.scope),delete this.Gt[t.name],Object.keys(this.Gt).length}Et(){for(const t of this.children)t.Et();for(const t in this.Gt)this.router.Ft(this.Gt[t])}xt(t){return t.$t().then(()=>t.Ot())}Qt(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}gt(t=0){const s=[];for(const i in this.Gt)s.push(this.Gt[i]._t(t));for(const i of this.children)s.push(...i.gt(t));return s.filter(value=>value&&value.length)}ts(){const t=[];for(const s in this.Gt)t.push(this.Gt[s]);for(const s of this.children)t.push(...s.ts());return t}context(t=0){if(!this.ot||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.ss(this.ot.parentElement);for(;i&&i.et===this.parent;)s.unshift(i.description(t)),i=this.ss(i.ot.parentElement);return s.unshift(this.parent.context(t)),s.filter(value=>value&&value.length).join(this.router.rt.scope)}hs(component){if("string"==typeof component){const t=this.router.ft.ct(CustomElementResource.lt(component));null!==t&&(component=t.ut(this.router.ft).at)}return component}ss(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h in this.Gt){const o=this.Gt[h].ot;let e=t,n=0;for(;e&&e!==o;)n++,e=e.parentElement;i>n&&(i=n,s=this.Gt[h])}return s}}t("Scope",Scope);class e{constructor(t){this.ft=t,this.os=[],this.Gt={},this.Rt=[],this.o=0,this.es=0,this.ns=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substr(1)),!s.startsWith("/")){const i=this.rs(t.anchor).context();i&&(s=`/${i}${this.rt.scope}${s}`)}this.cs.R(s)}),this.cs=new i,this.fs=new h}B(t){if(this.o)throw Error("Router has already been activated.");return this.o=1,this.options=Object.assign({q:t=>{this.ls(t).catch(t=>{throw t})}},t),this.rt=Object.assign({viewport:"@",as:"+",scope:"/",It:"!",us:"=",add:"+",clear:"-",action:"."},this.options.rt),this.fs.B({q:this.ns}),this.cs.B(this.options).catch(t=>{throw t})}K(){if(!this.o)throw Error("Router has not been activated.");this.fs.K(),this.cs.K()}async ls(t){if(this.options.ps&&this.options.ps(t),t.H)return Promise.resolve();let s=0;(t.I||t.A)&&(t.path=t.W);const i=t.path;let h,o;(i===this.rt.clear||i.startsWith(this.rt.clear+this.rt.add))&&(s=1,i.startsWith(this.rt.clear)&&(t.path=i.substr(1)));let e=this.ms(t);if(e){if(e.X)return e=this.ws(e,t.data),this.es=1,this.cs.X(e.path,e.title,t.data),Promise.resolve();e.title&&(h=e.title),o=e.Gt}else o=this.bs(t);if(!o&&!Object.keys(o).length&&!s)return Promise.resolve();h&&this.cs.Z(h);const n=s?this.ds.ts().filter(value=>null!==value.component):[];let{Yt:r,Zt:c}=this.ds.Wt(o),f=100;for(;(r.length||c)&&f--;){const s=[];for(const i of r){const{component,viewport:h}=i;h.nt(component,t)&&s.push(h);const o=n.findIndex(value=>value===h);0>o||n.splice(o,1)}for(const i of n)i.nt(this.rt.clear,t)&&s.push(i);!s.length&&this.es&&(this.cs.cancel(),this.es=0);let i=await Promise.all(s.map(value=>value.bt()));if(i.findIndex(value=>0==value)>=0)return this.cs.cancel(),Promise.resolve();if((i=await Promise.all(s.map(value=>value.$t()))).findIndex(value=>0==value)>=0)return this.cs.cancel(),Promise.resolve();i=await Promise.all(s.map(value=>value.Ot()));const h=this.ds.Wt();r=h.Yt,c=h.Zt}this.$s()}ms(t){return this.os.find(value=>value.path===t.path)}ws(t,s){for(;t.X;){const i=this.ms({path:t.X,W:t.X,data:s});if(!i)break;t=i}return t}bs(t){const s={};let i=t.path;i.startsWith("/")&&(i=i.substr(1));let h=i.split(this.rt.as),o=0;for(;h.length;){const t=h.shift().split(this.rt.scope),parts=t.pop().split(this.rt.viewport),component=parts[0];t.push(parts.length?parts.join(this.rt.viewport):`?${o++}`);const name=t.join(this.rt.scope);component&&(s[name]=component)}return s}Ps(t){if(!this.ds){const t=this.ft.get(Aurelia).root().Os;this.ds=new Scope(this,t,null),this.Rt.push(this.ds)}return this.rs(t)}Mt(name,t,s){return this.Ps(t).Mt(name,t,s)}Ft(t){const s=t.et;s.Ft(t)||this.Et(s)}Et(t){if(t!==this.ds){t.Et();const s=this.Rt.indexOf(t);0>s||this.Rt.splice(s,1)}}Ss(t){this.os.push(t)}U(t,s,i){"string"==typeof t&&this.cs.U(t,s,i)}replace(t,s,i){"string"==typeof t&&this.cs.replace(t,s,i)}refresh(){this.cs.refresh()}back(){this.cs.back()}forward(){this.cs.forward()}rs(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h of this.Rt){let o=t,e=0;for(;o&&o!==h.ot;)e++,o=o.parentElement;i>e&&(i=e,s=h)}return s}js(t){let s=t.slice().sort((t,s)=>s.split(this.rt.scope).length-t.split(this.rt.scope).length),i=[];if((s=s.map(value=>`${this.rt.scope}${value}${this.rt.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.rt.scope).length-s.split(this.rt.scope).length),i}$s(){let t=this.ds.gt();t=this.js(t);let s=this.ds.gt(1);(s=this.js(s)).unshift(this.rt.clear),this.cs.M(t.join(this.rt.as),s.join(this.rt.as))}}t("Router",e),e.inject=[IContainer];class n{constructor(router,t){this.router=router,this.ot=t,this.name="default"}Vs(){const t={scope:this.ot.hasAttribute("scope")};this.yt&&this.yt.length&&(t.yt=this.yt),this.viewport=this.router.Mt(this.name,this.ot,t)}vs(){this.router.Ft(this.viewport)}}t("ViewportCustomElement",n),n.inject=[e,INode],s([bindable],n.prototype,"name",void 0),s([bindable],n.prototype,"scope",void 0),s([bindable],n.prototype,"usedBy",void 0),CustomElementResource.Hs({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},n)}}});
