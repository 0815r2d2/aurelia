function parseQuery(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const e=t.replace("+"," ").split("&");for(const t of e){const e=t.split("="),h=decodeURIComponent(e.shift());if(!e.length){i.push(h);continue}const value=decodeURIComponent(e.shift());s[h]=value}return{t:s,list:i}}function mergeParameters(t,s,i){const e=parseQuery(s),h=parseQuery(t),n=Object.assign({},e.t,h.t),r=[...e.list,...h.list];if(r.length&&i&&i.length)for(const t of i)n[t]=r.shift();let o;return r.length&&Object.keys(n).length&&(n["s"]=r.splice(0,r.length)),{i:n,h:r,o:o=r.length?r:n}}function closestCustomElement(t){for(;t&&!t.$customElement;)t=t.parentElement;return t}function __decorate(t,s,i,e){var h,n,r=arguments.length,o=3>r?s:null===e?e=Object.getOwnPropertyDescriptor(s,i):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,s,i,e);else for(n=t.length-1;n>=0;n--)(h=t[n])&&(o=(3>r?h(o):r>3?h(s,i,o):h(s,i))||o);return r>3&&o&&Object.defineProperty(s,i,o),o}import{Reporter,PLATFORM,buildQueryString,parseQueryString,IContainer,inject}from"@aurelia/kernel";import{IObserverLocator,CustomElementResource,Aurelia,IDOM,createRenderContext,INode,IRenderingEngine,bindable,customElement}from"@aurelia/runtime";class QueuedBrowserHistory{constructor(){this.l=(async t=>{await this.u(this,"popstate",[t])}),this.window=window,this.history=window.history,this.p=[],this.m=0,this.g=null,this.v=null}C(t){if(this.m)throw Reporter.error(2003);this.m=1,this.v=t,PLATFORM.R.add(this.S,this),this.window.addEventListener("popstate",this.l)}$(){this.window.removeEventListener("popstate",this.l),PLATFORM.R.remove(this.S,this),this.v=null,this.m=0}get length(){return this.history.length}get state(){return this.history.state}get V(){return this.history.V}async go(t){await this.u(this.history,"go",[t])}back(){return this.go(-1)}forward(){return this.go(1)}async pushState(t,s,i){await this.u(this.history,"pushState",[t,s,i])}async replaceState(t,s,i){await this.u(this.history,"replaceState",[t,s,i])}O(t){this.v(t)}u(t,s,i){let e;const h=new Promise(t=>{e=t});return this.p.push({target:t,H:s,t:i,resolve:e}),h}async S(t){if(!this.p.length||null!==this.g)return;this.g=this.p.shift();const s=this.g.target[this.g.H];Reporter.write(1e4,"DEQUEUE",this.g.H,this.g.t),s.apply(this.g.target,this.g.t);const i=this.g.resolve;this.g=null,i()}}class HistoryBrowser{constructor(){this.k=(async()=>{if(null!==this.N){Reporter.write(1e4,"=== ignore path change",this.P());const t=this.N;return this.N=null,void t()}const t=this.P(),s=this._();Reporter.write(1e4,"path changed to",t,this.j,this.I);const i={};let e,h=this.A("HistoryEntry");if(this.j&&this.j.path===t){i.L=1;const t=this.T?this.I.index:this.history.length-this.D;e=this.I,this.I=this.j,this.I.index=t,this.T?(this.B=0,this.q[this.I.index]=this.I,this.F?(i.G=1,this.F=0):this.M?(i.U=1,this.M=0):i.J=1,this.T=0):(this.B=1,this.q=this.q.slice(0,this.I.index),this.q.push(this.I)),await this.W({K:this.q,X:this.D,Y:this.I})}else this.q=this.q||this.A("HistoryEntries")||[],this.D=this.D||this.A("HistoryOffset")||0,h||this.I?h?this.I?h.index>this.I.index?i.Z=1:this.I.index>h.index&&(i.tt=1):i.U=1:i.L=1:(i.L=1,i.st=1,this.D=this.history.length),h||(h={path:t,it:null,index:this.history.length-this.D,et:s},i.st&&(h.ht=1),this.q=this.q.slice(0,h.index),this.q.push(h),await this.W({K:this.q,X:this.D,Y:h})),this.B=this.I?h.index-this.I.index:0,e=this.I,this.I=h,this.F&&(i.G=1,this.F=0);this.j=null,this.nt&&this.nt--,Reporter.write(1e4,"navigated",this.A("HistoryEntry"),this.q,this.A("HistoryOffset")),this.v(this.I,i,e)}),this.location=window.location,this.history=new QueuedBrowserHistory,this.I=null,this.q=null,this.D=null,this.rt=null,this.j=null,this.options=null,this.m=0,this.B=null,this.nt=null,this.F=0,this.T=0,this.M=0,this.N=null}C(t){if(this.m)throw Reporter.error(0);return this.m=1,this.options=Object.assign({},t),this.history.C(this.k),Promise.resolve().then(()=>{this.ot(this.P(),1).catch(t=>{throw t})})}$(){this.history.$(),this.m=0}at(t,s,i){return this.j={path:t,it:null,title:s,data:i},this.ot(t)}replace(t,s,i){return this.T=1,this.j={path:t,it:null,title:s,data:i},this.ot(t,1)}lt(t,s,i){return this.nt=this.B+1,this.replace(t,s,i)}async refresh(){if(this.I)return this.M=1,this.replace(this.I.path,this.I.title,this.I.data)}back(){return this.history.go(-1)}forward(){return this.history.go(1)}cancel(){this.F=1;const t=this.B||this.nt;return t?this.history.go(-t):this.replace(this.rt.path,this.rt.title,this.rt.data)}async pop(){let t,s=new Promise(t=>{this.N=t});await this.history.go(-1),await s;const i=""+this.location;if(!(t=this.history.state).Y.ht)return s=new Promise(t=>{this.N=t}),await this.history.go(-1),await s,this.history.pushState(t,null,i)}async W(t,value){const{pathname:s,search:i,hash:e}=this.location;let h=Object.assign({},this.history.state);return"string"==typeof t?h[t]=JSON.parse(JSON.stringify(value)):h=Object.assign({},h,JSON.parse(JSON.stringify(t))),this.history.replaceState(h,null,`${s}${i}${e}`)}A(t){return Object.assign({},this.history.state)[t]}ct(t){return this.I.title=t,this.q[this.I.index]=this.I,this.W({K:this.q,Y:this.I})}ut(t,s,i){if(i.index!==this.I.index)return;const e=`#/${t}`,{pathname:h,search:n,hash:r}=this.location;if(e===r&&this.I.path===t&&this.I.it===s)return;this.I.path=t,this.I.it=s;const o=Object.assign({},this.history.state,{Y:this.I,K:this.q});return this.history.replaceState(o,null,`${h}${n}${e}`)}ft(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get pt(){return this.q?this.q.slice(0,this.I.index+1).map(value=>value.title):[]}P(){return this.location.hash.substring(1).split("?")[0]}async ot(t,s=0){if(this.I&&this.I.path===t&&!this.M)return;const{pathname:i,search:e}=this.location,h=`#${t}`;return s?(this.rt=this.I,await this.history.replaceState({},null,`${i}${e}${h}`)):await this.history.pushState({},null,`${i}${e}${h}`),this.k()}_(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}v(t,s,i){const e=Object.assign({},t,s);e.dt=i,Reporter.write(1e4,"callback",t,s),this.options.v&&this.options.v(e)}}class LinkHandler{constructor(){this.m=0,this.wt=(t=>{const s=LinkHandler.gt(t);s.vt&&(t.preventDefault(),this.options.v(s))}),this.document=document}static gt(t){const s={vt:0,href:null,anchor:null},i=LinkHandler.yt(t.target);if(!i||!LinkHandler.Ct(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const e=i.getAttribute("href");return s.anchor=i,s.href=e,s.vt=1===t.which,s}static yt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static Ct(t){const s=t.getAttribute("target");return!s||s===LinkHandler.window.name||"_self"===s}C(t){if(this.m)throw Reporter.error(2004);this.m=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.wt,1)}$(){this.document.removeEventListener("click",this.wt,1),this.m=0}}class NavRoute{constructor(t,s){this.active="",this.bt=t,Object.assign(this,{Rt:s.Rt,title:s.title,children:null,St:s.St,active:""}),this.link=this.Et(this.Rt),this.$t=s.Vt?this.Et(s.Vt):this.link,this.Ot=this.bt.router.Ht.get(IObserverLocator),this.kt=this.Ot.Nt(0,this.bt.router,"activeComponents"),this.kt.subscribe(this)}get Pt(){return this.children&&this.children.length?"nav-has-children":""}_t(){this.active=this.link&&this.link.length?this.jt():"nav-active"===this.active?"nav-active":this.It()?"nav-active-child":""}jt(){const t=this.$t.split(this.bt.router.At.add),s=this.bt.router.xt;for(const component of t)if(0>component.indexOf(this.bt.router.At.viewport)){if(0>s.findIndex(value=>value.replace(/\@[^=]*/,"")===component))return""}else if(0>s.indexOf(component))return"";return"nav-active"}Lt(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}Et(t){return Array.isArray(t)?t.map(value=>this.Tt(value)).join(this.bt.router.At.Qt):this.Tt(t)}It(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.It())return 1;return 0}Tt(component){return component?"string"==typeof component?component:component.description?component.description.name:component.component?this.Tt(component.component)+(component.viewport?`@${component.viewport}`:""):void 0:""}}class Nav{constructor(router,name){this.router=router,this.name=name,this.Dt=[]}zt(t){for(const s of t)this.Bt(this.Dt,s)}Bt(t,s){const i=new NavRoute(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.Bt(i.children,t)}}}class HandlerEntry{constructor(t,s){this.wt=t,this.names=s}}class RouteGenerator{constructor(t,s){this.qt=t,this.Ft=s}}class TypesRecord{constructor(){this.Gt=0,this.Mt=0,this.Ut=0}}class RecognizeResult{constructor(t,s,i){this.wt=t,this.Jt=s,this.Wt=i}}class CharSpec{constructor(t,s,i){this.Kt=t,this.Xt=s,this.repeat=i}Yt(t){return this.Xt===t.Xt&&this.Kt===t.Kt}}class State{constructor(t){this.Zt=t,this.ts=[]}put(t){let s=this.ts.find(s=>s.Zt.Yt(t));return void 0===s&&(s=new State(t),this.ts.push(s),t.repeat&&s.ts.push(s)),s}}const specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],escapeRegex=RegExp(`(\\${specials.join("|\\")})`,"g");class StaticSegment{constructor(t,s){this.name=t,this.ss=t,this.es=s,this.optional=0}hs(t){const s=this.ss,i=s.length;let e=0,h="";if(this.es)for(;i>e;++e)h=s.charAt(e),t(new CharSpec(null,h,0));else for(;i>e;++e)h=s.charAt(e),t(new CharSpec(null,h.toUpperCase()+h.toLowerCase(),0))}ns(){return this.ss.replace(escapeRegex,"\\$1")}rs(t,s){return this.ss}}class DynamicSegment{constructor(name,optional){this.name=name,this.optional=optional}hs(t){t(new CharSpec("/",null,1))}ns(){return"([^/]+)"}rs(t,s){return s[this.name]=1,t[this.name]}}class StarSegment{constructor(name){this.name=name,this.optional=0}hs(t){t(new CharSpec("",null,1))}ns(){return"(.+)"}rs(t,s){return s[this.name]=1,t[this.name]}}class EpsilonSegment{hs(t){}ns(){return""}rs(t,s){return""}}class RouteRecognizer{constructor(){this.os=new State,this.names={},this.Dt=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.os;const i=[];let e="^";const h=new TypesRecord,n=[],r=t.wt.name;let o=1,a=t.path;"/"===a.charAt(0)&&(a=a.slice(1));const l=[],c=a.split("/");let u,f;for(let r=0,a=c.length;a>r;++r){let a=(u=c[r]).match(/^:([^?]+)(\?)?$/);if(a){const[,name,optional]=a;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);l.push(f=new DynamicSegment(name,!!optional)),n.push(name),h.Mt++}else if(a=u.match(/^\*(.+)$/))l.push(f=new StarSegment(a[1])),n.push(a[1]),h.Ut++;else{if(""===u){l.push(new EpsilonSegment);continue}l.push(f=new StaticSegment(u,t.es)),h.Gt++}const p=s.put(new CharSpec(null,"/",0));let d=p;f.hs(t=>{d=d.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].ts.push(p);f.optional?(i.push(d),e+=`(?:/${f.ns()})?`):(s=d,e+=`/${f.ns()}`,i.length=0,o=0)}o&&(s=s.put(new CharSpec(null,"/",0)),e+="/?");const p=[new HandlerEntry(t.wt,n)];if(this.Dt.set(t.wt,new RouteGenerator(l,p)),r){const t=Array.isArray(r)?r:[r];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new RouteGenerator(l,p))}for(let s=0;i.length>s;s++){const n=i[s];n.Ft=p,n.ns=RegExp(`${e}$`,t.es?"":"i"),n.types=h}return s.Ft=p,s.ns=RegExp(`${e}$`,t.es?"":"i"),s.types=h,s}as(t){return"string"==typeof t?this.names[t]:this.Dt.get(t)}ls(t){const s=this.as(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.Ft]}cs(t){return!!this.as(t)}rs(t,s){const i=this.as(t);if(!i)throw Error(`There is no route named ${t}`);const e=i.Ft[0].wt;if(e.us)return e.href;const h=Object.assign({},s),n=i.qt,r={};let o="";for(let s=0,i=n.length;i>s;s++){const i=n[s];if(i instanceof EpsilonSegment)continue;const e=i.rs(h,r);if(null==e){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else o+="/",o+=e}"/"!==o.charAt(0)&&(o=`/${o}`);for(const t in r)Reflect.deleteProperty(h,t);const a=buildQueryString(h);return o+(a?`?${a}`:"")}fs(t){let s=[this.os],i={},e=0,h=t;const n=h.indexOf("?");if(-1!==n){const t=h.slice(n+1);h=h.slice(0,n),i=parseQueryString(t)}"/"!==(h=decodeURI(h)).charAt(0)&&(h=`/${h}`);let r=h.length;r>1&&"/"===h.charAt(r-1)&&(h=h.slice(0,-1),e=1,--r);for(let t=0;r>t;++t){const i=[],e=h.charAt(t);if(s.forEach(t=>{t.ts.forEach(t=>{null!==t.Zt.Xt?-1!==t.Zt.Xt.indexOf(e)&&i.push(t):null!==t.Zt.Kt&&-1===t.Zt.Kt.indexOf(e)&&i.push(t)})}),0===(s=i).length)break}const o=[];for(let t=0,i=s.length;i>t;t++)s[t].Ft&&o.push(s[t]);o.sort((t,s)=>{if(t.types.Ut!==s.types.Ut)return t.types.Ut-s.types.Ut;if(t.types.Ut){if(t.types.Gt!==s.types.Gt)return s.types.Gt-t.types.Gt;if(t.types.Mt!==s.types.Mt)return s.types.Mt-t.types.Mt}return t.types.Mt!==s.types.Mt?t.types.Mt-s.types.Mt:t.types.Gt!==s.types.Gt?s.types.Gt-t.types.Gt:0});const a=o[0];if(a&&a.Ft){e&&"(.+)$"===a.ns.source.slice(-5)&&(h=`${h}/`);const t=h.match(a.ns);let s=1;const n=[];return n.ps=i,a.Ft.forEach(i=>{const e={};i.names.forEach(name=>{e[name]=t[s++]}),n.push(new RecognizeResult(i.wt,e,i.names.length>0))}),n}}}var ContentStatus;(function(t){t[t.ds=0]="none",t[t.loaded=1]="loaded",t[t.ms=2]="initialized",t[t.ws=3]="entered",t[t.gs=4]="added"})(ContentStatus||(ContentStatus={}));class ViewportContent{constructor(t=null,s=null,i=null,e=null){this.content=t,this.t=s,this.vs=i,this.component=null,this.ys=0,this.Cs=0,null!==this.content&&"string"==typeof this.content&&null!==e&&(this.content=this.bs(e))}Rs(t){return"string"==typeof t.content&&this.Ss()!==t.content||"string"!=typeof t.content&&this.content!==t.content||this.t!==t.t||!this.vs||this.vs.et!==t.vs.et}Es(t){return("string"==typeof t.content&&this.Ss()===t.content||"string"!=typeof t.content&&this.content===t.content)&&this.t===t.t}loadComponent(t,s){return this.Cs||(this.component=this.$s(t),this.component.Vs(0,t,s)),this.ys=1,Promise.resolve()}Os(){1===this.ys&&(this.ys=0)}Hs(){this.Cs||this.component.ks(2560,null),this.ys=2}Ns(t=0){2===this.ys&&(t||this.component.Ps(5120),this.ys=1)}addComponent(t){if(this.component._s(512),this.Cs){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)if(t.hasAttribute("au-element-scroll")){const[s,i]=t.getAttribute("au-element-scroll").split(",");t.removeAttribute("au-element-scroll"),t.scrollTo(+i,+s)}}this.ys=4}js(t,s=0){if(4===this.ys){if(s){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)(t.scrollTop>0||t.scrollLeft)&&t.setAttribute("au-element-scroll",`${t.scrollTop},${t.scrollLeft}`)}this.component.Is(1024),this.ys=4}}async As(t,s=0){switch(this.ys){case 4:this.js(t,s);case 3:this.component.xs&&await this.component.xs(),this.ys=2;case 2:this.Ns(s);case 1:this.Os()}this.ys=0}Ss(){return null===this.content?null:"string"==typeof this.content?this.content:this.content.description.name}bs(t){if(null===this.content)return null;if("string"!=typeof this.content)return this.content;{const s=t.get(IContainer),i=s.Ls(CustomElementResource.Ts(this.content));return null!==i?i.Ds(s).Qs:null}}$s(t){if(null===this.content)return null;const component=this.Ss();return t.get(IContainer).get("string"!=typeof component?component:CustomElementResource.Ts(component))}}class Viewport{constructor(router,name,t,s,i,e,h){this.router=router,this.name=name,this.zs=t,this.context=s,this.Bs=i,this.scope=e,this.options=h,this.clear=0,this.content=new ViewportContent,this.qs=null,this.Fs=null,this.Gs=null,this.cache=[],this.enabled=1}Ms(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.At.clear)this.clear=1,t=null;else{const s=t.split(this.router.At.t);t=s.shift(),i=s.length?s.join(this.router.At.t):null}if(this.qs=new ViewportContent(t,i,s,this.context),this.options.Us){const t=this.cache.find(t=>this.qs.Es(t));t?(this.qs=t,this.qs.Cs=1):this.cache.push(this.qs)}return this.content.Rs(this.qs)||s.U}Js(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.zs&&(this.scope.zs=t),this.zs!==t&&(this.Gs=Object.assign({},this),this.Ws(),this.zs=t,i&&i.Ks&&(this.options.Ks=i.Ks),i&&i.default&&(this.options.default=i.default),i&&i.Xs&&(this.options.Xs=i.Xs),i&&i.Ys&&(this.options.Ys=i.Ys),i&&i.Us&&(this.options.Us=i.Us),this.Fs&&this.Fs()),this.context!==s&&(this.context=s),this.content.component||this.qs&&this.qs.component||!this.options.default||this.router.Zs(this.options.default,this)}remove(t,s){return this.zs===t&&this.context===s?(this.content.component&&this.content.As(this.zs,this.options.Us).catch(t=>{throw t}),1):0}async ti(){if(!this.content.component)return 1;const component=this.content.component;return component.ti?(Reporter.write(1e4,"viewport canLeave",component.ti(this.content.vs,this.qs.vs)),component.ti(this.content.vs,this.qs.vs)):1}async si(){if(this.clear)return 1;if(!this.qs.content)return 0;if(await this.ii(),await this.qs.loadComponent(this.context,this.zs),!this.qs.component)return 0;const component=this.qs.component;if(!component.si)return 1;const t=component.si(this.qs.vs,this.content.vs);return Reporter.write(1e4,"viewport canEnter",t),"boolean"==typeof t?t:"string"==typeof t?[{component:t,viewport:this}]:t}async ei(){if(Reporter.write(1e4,"Viewport enter",this.name),this.clear)return 1;if(!this.qs.component)return 0;if(this.qs.component.ei){const t=mergeParameters(this.qs.t,this.qs.vs.et,this.qs.content.t);this.qs.vs.t=t.i,this.qs.vs.h=t.h,await this.qs.component.ei(t.o,this.qs.vs,this.content.vs),this.qs.ys=3}return this.qs.Hs(),1}async hi(){return Reporter.write(1e4,"Viewport loadContent",this.name),this.content.component&&(this.content.component.xs&&await this.content.component.xs(this.content.vs,this.qs.vs),this.qs.component||(this.content.js(this.zs,this.options.Us),this.content.Ns(this.options.Us),this.content.Os())),this.qs.component&&(this.content.component&&(this.content.js(this.zs,this.options.Us),this.content.Ns(this.options.Us),this.content.Os()),this.qs.addComponent(this.zs),this.content=this.qs),this.clear&&(this.content=new ViewportContent(null,null,this.qs.vs)),this.qs=null,1}ni(){this.Gs=null}async ri(){await this.qs.As(this.zs,this.options.Us),this.Gs&&Object.assign(this,this.Gs)}description(t=0){if(this.content.content){const component=this.content.Ss(),s=this.scope?this.router.At.oi:"",i=this.content.t?this.router.At.t+this.content.t:"";if(t||s.length||this.options.ai)return`${component}${this.router.At.viewport}${this.name}${s}${i}`;const e={};return e[component]=component,this.Bs.li(e)?`${component}${i}`:`${component}${this.router.At.viewport}${this.name}${s}${i}`}}ci(t=0){return[this.Bs.ui(t),this.description(t)].filter(value=>value&&value.length).join(this.router.At.scope)}fi(component){let t=this.options.Ks||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}pi(component){if("-"===component||null===component)return 1;let t=this.options.Ks;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}di(t){this.content.component&&this.content.Hs()}mi(t){Reporter.write(1e4,"ATTACHING viewport",this.name,this.content,this.qs),this.enabled=1,this.content.component&&this.content.addComponent(this.zs)}wi(t){Reporter.write(1e4,"DETACHING viewport",this.name),this.content.component&&this.content.js(this.zs,this.options.Us),this.enabled=0}gi(t){this.content.component&&this.content.Ns(this.options.Us)}Ws(){this.options={},this.content=new ViewportContent,this.cache=[]}async ii(){return this.zs?Promise.resolve():new Promise(t=>{this.Fs=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.zs=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.vi=[],this.yi={},this.Ci=null,this.parent&&this.parent.bi(this)}Ri(){return this.vi.filter(t=>t.enabled).reduce((t,s)=>(t[s.name]=s,t),{})}li(t){const s=[];let i=0;t&&(this.Ci={},this.yi={}),this.Ci=Object.assign({},this.Ri(),this.Ci);for(const s in t){const parts=s.split(this.router.At.scope),t=parts.shift();this.yi[t]||(this.yi[t]=[]),this.yi[t].push(parts)}for(const e in this.yi){const h=e.split(this.router.At.t),component=h.shift().split(this.router.At.viewport).shift(),n=component+(h.length?this.router.At.t+h.join(this.router.At.t):"");for(const name in this.Ci){const h=this.Ci[name];if(h&&h.fi(component)){const r=this.Si(t,this.yi,e,n,h);s.push(...r.Ei),i=i||r.$i,this.Ci[name]=null,Reflect.deleteProperty(this.yi,e);break}}}for(const e in this.yi){const h=e.split(this.router.At.t),parts=h.shift().split(this.router.At.viewport),component=parts.shift(),n=component+(h.length?this.router.At.t+h.join(this.router.At.t):"");let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let r=0;name.endsWith(this.router.At.oi)&&(r=1,name=name.substring(0,name.length-1)),this.Ri()[name]||(this.Vi(name,null,null,{scope:r,ai:1}),this.Ci[name]=this.Ri()[name]);const o=this.Ci[name];if(o&&o.pi(component)){const h=this.Si(t,this.yi,e,n,o);s.push(...h.Ei),i=i||h.$i,this.Ci[name]=null,Reflect.deleteProperty(this.yi,e)}}for(const e in this.yi){const h=e.split(this.router.At.t),component=h.shift().split(this.router.At.viewport).shift(),n=component+(h.length?this.router.At.t+h.join(this.router.At.t):""),r=[];for(const name in this.Ci){const t=this.Ci[name];t&&t.pi(component)&&r.push(t)}if(1===r.length){const h=r.shift(),o=this.Si(t,this.yi,e,n,h);s.push(...o.Ei),i=i||o.$i,this.Ci[h.name]=null,Reflect.deleteProperty(this.yi,e);break}}if(i=i||Object.keys(this.yi).length>0,!t)for(const t of this.children){const e=t.li();s.push(...e.Ei),i=i||e.$i}return{Ei:s,$i:i}}Si(t,s,i,component,e){const h=[{component,viewport:e}];let n=0;if(s[i].length){const r=e.scope||e.Bs;for(const e of s[i])if(e.length){const s=e.join(this.router.At.scope),o={};o[s]=t[i+this.router.At.scope+s];const a=r.li(o);h.push(...a.Ei),n=n||a.$i}}return{Ei:h,$i:n}}Vi(name,t,s,i){let e=this.Ri()[name];if(t&&e&&null!==e.zs&&e.zs!==t&&(e.enabled=0,(e=this.vi.find(s=>s.name===name&&s.zs===t))&&(e.enabled=1)),!e){let h;i.scope&&(h=new Scope(this.router,t,s,this),this.router.Oi.push(h)),e=new Viewport(this.router,name,null,null,this,h,i),this.vi.push(e)}return(t||s)&&e.Js(t,s,i),e}Hi(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.ki(t.scope),this.vi.splice(this.vi.indexOf(t),1)),Object.keys(this.vi).length}ki(){for(const t of this.children)t.ki();const t=this.Ri();for(const name in t)this.router.Hi(t[name],null,null)}Ni(t){return t.si().then(()=>t.hi())}bi(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Pi(t=0,s=0){const i=[];for(const e in this.Ri()){const h=this.Ri()[e];(h.options.Ys||h.options.Xs&&!t)&&!s||i.push(h.ci(t))}for(const s of this.children)i.push(...s.Pi(t));return i.filter(value=>value&&value.length)}_i(){const t=this.vi.filter(t=>t.enabled);for(const s of this.children)t.push(...s._i());return t}ui(t=0){if(!this.zs||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.ji(this.context.get(IContainer).parent);for(;i&&i.Bs===this.parent;)s.unshift(i.description(t)),i=this.ji(i.context.get(IContainer).parent);return s.unshift(this.parent.ui(t)),s.filter(value=>value&&value.length).join(this.router.At.scope)}ji(t){const s=Object.values(this.Ri());for(;t;){const i=s.find(s=>s.context.get(IContainer)===t);if(i)return i;t=t.parent}return null}}class Router{constructor(t){this.Ht=t,this.Oi=[],this.Ii={},this.xt=[],this.Ai=[],this.m=0,this.xi=0,this.Li=[],this.Ti=null,this.Qi=null,this.Di=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.zi(t.anchor).ui();i&&(s=`/${i}${this.At.scope}${s}`)}this.Bi.ft(s)}),this.Bi=new HistoryBrowser,this.qi=new LinkHandler}get Fi(){return null!==this.Ti}C(t){if(this.m)throw Reporter.error(2001);return this.m=1,this.options=Object.assign({v:t=>{this.Gi(t)}},t),this.At=Object.assign({viewport:"@",Qt:"+",scope:"/",oi:"!",t:"=",add:"+",clear:"-",action:"."},this.options.At),this.qi.C({v:this.Di}),this.Bi.C(this.options).catch(t=>{throw t})}$(){if(!this.m)throw Reporter.error(2e3);this.qi.$(),this.Bi.$()}Gi(t){this.Li.push(t),this.Mi().catch(t=>{throw t})}async Mi(){if(null!==this.Ti||!this.Li.length)return Promise.resolve();const t=this.Li.shift();if(this.Ti=t,this.options.Ui&&this.options.Ui(t),t.G)return this.Ti=null,this.Mi();let s=0,i=0;(t.tt||t.Z)&&t.it&&(t.path=t.it,i=1);let e=t.path;this.options.Ji&&!i&&(e=this.options.Ji(e,this),Array.isArray(e)&&(e=this.Wi(e))),(e===this.At.clear||e.startsWith(this.At.clear+this.At.add))&&(s=1,e.startsWith(this.At.clear)&&(e=e.substring(1)));const h=parseQuery(t.et);t.t=h.t,t.h=h.list;const n=this.Ki(e);if(!n&&!Object.keys(n).length&&!s)return this.Ti=null,this.Mi();const r=s?this._i().filter(value=>null!==value.content.component):[],o=this._i().filter(value=>value.options.default&&null===value.content.component),a=[];let{Ei:l,$i:c}=this.Xi.li(n),u=100;for(;l.length||c||o.length;){if(!u--)throw Reporter.error(2002);const s=[];for(const i of l){const{component,viewport:e}=i;e.Ms(component,t)&&s.push(e);const h=r.findIndex(value=>value===e);0>h||r.splice(h,1);const n=o.findIndex(value=>value===e);0>n||o.splice(n,1)}for(const i of r)i.Ms(this.At.clear,t)&&s.push(i);let i;for(;i=o.shift();)i.Ms(i.options.default,t)&&s.push(i);if(!s.length&&this.xi){const i=this.Yi([...s,...a],t);return this.xi=0,await this.Mi(),i}let e=await Promise.all(s.map(value=>value.ti()));if(e.findIndex(value=>0==value)>=0)return this.Yi([...s,...a],t);if((e=await Promise.all(s.map(async value=>{const t=await value.si();if("boolean"==typeof t)return t?value.ei():0;for(const s of t)this.Zs(s.component,s.viewport);return value.ri().catch(t=>{throw t}),1}))).some(t=>0==t))return this.Yi([...s,...a],t);for(const t of s)a.find(value=>value===t)||a.push(t);const h=this.Xi.li();let n;for(l=[];n=this.Ai.shift();)h.Ei.find(value=>value.viewport===n.viewport)||l.push(n);l=[...l,...h.Ei],c=h.$i}await Promise.all(a.map(value=>value.hi())),await this.Zi(t),t.st||t.te||!a.every(t=>t.options.Ys)||await this.Bi.pop(),a.forEach(t=>{t.ni()}),this.Qi=this.Ti,this.Qi.te&&(this.Qi.te=0),this.Ti=null,this.Mi().catch(t=>{throw t})}Zs(component,t){this.Ti?("string"==typeof t&&(t=this._i().find(s=>s.name===t)),this.Ai.push({viewport:t,component})):this.Qi&&(this.Li.unshift({path:"",it:"",te:1}),this.Mi().catch(t=>{throw t}))}Ki(t){const s={};t.startsWith("/")&&(t=t.substring(1));const i=t.split(this.At.Qt);let e=0;for(;i.length;){const t=i.shift().split(this.At.scope),parts=t.pop().split(this.At.viewport),component=parts[0];t.push(parts.length?parts.join(this.At.viewport):`?${e++}`);const name=t.join(this.At.scope);component&&(s[name]=component)}return s}se(t){return this.ie(),this.zi(t)}Vi(name,t,s,i){return Reporter.write(1e4,"Viewport added",name,t),this.se(t).Vi(name,t,s,i)}Hi(t,s,i){const e=t.Bs;e.Hi(t,s,i)||this.ki(e)}_i(){return this.ie(),this.Xi._i()}ki(t){if(t!==this.Xi){t.ki();const s=this.Oi.indexOf(t);0>s||this.Oi.splice(s,1)}}at(t,s,i){if("string"==typeof t)return this.Bi.at(t,s,i)}replace(t,s,i){if("string"==typeof t)return this.Bi.replace(t,s,i)}refresh(){return this.Bi.refresh()}back(){return this.Bi.back()}forward(){return this.Bi.forward()}Wi(t){const s=[];for(const i of t){let t=i.component;if(i.viewport&&(t+=this.At.viewport+i.viewport),i.t)for(const s in i.t)t+=this.At.t+i.t[s];s.push(t)}return s.join(this.At.Qt)}ee(t){const s=[],i=t.split(this.At.Qt);for(const t of i){let component,i,e;const[h,n]=t.split(this.At.viewport);void 0===n?[component,e]=h.split(this.At.t):(component=h,[i,e]=n.split(this.At.t));const r={component};i&&(r.viewport=i),e&&(r.t={id:e}),s.push(r)}return s}he(name,t){const s=this.ne(name);s&&(s.Dt=[]),this.re(name,t)}re(name,t){let s=this.Ii[name];s||(s=this.Ii[name]=new Nav(this,name)),s.zt(t)}ne(name){return this.Ii[name]}async Yi(t,s){t.forEach(t=>{t.ri().catch(t=>{throw t})}),s.L?await this.Bi.pop():await this.Bi.cancel(),this.Ti=null,this.Mi().catch(t=>{throw t})}ie(){if(!this.Xi){const t=this.Ht.get(Aurelia).root();this.Xi=new Scope(this,t.oe,t.$context,null),this.Oi.push(this.Xi)}}zi(t){let s=closestCustomElement(t).$customElement.$context.get(IContainer);for(;s;){const t=this.Oi.find(t=>t.context.get(IContainer)===s);if(t)return t;s=s.parent}}ae(t){let s=t.slice().sort((t,s)=>s.split(this.At.scope).length-t.split(this.At.scope).length),i=[];if((s=s.map(value=>`${this.At.scope}${value}${this.At.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.At.scope).length-s.split(this.At.scope).length),i}Zi(t){this.xt=this.Xi.Pi(1,1),this.xt=this.ae(this.xt);let s=this.Xi.Pi(),i=(s=this.ae(s)).join(this.At.Qt);this.options.le&&(i=this.options.le(this.ee(i),this));let e=this.Xi.Pi(1);(e=this.ae(e)).unshift(this.At.clear);const h=t.et&&t.et.length?`?${t.et}`:"";return this.Bi.ut(i+h,e.join(this.At.Qt)+h,t)}}Router.inject=[IContainer];class ViewportCustomElement{constructor(router,t,s){this.router=router,this.zs=t,this.ce=s,this.name="default",this.scope=null,this.Ks=null,this.default=null,this.Xs=null,this.Ys=null,this.Us=null,this.viewport=null}ue(t,host,parts,s){const i=this.constructor,dom=s.get(IDOM),template=this.ce.fe(dom,i.description,s,i);template.pe=createRenderContext(dom,s,i.description.dependencies,i),template.ue(this,host,parts)}bound(){this.connect()}de(){this.disconnect()}connect(){const t={scope:this.zs.hasAttribute("scope")};this.Ks&&this.Ks.length&&(t.Ks=this.Ks),this.default&&this.default.length&&(t.default=this.default),this.zs.hasAttribute("no-link")&&(t.Xs=1),this.zs.hasAttribute("no-history")&&(t.Ys=1),this.zs.hasAttribute("stateful")&&(t.Us=1),this.viewport=this.router.Vi(this.name,this.zs,this.$context,t)}disconnect(){this.router.Hi(this.viewport,this.zs,this.$context)}di(t){this.viewport&&this.viewport.di(t)}mi(t){this.viewport&&this.viewport.mi(t)}wi(t){this.viewport&&this.viewport.wi(t)}gi(t){this.viewport&&this.viewport.gi(t)}}ViewportCustomElement.inject=[Router,INode,IRenderingEngine],__decorate([bindable],ViewportCustomElement.prototype,"name",void 0),__decorate([bindable],ViewportCustomElement.prototype,"scope",void 0),__decorate([bindable],ViewportCustomElement.prototype,"usedBy",void 0),__decorate([bindable],ViewportCustomElement.prototype,"default",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noLink",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noHistory",void 0),__decorate([bindable],ViewportCustomElement.prototype,"stateful",void 0),CustomElementResource.me({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},ViewportCustomElement);let NavCustomElement=class{constructor(router){this.router=router,this.name=null,this.Dt=null,this.level=0}get we(){const t=this.router.ne(this.name);return t?t.Dt:[]}active(t){return"Active"}};__decorate([bindable],NavCustomElement.prototype,"name",void 0),__decorate([bindable],NavCustomElement.prototype,"routes",void 0),__decorate([bindable],NavCustomElement.prototype,"level",void 0),NavCustomElement=__decorate([inject(Router,Element),customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],NavCustomElement);export{HistoryBrowser,LinkHandler,Nav,QueuedBrowserHistory,HandlerEntry,RouteGenerator,TypesRecord,RecognizeResult,CharSpec,State,StaticSegment,DynamicSegment,StarSegment,EpsilonSegment,RouteRecognizer,Router,Scope,Viewport,ViewportCustomElement,NavCustomElement};
