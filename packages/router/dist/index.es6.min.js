function parseQuery(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const e=t.replace("+"," ").split("&");for(const t of e){const e=t.split("="),h=decodeURIComponent(e.shift());if(!e.length){i.push(h);continue}const value=decodeURIComponent(e.shift());s[h]=value}return{t:s,list:i}}function mergeParameters(t,s,i){const e=parseQuery(s),h=parseQuery(t),n=Object.assign({},e.t,h.t),r=[...e.list,...h.list];if(r.length&&i&&i.length)for(const t of i)n[t]=r.shift();let o;return r.length&&Object.keys(n).length&&(n["s"]=r.splice(0,r.length)),{i:n,h:r,o:o=r.length?r:n}}function closestCustomElement(t){for(;t&&!t.$customElement;)t=t.parentElement;return t}function __decorate(t,s,i,e){var h,n,r=arguments.length,o=3>r?s:null===e?e=Object.getOwnPropertyDescriptor(s,i):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,s,i,e);else for(n=t.length-1;n>=0;n--)(h=t[n])&&(o=(3>r?h(o):r>3?h(s,i,o):h(s,i))||o);return r>3&&o&&Object.defineProperty(s,i,o),o}import{IObserverLocator,LifecycleFlags,CustomElementResource,Aurelia,IDOM,createRenderContext,INode,IRenderingEngine,bindable,customElement}from"@aurelia/runtime";import{buildQueryString,parseQueryString,IContainer,inject}from"@aurelia/kernel";class HistoryBrowser{constructor(){this.l=(()=>{if(null!==this.u){const t=this.u;return this.u=null,void t()}const t=this.p(),s=this.m(),i={};let e,h=this.v("HistoryEntry");if(this.g&&this.g.path===t){i.C=1;const t=this.$?this.R.index:this.history.length-this.S;e=this.R,this.R=this.g,this.R.index=t,this.$?(this.O=0,this.H[this.R.index]=this.R,this.k?(i.V=1,this.k=0):this.P?(i.j=1,this.P=0):i.I=1,this.$=0):(this.O=1,this.H=this.H.slice(0,this.R.index),this.H.push(this.R)),this.N({_:this.H,L:this.S,F:this.R})}else this.H=this.H||this.v("HistoryEntries")||[],this.S=this.S||this.v("HistoryOffset")||0,h||this.R?h?this.R?h.index>this.R.index?i.A=1:this.R.index>h.index&&(i.T=1):i.j=1:i.C=1:(i.C=1,i.D=1,this.S=this.history.length),h||(this.H=this.H.slice(0,(h={path:t,B:null,index:this.history.length-this.S,G:s}).index),this.H.push(h),this.N({_:this.H,L:this.S,F:h})),this.O=this.R?h.index-this.R.index:0,e=this.R,this.R=h,this.k&&(i.V=1,this.k=0);this.g=null,this.J&&this.J--,this.q(this.R,i,e)}),this.location=window.location,this.history=window.history,this.R=null,this.H=null,this.S=null,this.M=null,this.g=null,this.options=null,this.U=0,this.O=null,this.J=null,this.k=0,this.$=0,this.P=0,this.u=null}W(t){if(this.U)throw Error("History has already been activated.");return this.U=1,this.options=Object.assign({},t),window.addEventListener("popstate",this.l),Promise.resolve().then(()=>{this.K(this.p(),1)})}X(){window.removeEventListener("popstate",this.l),this.U=0}Y(t,s,i){this.g={path:t,B:null,title:s,data:i},this.K(t)}replace(t,s,i){this.$=1,this.g={path:t,B:null,title:s,data:i},this.K(t,1)}Z(t,s,i){this.J=this.O+1,this.replace(t,s,i)}refresh(){this.R&&(this.P=1,this.replace(this.R.path,this.R.title,this.R.data))}back(){this.history.go(-1)}forward(){this.history.go(1)}cancel(){this.k=1;const t=this.O||this.J;t?this.history.go(-t):this.replace(this.M.path,this.M.title,this.M.data)}async pop(){let t,s=new Promise(t=>{this.u=t});this.history.go(-1),await s;const i=""+this.location;t=this.history.state,s=new Promise(t=>{this.u=t}),this.history.go(-1),await s,this.history.pushState(t,null,i)}N(t,value){const{pathname:s,search:i,hash:e}=this.location;let h=Object.assign({},this.history.state);"string"==typeof t?h[t]=JSON.parse(JSON.stringify(value)):h=Object.assign({},h,JSON.parse(JSON.stringify(t))),this.history.replaceState(h,null,`${s}${i}${e}`)}v(t){return Object.assign({},this.history.state)[t]}tt(t){this.R.title=t,this.H[this.R.index]=this.R,this.N({_:this.H,F:this.R})}st(t,s,i){if(i.index!==this.R.index)return;const e=`#/${t}`,{pathname:h,search:n,hash:r}=this.location;if(e===r&&this.R.path===t&&this.R.B===s)return;this.R.path=t,this.R.B=s;const o=Object.assign({},this.history.state,{F:this.R,_:this.H});this.history.replaceState(o,null,`${h}${n}${e}`)}it(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get et(){return this.H?this.H.slice(0,this.R.index+1).map(value=>value.title):[]}p(){return this.location.hash.substring(1).split("?")[0]}K(t,s=0){if(this.R&&this.R.path===t&&!this.P)return;const{pathname:i,search:e}=this.location,h=`#${t}`;s?(this.M=this.R,this.history.replaceState({},null,`${i}${e}${h}`)):this.history.pushState({},null,`${i}${e}${h}`),this.l()}m(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}q(t,s,i){const e=Object.assign({},t,s);e.ht=i,this.options.q&&this.options.q(e)}}class LinkHandler{constructor(){this.U=0,this.nt=(t=>{const s=LinkHandler.rt(t);s.ot&&(t.preventDefault(),this.options.q(s))}),this.document=document}static rt(t){const s={ot:0,href:null,anchor:null},i=LinkHandler.lt(t.target);if(!i||!LinkHandler.ct(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const e=i.getAttribute("href");return s.anchor=i,s.href=e,s.ot=1===t.which,s}static lt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static ct(t){const s=t.getAttribute("target");return!s||s===LinkHandler.window.name||"_self"===s}W(t){if(this.U)throw Error("LinkHandler has already been activated.");this.U=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.nt,1)}X(){this.document.removeEventListener("click",this.nt,1),this.U=0}}class NavRoute{constructor(t,s){this.active="",this.at=t,Object.assign(this,{ut:s.ut,title:s.title,children:null,ft:s.ft,active:""}),this.link=this.dt(this.ut),this.pt=s.vt?this.dt(s.vt):this.link,this.wt=this.at.router.gt.get(IObserverLocator),this.yt=this.wt.bt(LifecycleFlags.Ct,this.at.router,"activeComponents"),this.yt.subscribe(this)}get $t(){return this.children&&this.children.length?"nav-has-children":""}Et(){this.active=this.link&&this.link.length?this.Rt():"nav-active"===this.active?"nav-active":this.St()?"nav-active-child":""}Rt(){const t=this.pt.split(this.at.router.Ot.add),s=this.at.router.Ht;for(const component of t)if(0>component.indexOf(this.at.router.Ot.viewport)){if(0>s.findIndex(value=>value.replace(/\@[^=]*/,"")===component))return""}else if(0>s.indexOf(component))return"";return"nav-active"}kt(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}dt(t){return Array.isArray(t)?t.map(value=>this.Vt(value)).join(this.at.router.Ot.Pt):this.Vt(t)}St(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.St())return 1;return 0}Vt(component){return component?"string"==typeof component?component:component.description?component.description.name:component.component?this.Vt(component.component)+(component.viewport?`@${component.viewport}`:""):void 0:""}}class Nav{constructor(router,name){this.router=router,this.name=name,this.jt=[]}It(t){for(const s of t)this.Nt(this.jt,s)}Nt(t,s){const i=new NavRoute(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.Nt(i.children,t)}}}class HandlerEntry{constructor(t,s){this.nt=t,this.names=s}}class RouteGenerator{constructor(t,s){this._t=t,this.Lt=s}}class TypesRecord{constructor(){this.xt=0,this.Ft=0,this.At=0}}class RecognizeResult{constructor(t,s,i){this.nt=t,this.Tt=s,this.zt=i}}class CharSpec{constructor(t,s,i){this.Dt=t,this.Qt=s,this.repeat=i}Bt(t){return this.Qt===t.Qt&&this.Dt===t.Dt}}class State{constructor(t){this.Gt=t,this.Jt=[]}put(t){let s=this.Jt.find(s=>s.Gt.Bt(t));return void 0===s&&(s=new State(t),this.Jt.push(s),t.repeat&&s.Jt.push(s)),s}}const specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],escapeRegex=RegExp(`(\\${specials.join("|\\")})`,"g");class StaticSegment{constructor(t,s){this.name=t,this.qt=t,this.Mt=s,this.optional=0}Ut(t){const s=this.qt,i=s.length;let e=0,h="";if(this.Mt)for(;i>e;++e)h=s.charAt(e),t(new CharSpec(null,h,0));else for(;i>e;++e)h=s.charAt(e),t(new CharSpec(null,h.toUpperCase()+h.toLowerCase(),0))}Wt(){return this.qt.replace(escapeRegex,"\\$1")}Kt(t,s){return this.qt}}class DynamicSegment{constructor(name,optional){this.name=name,this.optional=optional}Ut(t){t(new CharSpec("/",null,1))}Wt(){return"([^/]+)"}Kt(t,s){return s[this.name]=1,t[this.name]}}class StarSegment{constructor(name){this.name=name,this.optional=0}Ut(t){t(new CharSpec("",null,1))}Wt(){return"(.+)"}Kt(t,s){return s[this.name]=1,t[this.name]}}class EpsilonSegment{Ut(t){}Wt(){return""}Kt(t,s){return""}}class RouteRecognizer{constructor(){this.Xt=new State,this.names={},this.jt=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.Xt;const i=[];let e="^";const h=new TypesRecord,n=[],r=t.nt.name;let o=1,l=t.path;"/"===l.charAt(0)&&(l=l.slice(1));const c=[],a=l.split("/");let u,f;for(let r=0,l=a.length;l>r;++r){let l=(u=a[r]).match(/^:([^?]+)(\?)?$/);if(l){const[,name,optional]=l;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);c.push(f=new DynamicSegment(name,!!optional)),n.push(name),h.Ft++}else if(l=u.match(/^\*(.+)$/))c.push(f=new StarSegment(l[1])),n.push(l[1]),h.At++;else{if(""===u){c.push(new EpsilonSegment);continue}c.push(f=new StaticSegment(u,t.Mt)),h.xt++}const d=s.put(new CharSpec(null,"/",0));let p=d;f.Ut(t=>{p=p.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].Jt.push(d);f.optional?(i.push(p),e+=`(?:/${f.Wt()})?`):(s=p,e+=`/${f.Wt()}`,i.length=0,o=0)}o&&(s=s.put(new CharSpec(null,"/",0)),e+="/?");const d=[new HandlerEntry(t.nt,n)];if(this.jt.set(t.nt,new RouteGenerator(c,d)),r){const t=Array.isArray(r)?r:[r];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new RouteGenerator(c,d))}for(let s=0;i.length>s;s++){const n=i[s];n.Lt=d,n.Wt=RegExp(`${e}$`,t.Mt?"":"i"),n.types=h}return s.Lt=d,s.Wt=RegExp(`${e}$`,t.Mt?"":"i"),s.types=h,s}Yt(t){return"string"==typeof t?this.names[t]:this.jt.get(t)}Zt(t){const s=this.Yt(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.Lt]}ts(t){return!!this.Yt(t)}Kt(t,s){const i=this.Yt(t);if(!i)throw Error(`There is no route named ${t}`);const e=i.Lt[0].nt;if(e.ss)return e.href;const h=Object.assign({},s),n=i._t,r={};let o="";for(let s=0,i=n.length;i>s;s++){const i=n[s];if(i instanceof EpsilonSegment)continue;const e=i.Kt(h,r);if(null==e){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else o+="/",o+=e}"/"!==o.charAt(0)&&(o=`/${o}`);for(const t in r)Reflect.deleteProperty(h,t);const l=buildQueryString(h);return o+(l?`?${l}`:"")}es(t){let s=[this.Xt],i={},e=0,h=t;const n=h.indexOf("?");if(-1!==n){const t=h.slice(n+1);h=h.slice(0,n),i=parseQueryString(t)}"/"!==(h=decodeURI(h)).charAt(0)&&(h=`/${h}`);let r=h.length;r>1&&"/"===h.charAt(r-1)&&(h=h.slice(0,-1),e=1,--r);for(let t=0;r>t;++t){const i=[],e=h.charAt(t);if(s.forEach(t=>{t.Jt.forEach(t=>{null!==t.Gt.Qt?-1!==t.Gt.Qt.indexOf(e)&&i.push(t):null!==t.Gt.Dt&&-1===t.Gt.Dt.indexOf(e)&&i.push(t)})}),0===(s=i).length)break}const o=[];for(let t=0,i=s.length;i>t;t++)s[t].Lt&&o.push(s[t]);o.sort((t,s)=>{if(t.types.At!==s.types.At)return t.types.At-s.types.At;if(t.types.At){if(t.types.xt!==s.types.xt)return s.types.xt-t.types.xt;if(t.types.Ft!==s.types.Ft)return s.types.Ft-t.types.Ft}return t.types.Ft!==s.types.Ft?t.types.Ft-s.types.Ft:t.types.xt!==s.types.xt?s.types.xt-t.types.xt:0});const l=o[0];if(l&&l.Lt){e&&"(.+)$"===l.Wt.source.slice(-5)&&(h=`${h}/`);const t=h.match(l.Wt);let s=1;const n=[];return n.hs=i,l.Lt.forEach(i=>{const e={};i.names.forEach(name=>{e[name]=t[s++]}),n.push(new RecognizeResult(i.nt,e,i.names.length>0))}),n}}}class Viewport{constructor(router,name,t,s,i,e,h){this.router=router,this.name=name,this.ns=t,this.context=s,this.rs=i,this.scope=e,this.options=h,this.clear=0,this.content=null,this.os=null,this.t=null,this.ls=null,this.cs=null,this.as=null,this.component=null,this.us=null,this.fs=null,this.ds=null,this.ps=0}ms(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.Ot.clear)this.clear=1,t=null;else{const s=t.split(this.router.Ot.t);t=s.shift(),i=s.length?s.join(this.router.Ot.t):null,this.context&&(t=this.vs(t))}return this.os=t,this.as=s,this.ls=i,this.ps=0,"string"==typeof t&&this.ws(this.content)!==t||"string"!=typeof t&&this.content!==t||this.t!==i||!this.cs||this.cs.G!==s.G||s.j?1:0}gs(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.ns&&(this.scope.ns=t),this.ns!==t&&(this.ds=Object.assign({},this),this.ys(),this.ns=t,i&&i.bs&&(this.options.bs=i.bs),i&&i.default&&(this.options.default=i.default),i&&i.Cs&&(this.options.Cs=i.Cs),i&&i.$s&&(this.options.$s=i.$s),this.fs&&this.fs()),this.context!==s&&(this.context=s),this.component||this.us||!this.options.default||this.router.Es(this,this.options.default)}remove(t,s){return this.ns===t&&this.context===s}async Rs(){if(!this.component)return 1;const component=this.component;return component.Rs?component.Rs(this.cs,this.as):1}async Ss(){if(this.clear)return 1;if(!this.os)return 0;if(await this.loadComponent(this.os),!this.us)return 0;const component=this.us;return component.Ss?component.Ss(this.as,this.cs):1}async Os(){if(this.clear)return 1;if(!this.us)return 0;if(this.us.Os){const t=mergeParameters(this.ls,this.as.G,this.os.t);this.as.t=t.i,this.as.h=t.h,await this.us.Os(t.o,this.as,this.cs),this.ps=0}return this.Hs(this.us),1}async ks(){return this.component&&(this.component.Vs&&await this.component.Vs(this.cs,this.as),this.us||(this.Ps(this.component),this.js(this.component),this.Is(this.component))),this.us&&(this.component&&(this.Ps(this.component),this.js(this.component),this.Is(this.component)),this.addComponent(this.us),this.content=this.os,this.t=this.ls,this.cs=this.as,this.component=this.us),this.clear&&(this.content=this.t=this.component=null,this.cs=this.as),this.os=this.ls=this.as=this.us=null,1}Ns(){this.ds=null}async _s(){this.ps&&await this.us.Vs(),this.ds&&Object.assign(this,this.ds)}description(t=0){if(this.content){const component=this.ws(this.content),s=this.scope?this.router.Ot.Ls:"",i=this.t?this.router.Ot.t+this.t:"";if(t||s.length||this.options.xs)return`${component}${this.router.Ot.viewport}${this.name}${s}${i}`;const e={};return e[component]=component,this.rs.Fs(e)?`${component}${i}`:`${component}${this.router.Ot.viewport}${this.name}${s}${i}`}}As(t=0){return[this.rs.Ts(t),this.description(t)].filter(value=>value&&value.length).join(this.router.Ot.scope)}zs(component){let t=this.options.bs||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Ds(component){if("-"===component||null===component)return 1;let t=this.options.bs;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}Qs(t){this.component&&this.component.Bs(t)}Gs(t){this.component&&this.component.Js(t)}qs(t){this.component&&this.component.Ms(t)}Us(t){this.component&&this.component.Ws(t)}ws(component){return null===component?null:"string"==typeof component?component:component.description.name}vs(component){if(null===component)return null;if("string"!=typeof component)return component;{const t=this.context||this.router.gt,s=t.get(IContainer).Ks(CustomElementResource.Xs(component));return null!==s?s.Zs(t.get(IContainer)).Ys:null}}ti(component){if(null===component)return null;component=this.ws(component);const t=this.context||this.router.gt;return"string"!=typeof component?t.get(IContainer).get(component):t.get(IContainer).get(CustomElementResource.Xs(component))}ys(){this.options={},this.content=null,this.t=null,this.cs=null,this.component=null}async loadComponent(component){await this.si(),this.us=this.ti(component),this.us.ii(LifecycleFlags.Ct,this.context||this.router.gt,this.ns)}Is(component){}Hs(component){component.Bs(LifecycleFlags.ei|LifecycleFlags.hi,null)}js(component){component.Ws(LifecycleFlags.ni|LifecycleFlags.ri)}addComponent(component){component.Js(LifecycleFlags.ei)}Ps(component){component.Ms(LifecycleFlags.ni)}async si(){return this.ns?Promise.resolve():new Promise(t=>{this.fs=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.ns=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.oi={},this.li={},this.ci=null,this.parent&&this.parent.ai(this)}Fs(t){const s=[];let i=0;t&&(this.ci={},this.li={}),this.ci=Object.assign({},this.oi,this.ci);for(const s in t){const parts=s.split(this.router.Ot.scope),t=parts.shift();this.li[t]||(this.li[t]=[]),this.li[t].push(parts)}for(const e in this.li){const h=e.split(this.router.Ot.t),component=h.shift().split(this.router.Ot.viewport).shift(),n=component+(h.length?this.router.Ot.t+h.join(this.router.Ot.t):"");for(const name in this.ci){const h=this.ci[name];if(h&&h.zs(component)){const r=this.ui(t,this.li,e,n,h);s.push(...r.fi),i=i||r.di,this.ci[name]=null,Reflect.deleteProperty(this.li,e);break}}}for(const e in this.li){const h=e.split(this.router.Ot.t),parts=h.shift().split(this.router.Ot.viewport),component=parts.shift(),n=component+(h.length?this.router.Ot.t+h.join(this.router.Ot.t):"");let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let r=0;name.endsWith(this.router.Ot.Ls)&&(r=1,name=name.substring(0,name.length-1)),this.oi[name]||(this.pi(name,null,null,{scope:r,xs:1}),this.ci[name]=this.oi[name]);const o=this.ci[name];if(o&&o.Ds(component)){const h=this.ui(t,this.li,e,n,o);s.push(...h.fi),i=i||h.di,this.ci[name]=null,Reflect.deleteProperty(this.li,e)}}for(const e in this.li){const h=e.split(this.router.Ot.t),component=h.shift().split(this.router.Ot.viewport).shift(),n=component+(h.length?this.router.Ot.t+h.join(this.router.Ot.t):""),r=[];for(const name in this.ci){const t=this.ci[name];t&&t.Ds(component)&&r.push(t)}if(1===r.length){const h=r.shift(),o=this.ui(t,this.li,e,n,h);s.push(...o.fi),i=i||o.di,this.ci[h.name]=null,Reflect.deleteProperty(this.li,e);break}}if(i=i||Object.keys(this.li).length>0,!t)for(const t of this.children){const e=t.Fs();s.push(...e.fi),i=i||e.di}return{fi:s,di:i}}ui(t,s,i,component,e){const h=[{component,viewport:e}];let n=0;if(s[i].length){const r=e.scope||e.rs;for(const e of s[i])if(e.length){const s=e.join(this.router.Ot.scope),o={};o[s]=t[i+this.router.Ot.scope+s];const l=r.Fs(o);h.push(...l.fi),n=n||l.di}}return{fi:h,di:n}}pi(name,t,s,i){let e=this.oi[name];if(!e){let h;i.scope&&(h=new Scope(this.router,t,s,this),this.router.mi.push(h)),e=this.oi[name]=new Viewport(this.router,name,t,s,this,h,i)}return(t||s)&&e.gs(t,s,i),e}vi(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.wi(t.scope),Reflect.deleteProperty(this.oi,t.name)),Object.keys(this.oi).length}wi(){for(const t of this.children)t.wi();for(const t in this.oi)this.router.vi(this.oi[t],null,null)}gi(t){return t.Ss().then(()=>t.ks())}ai(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}yi(t=0,s=0){const i=[];for(const e in this.oi){const h=this.oi[e];(h.options.$s||h.options.Cs&&!t)&&!s||i.push(h.As(t))}for(const s of this.children)i.push(...s.yi(t));return i.filter(value=>value&&value.length)}bi(){const t=[];for(const s in this.oi)t.push(this.oi[s]);for(const s of this.children)t.push(...s.bi());return t}Ts(t=0){if(!this.ns||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.Ci(this.context.get(IContainer).parent);for(;i&&i.rs===this.parent;)s.unshift(i.description(t)),i=this.Ci(i.context.get(IContainer).parent);return s.unshift(this.parent.Ts(t)),s.filter(value=>value&&value.length).join(this.router.Ot.scope)}Ci(t){const s=Object.values(this.oi);for(;t;){const i=s.find(s=>s.context.get(IContainer)===t);if(i)return i;t=t.parent}return null}}class Router{constructor(t){this.gt=t,this.oi={},this.mi=[],this.$i={},this.Ht=[],this.Ei=[],this.U=0,this.Ri=0,this.Si=[],this.Oi=null,this.Hi=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.ki(t.anchor).Ts();i&&(s=`/${i}${this.Ot.scope}${s}`)}this.Vi.it(s)}),this.Vi=new HistoryBrowser,this.Pi=new LinkHandler}W(t){if(this.U)throw Error("Router has already been activated.");return this.U=1,this.options=Object.assign({q:t=>{this.ji(t)}},t),this.Ot=Object.assign({viewport:"@",Pt:"+",scope:"/",Ls:"!",t:"=",add:"+",clear:"-",action:"."},this.options.Ot),this.Pi.W({q:this.Hi}),this.Vi.W(this.options).catch(t=>{throw t})}X(){if(!this.U)throw Error("Router has not been activated.");this.Pi.X(),this.Vi.X()}ji(t){this.Si.push(t),this.Ii().catch(t=>{throw t})}async Ii(){if(null!==this.Oi||!this.Si.length)return Promise.resolve();const t=this.Si.shift();if(this.Oi=t,this.options.Ni&&this.options.Ni(t),t.V)return this.Oi=null,Promise.resolve();let s=0,i=0;(t.T||t.A)&&t.B&&(t.path=t.B,i=1);let e=t.path;this.options._i&&!i&&(e=this.options._i(e,this),Array.isArray(e)&&(e=this.Li(e))),(e===this.Ot.clear||e.startsWith(this.Ot.clear+this.Ot.add))&&(s=1,e.startsWith(this.Ot.clear)&&(e=e.substring(1)));const h=parseQuery(t.G);t.t=h.t,t.h=h.list;const n=this.xi(e);if(!n&&!Object.keys(n).length&&!s)return this.Oi=null,Promise.resolve();this.Fi();const r=s?this.Ai.bi().filter(value=>null!==value.component):[],o=this.Ai.bi().filter(value=>value.options.default&&null===value.component),l=[];let{fi:c,di:a}=this.Ai.Fs(n),u=100;for(;c.length||a||o.length;){if(!u--)throw Error("Failed to resolve all viewports");const s=[];for(const i of c){const{component,viewport:e}=i;e.ms(component,t)&&s.push(e);const h=r.findIndex(value=>value===e);0>h||r.splice(h,1);const n=o.findIndex(value=>value===e);0>n||o.splice(n,1)}for(const i of r)i.ms(this.Ot.clear,t)&&s.push(i);let i;for(;i=o.shift();)i.ms(i.options.default,t)&&s.push(i);!s.length&&this.Ri&&(this.Vi.cancel(),this.Ri=0);let e=await Promise.all(s.map(value=>value.Rs()));if(e.findIndex(value=>0==value)>=0)return this.Vi.cancel(),this.Oi=null,Promise.resolve();if((e=await Promise.all(s.map(async value=>{const t=await value.Ss();return"boolean"==typeof t?t?value.Os():0:1}))).some(t=>0==t))return this.Vi.cancel(),this.Oi=null,Promise.resolve();await Promise.all(s.map(value=>value.ks())),l.push(...s);const h=this.Ai.Fs();let n;for(c=[];n=this.Ei.shift();)h.fi.find(value=>value.viewport===n.viewport)||c.push(n);c=[...c,...h.fi],a=h.di}this.Ti(t),!t.D&&l.every(t=>t.options.$s)&&this.Vi.pop().catch(t=>{throw t}),l.forEach(t=>{t.Ns()}),this.Oi=null,this.Si.length&&this.Ii().catch(t=>{throw t})}Es(t,component){this.Oi&&this.Ei.push({viewport:t,component})}xi(t){const s={};t.startsWith("/")&&(t=t.substring(1));const i=t.split(this.Ot.Pt);let e=0;for(;i.length;){const t=i.shift().split(this.Ot.scope),parts=t.pop().split(this.Ot.viewport),component=parts[0];t.push(parts.length?parts.join(this.Ot.viewport):`?${e++}`);const name=t.join(this.Ot.scope);component&&(s[name]=component)}return s}zi(t){return this.Fi(),this.ki(t)}pi(name,t,s,i){return this.zi(t).pi(name,t,s,i)}vi(t,s,i){const e=t.rs;e.vi(t,s,i)||this.wi(e)}wi(t){if(t!==this.Ai){t.wi();const s=this.mi.indexOf(t);0>s||this.mi.splice(s,1)}}Y(t,s,i){"string"==typeof t&&this.Vi.Y(t,s,i)}replace(t,s,i){"string"==typeof t&&this.Vi.replace(t,s,i)}refresh(){this.Vi.refresh()}back(){this.Vi.back()}forward(){this.Vi.forward()}Li(t){const s=[];for(const i of t){let t=i.component;if(i.viewport&&(t+=this.Ot.viewport+i.viewport),i.t)for(const s in i.t)t+=this.Ot.t+i.t[s];s.push(t)}return s.join(this.Ot.Pt)}Di(t){const s=[],i=t.split(this.Ot.Pt);for(const t of i){let component,i,e;const[h,n]=t.split(this.Ot.viewport);void 0===n?[component,e]=h.split(this.Ot.t):(component=h,[i,e]=n.split(this.Ot.t));const r={component};i&&(r.viewport=i),e&&(r.t={id:e}),s.push(r)}return s}Qi(name,t){const s=this.Bi(name);s&&(s.jt=[]),this.Gi(name,t)}Gi(name,t){let s=this.$i[name];s||(s=this.$i[name]=new Nav(this,name)),s.It(t)}Bi(name){return this.$i[name]}Fi(){if(!this.Ai){const t=this.gt.get(Aurelia).root();this.Ai=new Scope(this,t.Ji,t.$context,null),this.mi.push(this.Ai)}}ki(t){let s=closestCustomElement(t).$customElement.$context.get(IContainer);for(;s;){const t=this.mi.find(t=>t.context.get(IContainer)===s);if(t)return t;s=s.parent}}qi(t){let s=t.slice().sort((t,s)=>s.split(this.Ot.scope).length-t.split(this.Ot.scope).length),i=[];if((s=s.map(value=>`${this.Ot.scope}${value}${this.Ot.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.Ot.scope).length-s.split(this.Ot.scope).length),i}Ti(t){this.Ht=this.Ai.yi(1,1),this.Ht=this.qi(this.Ht);let s=this.Ai.yi(),i=(s=this.qi(s)).join(this.Ot.Pt);this.options.Mi&&(i=this.options.Mi(this.Di(i),this));let e=this.Ai.yi(1);(e=this.qi(e)).unshift(this.Ot.clear);const h=t.G&&t.G.length?`?${t.G}`:"";this.Vi.st(i+h,e.join(this.Ot.Pt)+h,t)}}Router.inject=[IContainer];class ViewportCustomElement{constructor(router,t,s){this.router=router,this.ns=t,this.Ui=s,this.name="default",this.scope=null,this.bs=null,this.default=null,this.Cs=null,this.$s=null,this.viewport=null}Wi(t,host,parts,s){const i=this.constructor,dom=s.get(IDOM),template=this.Ui.Ki(dom,i.description,s,i);template.Xi=createRenderContext(dom,s,i.description.dependencies,i),template.Wi(this,host,parts)}bound(){const t={scope:this.ns.hasAttribute("scope")};this.bs&&this.bs.length&&(t.bs=this.bs),this.default&&this.default.length&&(t.default=this.default),this.ns.hasAttribute("no-link")&&(t.Cs=1),this.ns.hasAttribute("no-history")&&(t.$s=1),this.viewport=this.router.pi(this.name,this.ns,this.$context,t)}Yi(){this.router.vi(this.viewport,this.ns,this.$context)}Qs(t){this.viewport&&this.viewport.Qs(t)}Gs(t){this.viewport&&this.viewport.Gs(t)}qs(t){this.viewport&&this.viewport.qs(t)}Us(t){this.viewport&&this.viewport.Us(t)}}ViewportCustomElement.inject=[Router,INode,IRenderingEngine],__decorate([bindable],ViewportCustomElement.prototype,"name",void 0),__decorate([bindable],ViewportCustomElement.prototype,"scope",void 0),__decorate([bindable],ViewportCustomElement.prototype,"usedBy",void 0),__decorate([bindable],ViewportCustomElement.prototype,"default",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noLink",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noHistory",void 0),CustomElementResource.Zi({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},ViewportCustomElement);let NavCustomElement=class{constructor(router){this.router=router,this.name=null,this.jt=null,this.level=0}get te(){const t=this.router.Bi(this.name);return t?t.jt:[]}active(t){return"Active"}};__decorate([bindable],NavCustomElement.prototype,"name",void 0),__decorate([bindable],NavCustomElement.prototype,"routes",void 0),__decorate([bindable],NavCustomElement.prototype,"level",void 0),NavCustomElement=__decorate([inject(Router,Element),customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],NavCustomElement);export{HistoryBrowser,LinkHandler,Nav,HandlerEntry,RouteGenerator,TypesRecord,RecognizeResult,CharSpec,State,StaticSegment,DynamicSegment,StarSegment,EpsilonSegment,RouteRecognizer,Router,Scope,Viewport,ViewportCustomElement,NavCustomElement};
