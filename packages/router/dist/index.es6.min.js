function __decorate(t,s,i,h){var e,o,r=arguments.length,n=3>r?s:null===h?h=Object.getOwnPropertyDescriptor(s,i):h;if("object"==typeof Reflect&&"function"==typeof Reflect.t)n=Reflect.t(t,s,i,h);else for(o=t.length-1;o>=0;o--)(e=t[o])&&(n=(3>r?e(n):r>3?e(s,i,n):e(s,i))||n);return r>3&&n&&Object.defineProperty(s,i,n),n}import{CustomElementResource,IDOM,IProjectorLocator,IRenderingEngine,LifecycleFlags,Aurelia,INode,bindable}from"@aurelia/runtime";import{PLATFORM,IContainer}from"@aurelia/kernel";class HistoryBrowser{constructor(){this.s=null,this.i=0,this.h=0,this.o=0,this.l=0,this.u=(()=>{const t=this.p(),s={};let i=this.m("HistoryEntry");if(this.s&&this.s.path===t){s.P=1;const t=this.o?this.$.index:this.history.length-this.V;this.$=this.s,this.$.index=t,this.o?(this.H=0,this.O[this.$.index]=this.$,this.h?(s.L=1,this.h=0):this.l?(s.S=1,this.l=0):s.j=1,this.o=0):(this.H=1,this.O=this.O.slice(0,this.$.index),this.O.push(this.$)),this.k({C:this.O,v:this.V,I:this.$})}else this.O=this.O||this.m("HistoryEntries")||[],this.V=this.V||this.m("HistoryOffset")||0,i||this.$?i?this.$?i.index>this.$.index?s._=1:this.$.index>i.index&&(s.N=1):s.S=1:s.P=1:(s.P=1,s.A=1,this.V=this.history.length),i||(this.O=this.O.slice(0,(i={path:t,R:t,index:this.history.length-this.V}).index),this.O.push(i),this.k({C:this.O,v:this.V,I:i})),this.H=this.$?i.index-this.$.index:0,this.$=i,this.h&&(s.L=1,this.h=0);this.s=null,this.D&&this.D--,this.J(this.$,s)}),this.location=window.location,this.history=window.history}T(t){if(this.i)throw Error("History has already been activated.");return this.i=1,this.options=Object.assign({},t),window.addEventListener("popstate",this.u),Promise.resolve().then(()=>{this.B(this.p(),1)})}F(){window.removeEventListener("popstate",this.u),this.i=0}W(t,s,i){this.s={path:t,R:t,title:s,data:i},this.B(t)}replace(t,s,i){this.o=1,this.s={path:t,R:t,title:s,data:i},this.B(t,1)}q(t,s,i){this.D=this.H+1,this.replace(t,s,i)}refresh(){this.$&&(this.l=1,this.replace(this.$.path,this.$.title,this.$.data))}back(){this.history.go(-1)}forward(){this.history.go(1)}cancel(){this.h=1;const t=this.H||this.D;t?this.history.go(-t):this.replace(this.G.path,this.G.title,this.G.data)}k(t,value){const{pathname:s,search:i,hash:h}=this.location;let e=Object.assign({},this.history.state);"string"==typeof t?e[t]=JSON.parse(JSON.stringify(value)):e=Object.assign({},e,JSON.parse(JSON.stringify(t))),this.history.replaceState(e,null,`${s}${i}${h}`)}m(t){return Object.assign({},this.history.state)[t]}K(t){this.$.title=t,this.O[this.$.index]=this.$,this.k({C:this.O,I:this.$})}M(t,s){const i=`#/${t}`,{pathname:h,search:e,hash:o}=this.location;if(i===o)return;this.$.path=t,this.$.R=s;const r=Object.assign({},this.history.state,{I:this.$,C:this.O});this.history.replaceState(r,null,`${h}${e}${i}`)}U(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get X(){return this.O?this.O.slice(0,this.$.index+1).map(value=>value.title):[]}p(){return this.location.hash.substr(1)}B(t,s=0){if(this.$&&this.$.path===t&&!this.l)return;const{pathname:i,search:h}=this.location,e=`#${t}`;s?(this.G=this.$,this.history.replaceState({},null,`${i}${h}${e}`)):this.history.pushState({},null,`${i}${h}${e}`),this.u()}J(t,s){const i=Object.assign({},t,s);this.options.J&&this.options.J(i)}}class LinkHandler{constructor(){this.i=0,this.Y=(t=>{const s=LinkHandler.Z(t);s.g&&(t.preventDefault(),this.options.J(s))}),this.document=document}static Z(t){const s={g:0,href:null,anchor:null},i=LinkHandler.tt(t.target);if(!i||!LinkHandler.st(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const h=i.getAttribute("href");return s.anchor=i,s.href=h,s.g=1===t.which,s}static tt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static st(t){const s=t.getAttribute("target");return!s||s===LinkHandler.window.name||"_self"===s}T(t){if(this.i)throw Error("LinkHandler has already been activated.");this.i=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.Y,1)}F(){this.document.removeEventListener("click",this.Y),this.i=0}}class Viewport{constructor(router,name,t,s,i,h){this.router=router,this.name=name,this.it=t,this.ht=s,this.scope=i,this.options=h,this.clear=0}et(t,s){if(this.clear=0,"string"==typeof t)if(t===this.router.ot.clear)this.clear=1,t=null;else{const s=this.router.nt.rt(CustomElementResource.ct(t));null!==s&&(t=s.at(this.router.nt).lt)}return this.ft=t,this.ut=s,this.content!==t||s.S?1:0}pt(){if(!this.component)return Promise.resolve(1);const component=this.component;if(!component.pt)return Promise.resolve(1);const t=component.pt(this.wt,this.ut);return"boolean"==typeof t?Promise.resolve(t):t}dt(){if(this.clear)return Promise.resolve(1);if(!this.ft)return Promise.resolve(0);if(this.loadComponent(this.ft),!this.bt)return Promise.resolve(0);const component=this.bt;if(!component.dt)return Promise.resolve(1);const t=component.dt(this.ut,this.wt);return"boolean"==typeof t?Promise.resolve(t):t}async Pt(t){if(!this.it&&(await this.$t(50),!this.it))return Promise.resolve(0);const host=this.it,s=this.router.nt,dom=s.get(IDOM),i=s.get(IProjectorLocator),h=s.get(IRenderingEngine);return this.component&&(this.component.Vt&&this.component.Vt(this.wt,this.ut),this.component.Ht(LifecycleFlags.Ot),this.component.Lt(LifecycleFlags.Ot|LifecycleFlags.St)),this.bt&&(this.bt.jt&&this.bt.jt(this.ut,this.wt),this.bt.kt(dom,i,h,host,null),this.bt.Ct(LifecycleFlags.vt|LifecycleFlags.It,null),this.bt._t(LifecycleFlags.vt),this.content=this.ft,this.wt=this.ut,this.component=this.bt),this.clear&&(this.content=this.component=null,this.wt=this.ut),this.ft=this.ut=this.bt=null,Promise.resolve(1)}description(t=0){if(this.content){const component=this.content.description.name,s=this.scope?this.router.ot.yt:"";if(t||s.length||this.options.Nt)return`${component}${this.router.ot.viewport}${this.name}${s}`;const i={};return i[component]=component,this.ht.At(i)?component:`${component}${this.router.ot.viewport}${this.name}${s}`}}Rt(t=0){return[this.ht.context(t),this.description(t)].filter(value=>value&&value.length).join(this.router.ot.scope)}Dt(component){let t=this.options.Et||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Jt(component){if("-"===component||null===component)return 1;let t=this.options.Et;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}loadComponent(component){this.bt=this.router.nt.get(CustomElementResource.ct(component.description.name))}async $t(t){return this.it?Promise.resolve():t?(await this.Tt(100),this.$t(--t)):Promise.resolve()}async Tt(t=0){await new Promise(s=>{PLATFORM.global.setTimeout(s,t)})}}class Scope{constructor(router,t,s){this.router=router,this.it=t,this.parent=s,this.children=[],this.Bt={},this.Ft={},this.parent&&this.parent.Wt(this)}At(t){const s=[];let i=0;t&&(this.qt={},this.Ft={}),this.qt=Object.assign({},this.Bt,this.qt);for(const s in t){const parts=s.split(this.router.ot.scope),t=parts.shift();this.Ft[t]||(this.Ft[t]=[]),this.Ft[t].push(parts)}for(const h in this.Ft){const component=h.split(this.router.ot.viewport).shift();for(const name in this.qt){const e=this.qt[name];if(e&&e.Dt(component)){const o=this.zt(t,this.Ft,h,component,e);s.push(...o.Gt),i=i||o.Kt,this.qt[name]=null,delete this.Ft[h];break}}}for(const h in this.Ft){const parts=h.split(this.router.ot.viewport),component=parts.shift();let name=parts.shift();if(!name||!name.length||name.startsWith("?"))continue;let e=0;name.endsWith(this.router.ot.yt)&&(e=1,name=name.substr(0,name.length-1)),this.Bt[name]||(this.Mt(name,null,{scope:e,Nt:1}),this.qt[name]=this.Bt[name]);const o=this.qt[name];if(o&&o.Jt(component)){const e=this.zt(t,this.Ft,h,component,o);s.push(...e.Gt),i=i||e.Kt,this.qt[name]=null,delete this.Ft[h]}}for(const h in this.Ft){const component=h.split(this.router.ot.viewport).shift(),e=[];for(const name in this.qt){const t=this.qt[name];t&&t.Jt(component)&&e.push(t)}if(1===e.length){const o=e.shift(),r=this.zt(t,this.Ft,h,component,o);s.push(...r.Gt),i=i||r.Kt,this.qt[o.name]=null,delete this.Ft[h];break}}if(i=i||Object.keys(this.Ft).length>0,!t)for(const t of this.children){const h=t.At();s.push(...h.Gt),i=i||h.Kt}return{Gt:s,Kt:i}}zt(t,s,i,component,h){const e=[{component,viewport:h}];let o=0;if(s[i].length){const r=h.scope||h.ht;for(const h of s[i])if(h.length){const s=h.join(this.router.ot.scope),n={};n[s]=t[i+this.router.ot.scope+s];const c=r.At(n);e.push(...c.Gt),o=o||c.Kt}}return{Gt:e,Kt:o}}Mt(name,t,s){let i=this.Bt[name];if(!i){let h;s.scope&&(h=new Scope(this.router,t,this),this.router.Qt.push(h)),i=this.Bt[name]=new Viewport(this.router,name,t,this,h,s)}return t&&(i.scope&&i.scope.parent&&!i.scope.viewport&&(i.scope.viewport=i),i.scope&&!i.scope.it&&(i.scope.it=t),i.it||(i.it=t,i.it.children||this.Ut(i).catch(t=>{throw t}))),i}Xt(t){return t.scope&&this.router.Yt(t.scope),delete this.Bt[t.name],Object.keys(this.Bt).length}Yt(){for(const t of this.children)t.Yt();for(const t in this.Bt)this.router.Xt(this.Bt[t])}Ut(t){return t.dt().then(()=>t.Pt())}Wt(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Zt(t=0){const s=[];for(const i in this.Bt)s.push(this.Bt[i].Rt(t));for(const i of this.children)s.push(...i.Zt(t));return s.filter(value=>value&&value.length)}gt(){const t=[];for(const s in this.Bt)t.push(this.Bt[s]);for(const s of this.children)t.push(...s.gt());return t}context(t=0){if(!this.it||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.xt(this.it.parentElement);for(;i&&i.ht===this.parent;)s.unshift(i.description(t)),i=this.xt(i.it.parentElement);return s.unshift(this.parent.context(t)),s.filter(value=>value&&value.length).join(this.router.ot.scope)}ts(component){if("string"==typeof component){const t=this.router.nt.rt(CustomElementResource.ct(component));null!==t&&(component=t.at(this.router.nt).lt)}return component}xt(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h in this.Bt){const e=this.Bt[h].it;let o=t,r=0;for(;o&&o!==e;)r++,o=o.parentElement;i>r&&(i=r,s=this.Bt[h])}return s}}class Router{constructor(t){this.nt=t,this.ss=[],this.Bt={},this.Qt=[],this.i=0,this.hs=0,this.es=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substr(1)),!s.startsWith("/")){const i=this.os(t.anchor).context();i&&(s=`/${i}${this.ot.scope}${s}`)}this.rs.U(s)}),this.rs=new HistoryBrowser,this.ns=new LinkHandler}T(t){if(this.i)throw Error("Router has already been activated.");return this.i=1,this.options=Object.assign({J:t=>{this.cs(t).catch(t=>{throw t})}},t),this.ot=Object.assign({viewport:"@",ls:"+",scope:"/",yt:"!",as:"=",add:"+",clear:"-",action:"."},this.options.ot),this.ns.T({J:this.es}),this.rs.T(this.options).catch(t=>{throw t})}F(){if(!this.i)throw Error("Router has not been activated.");this.ns.F(),this.rs.F()}async cs(t){if(this.options.fs&&this.options.fs(t),t.L)return Promise.resolve();let s=0;(t.N||t._)&&(t.path=t.R);const i=t.path;let h,e;(i===this.ot.clear||i.startsWith(this.ot.clear+this.ot.add))&&(s=1,i.startsWith(this.ot.clear)&&(t.path=i.substr(1)));let o=this.us(t);if(o){if(o.q)return o=this.ps(o,t.data),this.hs=1,this.rs.q(o.path,o.title,t.data),Promise.resolve();o.title&&(h=o.title),e=o.Bt}else e=this.ms(t);if(!e&&!Object.keys(e).length&&!s)return Promise.resolve();h&&this.rs.K(h);const r=s?this.ws.gt().filter(value=>null!==value.component):[];let{Gt:n,Kt:c}=this.ws.At(e),l=100;for(;(n.length||c)&&l--;){const s=[];for(const i of n){const{component,viewport:h}=i;h.et(component,t)&&s.push(h);const e=r.findIndex(value=>value===h);0>e||r.splice(e,1)}for(const i of r)i.et(this.ot.clear,t)&&s.push(i);!s.length&&this.hs&&(this.rs.cancel(),this.hs=0);let i=await Promise.all(s.map(value=>value.pt()));if(i.findIndex(value=>0==value)>=0)return this.rs.cancel(),Promise.resolve();if((i=await Promise.all(s.map(value=>value.dt()))).findIndex(value=>0==value)>=0)return this.rs.cancel(),Promise.resolve();i=await Promise.all(s.map(value=>value.Pt()));const h=this.ws.At();n=h.Gt,c=h.Kt}this.ds()}us(t){return this.ss.find(value=>value.path===t.path)}ps(t,s){for(;t.q;){const i=this.us({path:t.q,R:t.q,data:s});if(!i)break;t=i}return t}ms(t){const s={};let i=t.path;i.startsWith("/")&&(i=i.substr(1));let h=i.split(this.ot.ls),e=0;for(;h.length;){const t=h.shift().split(this.ot.scope),parts=t.pop().split(this.ot.viewport),component=parts[0];t.push(parts.length?parts.join(this.ot.viewport):`?${e++}`);const name=t.join(this.ot.scope);component&&(s[name]=component)}return s}bs(t){if(!this.ws){const t=this.nt.get(Aurelia).root().Ps;this.ws=new Scope(this,t,null),this.Qt.push(this.ws)}return this.os(t)}Mt(name,t,s){return this.bs(t).Mt(name,t,s)}Xt(t){const s=t.ht;s.Xt(t)||this.Yt(s)}Yt(t){if(t!==this.ws){t.Yt();const s=this.Qt.indexOf(t);0>s||this.Qt.splice(s,1)}}$s(t){this.ss.push(t)}W(t,s,i){"string"==typeof t&&this.rs.W(t,s,i)}replace(t,s,i){"string"==typeof t&&this.rs.replace(t,s,i)}refresh(){this.rs.refresh()}back(){this.rs.back()}forward(){this.rs.forward()}os(t){let s,i=Number.MAX_SAFE_INTEGER;for(const h of this.Qt){let e=t,o=0;for(;e&&e!==h.it;)o++,e=e.parentElement;i>o&&(i=o,s=h)}return s}Vs(t){let s=t.slice().sort((t,s)=>s.split(this.ot.scope).length-t.split(this.ot.scope).length),i=[];if((s=s.map(value=>`${this.ot.scope}${value}${this.ot.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.ot.scope).length-s.split(this.ot.scope).length),i}ds(){let t=this.ws.Zt();t=this.Vs(t);let s=this.ws.Zt(1);(s=this.Vs(s)).unshift(this.ot.clear),this.rs.M(t.join(this.ot.ls),s.join(this.ot.ls))}}Router.inject=[IContainer];class ViewportCustomElement{constructor(router,t){this.router=router,this.it=t,this.name="default"}Hs(){const t={scope:this.it.hasAttribute("scope")};this.Et&&this.Et.length&&(t.Et=this.Et),this.viewport=this.router.Mt(this.name,this.it,t)}Os(){this.router.Xt(this.viewport)}}ViewportCustomElement.inject=[Router,INode],__decorate([bindable],ViewportCustomElement.prototype,"name",void 0),__decorate([bindable],ViewportCustomElement.prototype,"scope",void 0),__decorate([bindable],ViewportCustomElement.prototype,"usedBy",void 0),CustomElementResource.Ls({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},ViewportCustomElement);export{ViewportCustomElement,HistoryBrowser,LinkHandler,Router,Scope,Viewport};
