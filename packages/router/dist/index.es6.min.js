function parseQuery(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const e=t.replace("+"," ").split("&");for(const t of e){const e=t.split("="),n=decodeURIComponent(e.shift());if(!e.length){i.push(n);continue}const value=decodeURIComponent(e.shift());s[n]=value}return{t:s,list:i}}function mergeParameters(t,s,i){const e=parseQuery(s),n=parseQuery(t),h=Object.assign({},e.t,n.t),r=[...e.list,...n.list];if(r.length&&i&&i.length)for(const t of i)h[t]=r.shift();let o;return r.length&&Object.keys(h).length&&(h["s"]=r.splice(0,r.length)),{i:h,h:r,o:o=r.length?r:h}}function closestCustomElement(t){for(;t&&!t.$customElement;)t=t.parentElement;return t}function __decorate(t,s,i,e){var n,h,r=arguments.length,o=3>r?s:null===e?e=Object.getOwnPropertyDescriptor(s,i):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,s,i,e);else for(h=t.length-1;h>=0;h--)(n=t[h])&&(o=(3>r?n(o):r>3?n(s,i,o):n(s,i))||o);return r>3&&o&&Object.defineProperty(s,i,o),o}import{Reporter,PLATFORM,IContainer,buildQueryString,parseQueryString,DI,inject}from"@aurelia/kernel";import{CustomElementResource,IObserverLocator,Aurelia,IDOM,createRenderContext,INode,IRenderingEngine,bindable,customElement}from"@aurelia/runtime";class QueuedBrowserHistory{constructor(){this.l=(async t=>this.u(this,"popstate",[t])),this.window=window,this.history=window.history,this.p=[],this.m=0,this.g=null,this.v=null,this.C=null,this.R=null}S(t){if(this.m)throw Reporter.error(2003);this.m=1,this.v=t,PLATFORM.I.add(this.V,this),this.window.addEventListener("popstate",this.l)}$(){this.window.removeEventListener("popstate",this.l),PLATFORM.I.remove(this.V,this),this.v=null,this.m=0}get length(){return this.history.length}get state(){return this.history.state}get O(){return this.history.O}async go(t,s=0){if(!s)return this.u(this,"_go",[t],1);const i=this.u(this,"suppressPopstate",[],1);return this.u(this.history,"go",[t]).catch(t=>{throw t}),i}back(){return this.go(-1)}forward(){return this.go(1)}async pushState(t,s,i){return this.u(this.history,"pushState",[t,s,i])}async replaceState(t,s,i){return this.u(this.history,"replaceState",[t,s,i])}async H(t){if(this.R){const t=this.R;this.R=null,t()}else{if(this.C){const t=this.C;this.C=null,t(),await Promise.resolve()}this.v(t)}}k(t,s){this.C=s,this.history.go(t)}P(t){this.R=t}u(t,s,i,e=0){let n;const h=new Promise(t=>{n=t});return e&&(i.push(n),n=null),this.p.push({target:t,N:s,t:i,resolve:n}),h}async V(t){if(!this.p.length||null!==this.g)return;this.g=this.p.shift();const s=this.g.target[this.g.N];Reporter.write(1e4,"DEQUEUE",this.g.N,this.g.t),s.apply(this.g.target,this.g.t);const i=this.g.resolve;this.g=null,i&&i()}}class HistoryBrowser{constructor(){this._=(async()=>{const t=this.j(),s=this.T();Reporter.write(1e4,"path changed to",t,this.A,this.L);const i={};let e,n=this.D("HistoryEntry");if(this.A&&this.A.path===t){i.B=1;const t=this.F?this.L.index:this.history.length-this.U;e=this.L,this.L=this.A,this.L.index=t,this.F?(this.q=0,this.G[this.L.index]=this.L,this.M?(i.J=1,this.M=0):i.W=1,this.F=0):(this.q=1,this.G=this.G.slice(0,this.L.index),this.G.push(this.L)),await this.K({X:this.G,Y:this.U,Z:this.L})}else this.G=this.G||this.D("HistoryEntries")||[],this.U=this.U||this.D("HistoryOffset")||0,n||this.L?n?this.L?n.index>this.L.index?i.tt=1:this.L.index>n.index&&(i.st=1):i.J=1:i.B=1:(i.B=1,i.it=1,this.U=this.history.length),n||(n={path:t,et:null,index:this.history.length-this.U,nt:s},i.it&&(n.ht=1),this.G=this.G.slice(0,n.index),this.G.push(n),await this.K({X:this.G,Y:this.U,Z:n})),this.q=this.L?n.index-this.L.index:0,e=this.L,this.L=n;this.A=null,Reporter.write(1e4,"navigated",this.D("HistoryEntry"),this.G,this.D("HistoryOffset")),this.v(this.L,i,e)}),this.location=window.location,this.history=new QueuedBrowserHistory,this.L=null,this.G=null,this.U=null,this.rt=null,this.A=null,this.options=null,this.m=0,this.q=null,this.F=0,this.M=0}S(t){if(this.m)throw Reporter.error(0);return this.m=1,this.options=Object.assign({},t),this.history.S(this._),Promise.resolve().then(()=>{this.ot(this.j(),1).catch(t=>{throw t})})}$(){this.history.$(),this.m=0}at(t,s,i){return this.A={path:t,et:null,title:s,data:i},this.ot(t)}replace(t,s,i){return this.F=1,this.A={path:t,et:null,title:s,data:i},this.ot(t,1)}async refresh(){if(this.L)return this.M=1,this.replace(this.L.path,this.L.title,this.L.data)}back(){return this.history.go(-1)}forward(){return this.history.go(1)}cancel(){const t=this.q;return t?(this.q=0,this.history.go(-t,1)):this.replace(this.rt.path,this.rt.title,this.rt.data)}async pop(){await this.history.go(-1,1);const t=""+this.location,s=this.history.state;if(!s.Z.ht)return await this.history.go(-1,1),this.history.pushState(s,null,t)}async K(t,value){const{pathname:s,search:i,hash:e}=this.location;let n=Object.assign({},this.history.state);return"string"==typeof t?n[t]=JSON.parse(JSON.stringify(value)):n=Object.assign({},n,JSON.parse(JSON.stringify(t))),this.history.replaceState(n,null,`${s}${i}${e}`)}D(t){return Object.assign({},this.history.state)[t]}ct(t){return this.L.title=t,this.G[this.L.index]=this.L,this.K({X:this.G,Z:this.L})}lt(t,s,i){if(i.index!==this.L.index)return;const e=`#/${t}`,{pathname:n,search:h,hash:r}=this.location;if(e===r&&this.L.path===t&&this.L.et===s)return;this.L.path=t,this.L.et=s;const o=Object.assign({},this.history.state,{Z:this.L,X:this.G});return this.history.replaceState(o,null,`${n}${h}${e}`)}ut(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get ft(){return this.G?this.G.slice(0,this.L.index+1).map(value=>value.title):[]}j(){return this.location.hash.substring(1).split("?")[0]}async ot(t,s=0){if(this.L&&this.L.path===t&&!this.M)return;const{pathname:i,search:e}=this.location,n=`#${t}`;return s?(this.rt=this.L,await this.history.replaceState({},null,`${i}${e}${n}`)):await this.history.pushState({},null,`${i}${e}${n}`),this._()}T(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}v(t,s,i){const e=Object.assign({},t,s);e.pt=i,Reporter.write(1e4,"callback",t,s),this.options.v&&this.options.v(e)}}class LinkHandler{constructor(){this.m=0,this.dt=(t=>{const s=LinkHandler.wt(t);s.gt&&(t.preventDefault(),this.options.v(s))}),this.document=document}static wt(t){const s={gt:0,href:null,anchor:null},i=LinkHandler.vt(t.target);if(!i||!LinkHandler.yt(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const e=i.getAttribute("href");return s.anchor=i,s.href=e,s.gt=1===t.which,s}static vt(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static yt(t){const s=t.getAttribute("target");return!s||s===LinkHandler.window.name||"_self"===s}S(t){if(this.m)throw Reporter.error(2004);this.m=1,this.options=Object.assign({},t),this.document.addEventListener("click",this.dt,1)}$(){this.document.removeEventListener("click",this.dt,1),this.m=0}}class ViewportInstruction{constructor(component,t,s,i){this.Ct(component),t&&this.Rt(t),s&&this.bt(s),this.scope=!!i}Ct(component){"string"==typeof component?(this.St=component,this.component=null):(this.component=component,this.St=component.description.name)}Rt(t){"string"==typeof t?(this.Et=t,this.viewport=null):(this.viewport=t,t&&(this.Et=t.name))}bt(t){"string"==typeof t?(this.It=t,this.t={id:t}):this.t=t}Vt(t){if(null!==this.component)return this.component;const s=t.get(IContainer),i=s.$t(CustomElementResource.Ot(this.St));return null!==i?i.kt(s).Ht:null}Pt(router){return null!==this.viewport?this.viewport:router.Nt()[this.Et]}_t(t,s=0,i=0){return s&&this.It!==t.It?0:i?this.component===t.component:this.St===t.St}}class NavRoute{constructor(t,s){this.active="",this.jt=t,Object.assign(this,{title:s.title,children:null,Tt:s.Tt,active:""}),this.instructions=this.At(s.Lt),this.link=this.xt(this.instructions),this.Dt=s.Qt?this.xt(this.At(s.Qt)):this.link,this.zt=this.jt.router.Bt.get(IObserverLocator),this.Ft=this.zt.Ut(0,this.jt.router,"activeComponents"),this.Ft.subscribe(this)}get qt(){return this.children&&this.children.length?"nav-has-children":""}Gt(){this.active=this.link&&this.link.length?this.Mt():"nav-active"===this.active?"nav-active":this.Jt()?"nav-active-child":""}Mt(){const t=this.jt.router.Kt.Wt(this.Dt),s=this.jt.router.Xt.map(t=>this.jt.router.Kt.Yt(t));for(const component of t)if(!s.find(t=>t._t(component)))return"";return"nav-active"}Zt(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}xt(instructions){return this.jt.router.Kt.ts(instructions)}At(t){if(!Array.isArray(t))return this.At([t]);const instructions=[];for(const s of t)instructions.push("string"==typeof s?this.jt.router.Kt.Yt(s):s instanceof ViewportInstruction?s:s.component?new ViewportInstruction(s.component,s.viewport,s.t):new ViewportInstruction(s));return instructions}Jt(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.Jt())return 1;return 0}}class Nav{constructor(router,name){this.router=router,this.name=name,this.ss=[]}es(t){for(const s of t)this.ns(this.ss,s)}ns(t,s){const i=new NavRoute(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.ns(i.children,t)}}}class HandlerEntry{constructor(t,s){this.dt=t,this.names=s}}class RouteGenerator{constructor(t,s){this.hs=t,this.rs=s}}class TypesRecord{constructor(){this.os=0,this.as=0,this.cs=0}}class RecognizeResult{constructor(t,s,i){this.dt=t,this.ls=s,this.us=i}}class CharSpec{constructor(t,s,i){this.fs=t,this.ps=s,this.repeat=i}ds(t){return this.ps===t.ps&&this.fs===t.fs}}class State{constructor(t){this.ws=t,this.ms=[]}put(t){let s=this.ms.find(s=>s.ws.ds(t));return void 0===s&&(s=new State(t),this.ms.push(s),t.repeat&&s.ms.push(s)),s}}const specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],escapeRegex=RegExp(`(\\${specials.join("|\\")})`,"g");class StaticSegment{constructor(t,s){this.name=t,this.gs=t,this.vs=s,this.optional=0}ys(t){const s=this.gs,i=s.length;let e=0,n="";if(this.vs)for(;i>e;++e)n=s.charAt(e),t(new CharSpec(null,n,0));else for(;i>e;++e)n=s.charAt(e),t(new CharSpec(null,n.toUpperCase()+n.toLowerCase(),0))}Cs(){return this.gs.replace(escapeRegex,"\\$1")}Rs(t,s){return this.gs}}class DynamicSegment{constructor(name,optional){this.name=name,this.optional=optional}ys(t){t(new CharSpec("/",null,1))}Cs(){return"([^/]+)"}Rs(t,s){return s[this.name]=1,t[this.name]}}class StarSegment{constructor(name){this.name=name,this.optional=0}ys(t){t(new CharSpec("",null,1))}Cs(){return"(.+)"}Rs(t,s){return s[this.name]=1,t[this.name]}}class EpsilonSegment{ys(t){}Cs(){return""}Rs(t,s){return""}}class RouteRecognizer{constructor(){this.bs=new State,this.names={},this.ss=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.bs;const i=[];let e="^";const n=new TypesRecord,h=[],r=t.dt.name;let o=1,a=t.path;"/"===a.charAt(0)&&(a=a.slice(1));const c=[],l=a.split("/");let u,f;for(let r=0,a=l.length;a>r;++r){let a=(u=l[r]).match(/^:([^?]+)(\?)?$/);if(a){const[,name,optional]=a;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);c.push(f=new DynamicSegment(name,!!optional)),h.push(name),n.as++}else if(a=u.match(/^\*(.+)$/))c.push(f=new StarSegment(a[1])),h.push(a[1]),n.cs++;else{if(""===u){c.push(new EpsilonSegment);continue}c.push(f=new StaticSegment(u,t.vs)),n.os++}const p=s.put(new CharSpec(null,"/",0));let d=p;f.ys(t=>{d=d.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].ms.push(p);f.optional?(i.push(d),e+=`(?:/${f.Cs()})?`):(s=d,e+=`/${f.Cs()}`,i.length=0,o=0)}o&&(s=s.put(new CharSpec(null,"/",0)),e+="/?");const p=[new HandlerEntry(t.dt,h)];if(this.ss.set(t.dt,new RouteGenerator(c,p)),r){const t=Array.isArray(r)?r:[r];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new RouteGenerator(c,p))}for(let s=0;i.length>s;s++){const h=i[s];h.rs=p,h.Cs=RegExp(`${e}$`,t.vs?"":"i"),h.types=n}return s.rs=p,s.Cs=RegExp(`${e}$`,t.vs?"":"i"),s.types=n,s}Ss(t){return"string"==typeof t?this.names[t]:this.ss.get(t)}Es(t){const s=this.Ss(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.rs]}Is(t){return!!this.Ss(t)}Rs(t,s){const i=this.Ss(t);if(!i)throw Error(`There is no route named ${t}`);const e=i.rs[0].dt;if(e.Vs)return e.href;const n=Object.assign({},s),h=i.hs,r={};let o="";for(let s=0,i=h.length;i>s;s++){const i=h[s];if(i instanceof EpsilonSegment)continue;const e=i.Rs(n,r);if(null==e){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else o+="/",o+=e}"/"!==o.charAt(0)&&(o=`/${o}`);for(const t in r)Reflect.deleteProperty(n,t);const a=buildQueryString(n);return o+(a?`?${a}`:"")}$s(t){let s=[this.bs],i={},e=0,n=t;const h=n.indexOf("?");if(-1!==h){const t=n.slice(h+1);n=n.slice(0,h),i=parseQueryString(t)}"/"!==(n=decodeURI(n)).charAt(0)&&(n=`/${n}`);let r=n.length;r>1&&"/"===n.charAt(r-1)&&(n=n.slice(0,-1),e=1,--r);for(let t=0;r>t;++t){const i=[],e=n.charAt(t);if(s.forEach(t=>{t.ms.forEach(t=>{null!==t.ws.ps?-1!==t.ws.ps.indexOf(e)&&i.push(t):null!==t.ws.fs&&-1===t.ws.fs.indexOf(e)&&i.push(t)})}),0===(s=i).length)break}const o=[];for(let t=0,i=s.length;i>t;t++)s[t].rs&&o.push(s[t]);o.sort((t,s)=>{if(t.types.cs!==s.types.cs)return t.types.cs-s.types.cs;if(t.types.cs){if(t.types.os!==s.types.os)return s.types.os-t.types.os;if(t.types.as!==s.types.as)return s.types.as-t.types.as}return t.types.as!==s.types.as?t.types.as-s.types.as:t.types.os!==s.types.os?s.types.os-t.types.os:0});const a=o[0];if(a&&a.rs){e&&"(.+)$"===a.Cs.source.slice(-5)&&(n=`${n}/`);const t=n.match(a.Cs);let s=1;const h=[];return h.Os=i,a.rs.forEach(i=>{const e={};i.names.forEach(name=>{e[name]=t[s++]}),h.push(new RecognizeResult(i.dt,e,i.names.length>0))}),h}}}class InstructionResolver{S(t){this.Hs=Object.assign({viewport:"@",ks:"+",scope:"/",Ps:"!",t:"=",add:"+",clear:"-",action:"."},t.Hs)}get Ns(){return this.Hs.clear}Yt(t){let component,s,i,e;const[n,h]=t.split(this.Hs.viewport);return void 0===h?([component,...i]=n.split(this.Hs.t),component.endsWith(this.Hs.Ps)&&(e=1,component=component.slice(0,component.length-1))):(component=n,[s,...i]=h.split(this.Hs.t),s.endsWith(this.Hs.Ps)&&(e=1,s=s.slice(0,s.length-1))),i=i.length?i.join(this.Hs.t):void 0,new ViewportInstruction(component,s,i,e)}_s(t,s=0){if("string"==typeof t)return this._s(this.Yt(t),s);{let i=t.St;return t.Et&&!s&&(i+=this.Hs.viewport+t.Et),t.It&&(i+=this.Hs.t+t.It),i}}js(t){return t.split(this.Hs.scope).map(t=>this.Yt(t))}Ts(instructions){return Array.isArray(instructions)?instructions.map(t=>this._s(t)).join(this.Hs.scope):this.Ts([instructions])}As(t,s){return t&&(s=`/${t}${this.Hs.scope}${s}`),s}Ls(t){return{xs:t===this.Hs.clear||t.startsWith(this.Hs.clear+this.Hs.add),Ds:t.startsWith(this.Hs.clear)?t.substring(1):t}}Qs(t){const s={};t.startsWith("/")&&(t=t.substring(1));const i=t.split(this.Hs.ks);let e=0;for(;i.length;){const t=i.shift().split(this.Hs.scope),parts=t.pop().split(this.Hs.viewport),component=parts[0];t.push(parts.length?parts.join(this.Hs.viewport):`?${e++}`);const name=t.join(this.Hs.scope);component&&(s[name]=component)}return s}ts(instructions){const t=[];for(const s of instructions)t.push(this._s(s));return t.join(this.Hs.ks)}Wt(t){const instructions=[],s=t.split(this.Hs.ks);for(const t of s)instructions.push(this.Yt(t));return instructions}zs(t){let s=t.slice().sort((t,s)=>s.split(this.Hs.scope).length-t.split(this.Hs.scope).length),i=[];if((s=s.map(value=>`${this.Hs.scope}${value}${this.Hs.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.Hs.scope).length-s.split(this.Hs.scope).length),i}Bs(t,s=0){const i=t.slice();return s&&i.unshift(this.Ns),i.join(this.Hs.ks)}}class RouteTable{constructor(){this.Fs=(t=>t),this.Us=(instructions=>instructions)}}var ContentStatus;(function(t){t[t.qs=0]="none",t[t.loaded=1]="loaded",t[t.Gs=2]="initialized",t[t.Ms=3]="entered",t[t.Js=4]="added"})(ContentStatus||(ContentStatus={}));class ViewportContent{constructor(t=null,s=null,i=null,e=null){this.content=t,this.t=s,this.Ws=i,this.component=null,this.Ks=0,this.Xs=0,null!==this.content&&"string"==typeof this.content&&null!==e&&(this.content=this.Vt(e))}Ys(t){return"string"==typeof t.content&&this.St()!==t.content||"string"!=typeof t.content&&this.content!==t.content||this.t!==t.t||!this.Ws||this.Ws.nt!==t.Ws.nt}Zs(t){return("string"==typeof t.content&&this.St()===t.content||"string"!=typeof t.content&&this.content===t.content)&&this.t===t.t}loadComponent(t,s){return this.Xs||(this.component=this.ti(t),this.component.si(0,t,s)),this.Ks=1,Promise.resolve()}ii(){1===this.Ks&&(this.Ks=0)}ei(){this.Xs||this.component.ni(2560,null),this.Ks=2}hi(t=0){2===this.Ks&&(t||(this.component.ri(5120),this.Ks=1))}addComponent(t){if(this.component.oi(512),this.Xs){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)if(t.hasAttribute("au-element-scroll")){const[s,i]=t.getAttribute("au-element-scroll").split(",");t.removeAttribute("au-element-scroll"),t.scrollTo(+i,+s)}}this.Ks=4}ai(t,s=0){if(4===this.Ks){if(s){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)(t.scrollTop>0||t.scrollLeft)&&t.setAttribute("au-element-scroll",`${t.scrollTop},${t.scrollLeft}`)}this.component.ci(1024),this.Ks=4}}async li(t,s=0){switch(this.Ks){case 4:this.ai(t,s);case 3:this.component.ui&&await this.component.ui(),this.Ks=2;case 2:this.hi(s);case 1:this.ii()}this.Ks=0}St(){return null===this.content?null:"string"==typeof this.content?this.content:this.content.description.name}Vt(t){if(null===this.content)return null;if("string"!=typeof this.content)return this.content;{const s=t.get(IContainer),i=s.$t(CustomElementResource.Ot(this.content));return null!==i?i.kt(s).Ht:null}}ti(t){if(null===this.content)return null;const component=this.St();return t.get(IContainer).get("string"!=typeof component?component:CustomElementResource.Ot(component))}}class Viewport{constructor(router,name,t,s,i,e,n){this.router=router,this.name=name,this.fi=t,this.context=s,this.pi=i,this.scope=e,this.options=n,this.clear=0,this.content=new ViewportContent,this.di=null,this.wi=null,this.mi=null,this.cache=[],this.enabled=1}gi(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.Kt.Ns)this.clear=1,t=null;else{const s=this.router.Kt.Yt(t);t=s.St,i=s.It}if(this.di=new ViewportContent(t,i,s,this.context),this.options.vi){const t=this.cache.find(t=>this.di.Zs(t));t?(this.di=t,this.di.Xs=1):this.cache.push(this.di)}return this.content.Ys(this.di)||s.J}yi(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.fi&&(this.scope.fi=t),this.fi!==t&&(this.mi=Object.assign({},this),this.Ci(),this.fi=t,i&&i.Ri&&(this.options.Ri=i.Ri),i&&i.default&&(this.options.default=i.default),i&&i.bi&&(this.options.bi=i.bi),i&&i.Si&&(this.options.Si=i.Si),i&&i.vi&&(this.options.vi=i.vi),this.wi&&this.wi()),this.context!==s&&(this.context=s),this.content.component||this.di&&this.di.component||!this.options.default||this.router.Ei(this.options.default,this)}remove(t,s){return this.fi===t&&this.context===s?(this.content.component&&this.content.li(this.fi,this.options.vi).catch(t=>{throw t}),1):0}async Ii(){if(!this.content.component)return 1;const component=this.content.component;return component.Ii?(Reporter.write(1e4,"viewport canLeave",component.Ii(this.content.Ws,this.di.Ws)),component.Ii(this.content.Ws,this.di.Ws)):1}async Vi(){if(this.clear)return 1;if(!this.di.content)return 0;if(await this.$i(),await this.di.loadComponent(this.context,this.fi),!this.di.component)return 0;const component=this.di.component;if(!component.Vi)return 1;const t=component.Vi(this.di.Ws,this.content.Ws);return Reporter.write(1e4,"viewport canEnter",t),"boolean"==typeof t?t:"string"==typeof t?[new ViewportInstruction(t,this)]:t}async Oi(){if(Reporter.write(1e4,"Viewport enter",this.name),this.clear)return 1;if(!this.di.component)return 0;if(this.di.component.Oi){const t=mergeParameters(this.di.t,this.di.Ws.nt,this.di.content.t);this.di.Ws.t=t.i,this.di.Ws.h=t.h,await this.di.component.Oi(t.o,this.di.Ws,this.content.Ws),this.di.Ks=3}return this.di.ei(),1}async Hi(){return Reporter.write(1e4,"Viewport loadContent",this.name),this.content.component&&(this.content.component.ui&&await this.content.component.ui(this.content.Ws,this.di.Ws),this.di.component||(this.content.ai(this.fi,this.options.vi),this.content.hi(this.options.vi),this.content.ii())),this.di.component&&(this.content.component&&(this.content.ai(this.fi,this.options.vi),this.content.hi(this.options.vi),this.content.ii()),this.di.addComponent(this.fi),this.content=this.di),this.clear&&(this.content=new ViewportContent(null,null,this.di.Ws)),this.di=null,1}ki(){this.mi=null}async Pi(){await this.di.li(this.fi,this.options.vi),this.mi&&Object.assign(this,this.mi)}description(t=0){if(this.content.content){const component=this.content.St();if(t||this.scope||this.options.Ni)return this.router.Kt._s(new ViewportInstruction(component,this,this.content.t,null!==this.scope));const s={};s[component]=component;const i=this.pi._i(s);return this.router.Kt._s(new ViewportInstruction(component,i?null:this,this.content.t))}}ji(t=0){const s=[this.pi.Ti(t),this.description(t)];return this.router.Kt.Ts(s.filter(value=>value&&value.length))}Ai(component){let t=this.options.Ri||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Li(component){if("-"===component||null===component)return 1;let t=this.options.Ri;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}xi(t){this.content.component&&this.content.ei()}Di(t){Reporter.write(1e4,"ATTACHING viewport",this.name,this.content,this.di),this.enabled=1,this.content.component&&this.content.addComponent(this.fi)}Qi(t){Reporter.write(1e4,"DETACHING viewport",this.name),this.content.component&&this.content.ai(this.fi,this.options.vi),this.enabled=0}zi(t){this.content.component&&this.content.hi(this.options.vi)}Ci(){this.options={},this.content=new ViewportContent,this.cache=[]}async $i(){return this.fi?Promise.resolve():new Promise(t=>{this.wi=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.fi=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.Bi=[],this.Fi={},this.Ui=null,this.parent&&this.parent.qi(this)}Gi(){return this.Bi.filter(t=>t.enabled).reduce((t,s)=>(t[s.name]=s,t),{})}_i(t){const instructions=[];let s=0;t&&(this.Ui={},this.Fi={}),this.Ui=Object.assign({},this.Gi(),this.Ui);for(const s in t){const parts=this.router.Kt.js(s),t=this.router.Kt._s(parts.shift());this.Fi[t]||(this.Fi[t]=[]),this.Fi[t].push(parts)}for(const i in this.Fi){const e=this.router.Kt.Yt(i);for(const name in this.Ui){const n=this.Ui[name];if(n&&n.Ai(e.St)){const h=this.Mi(t,this.Fi,e,n);instructions.push(...h.Ji),s=s||h.Wi,this.Ui[name]=null,Reflect.deleteProperty(this.Fi,i);break}}}for(const i in this.Fi){const e=this.router.Kt.Yt(i),name=e.Et;if(!name||!name.length||name.startsWith("?"))continue;const n=e.scope;this.Gi()[name]||(this.Ki(name,null,null,{scope:n,Ni:1}),this.Ui[name]=this.Gi()[name]);const h=this.Ui[name];if(h&&h.Li(e.St)){const n=this.Mi(t,this.Fi,e,h);instructions.push(...n.Ji),s=s||n.Wi,this.Ui[name]=null,Reflect.deleteProperty(this.Fi,i)}}for(const i in this.Fi){const e=this.router.Kt.Yt(i),n=[];for(const name in this.Ui){const t=this.Ui[name];t&&t.Li(e.St)&&n.push(t)}if(1===n.length){const h=n.shift(),r=this.Mi(t,this.Fi,e,h);instructions.push(...r.Ji),s=s||r.Wi,this.Ui[h.name]=null,Reflect.deleteProperty(this.Fi,i);break}}if(s=s||Object.keys(this.Fi).length>0,!t)for(const t of this.children){const i=t._i();instructions.push(...i.Ji),s=s||i.Wi}return{Ji:instructions,Wi:s}}Mi(t,s,i,e){const n=this.router.Kt._s(i);i.Rt(e);const instructions=[i];let h=0;if(s[n].length){const i=e.scope||e.pi;for(const e of s[n])if(e.length){const s={};s[this.router.Kt.Ts(e)]=t[this.router.Kt.Ts([n,...e])];const r=i._i(s);instructions.push(...r.Ji),h=h||r.Wi}}return{Ji:instructions,Wi:h}}Ki(name,t,s,i){let e=this.Gi()[name];if(t&&e&&null!==e.fi&&e.fi!==t&&(e.enabled=0,(e=this.Bi.find(s=>s.name===name&&s.fi===t))&&(e.enabled=1)),!e){let n;i.scope&&(n=new Scope(this.router,t,s,this),this.router.Xi.push(n)),e=new Viewport(this.router,name,null,null,this,n,i),this.Bi.push(e)}return(t||s)&&e.yi(t,s,i),e}Yi(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.Zi(t.scope),this.Bi.splice(this.Bi.indexOf(t),1)),Object.keys(this.Bi).length}Zi(){for(const t of this.children)t.Zi();const t=this.Gi();for(const name in t)this.router.Yi(t[name],null,null)}te(t){return t.Vi().then(()=>t.Hi())}qi(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}se(t=0,s=0){const i=[];for(const e in this.Gi()){const n=this.Gi()[e];(n.options.Si||n.options.bi&&!t)&&!s||i.push(n.ji(t))}for(const s of this.children)i.push(...s.se(t));return i.filter(value=>value&&value.length)}Nt(){const t=this.Bi.filter(t=>t.enabled);for(const s of this.children)t.push(...s.Nt());return t}Ti(t=0){if(!this.fi||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.ie(this.context.get(IContainer).parent);for(;i&&i.pi===this.parent;)s.unshift(i.description(t)),i=this.ie(i.context.get(IContainer).parent);return s.unshift(this.parent.Ti(t)),this.router.Kt.Ts(s.filter(value=>value&&value.length))}ie(t){const s=Object.values(this.Gi());for(;t;){const i=s.find(s=>s.context.get(IContainer)===t);if(i)return i;t=t.parent}return null}}const IRouteTransformer=DI.ne("IRouteTransformer").ee(t=>t.singleton(RouteTable));class Router{constructor(t,s){this.Bt=t,this.Xi=[],this.he={},this.Xt=[],this.re=[],this.m=0,this.oe=[],this.ae=null,this.ce=null,this.le=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.ue(t.anchor).Ti();s=this.Kt.As(i,s)}this.fe.ut(s)}),this.fe=new HistoryBrowser,this.pe=new LinkHandler,this.Kt=new InstructionResolver,this.de=s}get we(){return null!==this.ae}S(t){if(this.m)throw Reporter.error(2001);return this.m=1,this.options=Object.assign({v:t=>{this.me(t)},Fs:this.de.Fs,Us:this.de.Us},t),this.Kt.S({Hs:this.options.Hs}),this.pe.S({v:this.le}),this.fe.S(this.options).catch(t=>{throw t})}$(){if(!this.m)throw Reporter.error(2e3);this.pe.$(),this.fe.$()}me(t){this.oe.push(t),this.ge().catch(t=>{throw t})}async ge(){if(null!==this.ae||!this.oe.length)return Promise.resolve();const t=this.oe.shift();this.ae=t,this.options.ve&&this.options.ve(t);let s=0;(t.st||t.tt)&&t.et&&(t.path=t.et,s=1);let i=t.path;if(this.options.Fs&&!s){const t=this.options.Fs(i,this);i=Array.isArray(t)?this.Kt.ts(t):t}const{xs:e,Ds:n}=this.Kt.Ls(i);e&&(i=n);const h=parseQuery(t.nt);t.t=h.t,t.h=h.list;const r=this.Kt.Qs(i);if(!r&&!Object.keys(r).length&&!e)return this.ae=null,this.ge();const o=e?this.Nt().filter(value=>null!==value.content.component):[],a=this.Nt().filter(value=>value.options.default&&null===value.content.component),c=[];let{Ji:l,Wi:u}=this.ye._i(r),f=100;for(;l.length||u||a.length;){if(!f--)throw Reporter.error(2002);const s=[];for(const i of l){const e=i.viewport,n=this.Kt._s(i,1);e.gi(n,t)&&s.push(e);const h=o.findIndex(value=>value===e);0>h||o.splice(h,1);const r=a.findIndex(value=>value===e);0>r||a.splice(r,1)}for(const i of o)i.gi(this.Kt.Ns,t)&&s.push(i);let i;for(;i=a.shift();)i.gi(i.options.default,t)&&s.push(i);let e=await Promise.all(s.map(value=>value.Ii()));if(e.findIndex(value=>0==value)>=0)return this.Ce([...s,...c],t);if((e=await Promise.all(s.map(async value=>{const t=await value.Vi();if("boolean"==typeof t)return t?value.Oi():0;for(const s of t)this.Ei(s.component,s.viewport);return value.Pi().catch(t=>{throw t}),1}))).some(t=>0==t))return this.Ce([...s,...c],t);for(const t of s)c.find(value=>value===t)||c.push(t);const n=this.ye._i();let h;for(l=[];h=this.re.shift();)n.Ji.find(value=>value.viewport===h.viewport)||l.push(h);l=[...l,...n.Ji],u=n.Wi}await Promise.all(c.map(value=>value.Hi())),await this.Re(t),t.it||t.be||!c.every(t=>t.options.Si)||await this.fe.pop(),c.forEach(t=>{t.ki()}),this.ce=this.ae,this.ce.be&&(this.ce.be=0),this.ae=null,this.ge().catch(t=>{throw t})}Ei(component,t){this.ae?("string"==typeof t&&(t=this.Nt().find(s=>s.name===t)),this.re.push(new ViewportInstruction(component,t))):this.ce&&(this.oe.unshift({path:"",et:"",be:1}),this.ge().catch(t=>{throw t}))}Se(t){return this.Ee(),this.ue(t)}Ki(name,t,s,i){return Reporter.write(1e4,"Viewport added",name,t),this.Se(t).Ki(name,t,s,i)}Yi(t,s,i){const e=t.pi;e.Yi(t,s,i)||this.Zi(e)}Nt(){return this.Ee(),this.ye.Nt()}Zi(t){if(t!==this.ye){t.Zi();const s=this.Xi.indexOf(t);0>s||this.Xi.splice(s,1)}}at(t,s,i){if("string"==typeof t)return this.fe.at(t,s,i)}replace(t,s,i){if("string"==typeof t)return this.fe.replace(t,s,i)}refresh(){return this.fe.refresh()}back(){return this.fe.back()}forward(){return this.fe.forward()}Ie(name,t){const s=this.Ve(name);s&&(s.ss=[]),this.$e(name,t)}$e(name,t){let s=this.he[name];s||(s=this.he[name]=new Nav(this,name)),s.es(t)}Ve(name){return this.he[name]}async Ce(t,s){t.forEach(t=>{t.Pi().catch(t=>{throw t})}),s.B?await this.fe.pop():await this.fe.cancel(),this.ae=null,this.ge().catch(t=>{throw t})}Ee(){if(!this.ye){const t=this.Bt.get(Aurelia).root();this.ye=new Scope(this,t.Oe,t.$context,null),this.Xi.push(this.ye)}}ue(t){let s=closestCustomElement(t).$customElement.$context.get(IContainer);for(;s;){const t=this.Xi.find(t=>t.context.get(IContainer)===s);if(t)return t;s=s.parent}}Re(t){this.Xt=this.ye.se(1,1),this.Xt=this.Kt.zs(this.Xt);let s=this.ye.se();s=this.Kt.zs(s);let i=this.Kt.Bs(s);if(this.options.Us){const t=this.options.Us(this.Kt.Wt(i),this);i=Array.isArray(t)?this.Kt.ts(t):t}let e=this.ye.se(1);e=this.Kt.zs(e);const n=t.nt&&t.nt.length?`?${t.nt}`:"";return this.fe.lt(i+n,this.Kt.Bs(e,1)+n,t)}}Router.inject=[IContainer,IRouteTransformer];class ViewportCustomElement{constructor(router,t,s){this.router=router,this.fi=t,this.He=s,this.name="default",this.scope=null,this.Ri=null,this.default=null,this.bi=null,this.Si=null,this.vi=null,this.viewport=null}ke(t,host,parts,s){const i=this.constructor,dom=s.get(IDOM),template=this.He.Pe(dom,i.description,s,i);template.Ne=createRenderContext(dom,s,i.description.dependencies,i),template.ke(this,host,parts)}bound(){this.connect()}_e(){this.disconnect()}connect(){const t={scope:this.fi.hasAttribute("scope")};this.Ri&&this.Ri.length&&(t.Ri=this.Ri),this.default&&this.default.length&&(t.default=this.default),this.fi.hasAttribute("no-link")&&(t.bi=1),this.fi.hasAttribute("no-history")&&(t.Si=1),this.fi.hasAttribute("stateful")&&(t.vi=1),this.viewport=this.router.Ki(this.name,this.fi,this.$context,t)}disconnect(){this.router.Yi(this.viewport,this.fi,this.$context)}xi(t){this.viewport&&this.viewport.xi(t)}Di(t){this.viewport&&this.viewport.Di(t)}Qi(t){this.viewport&&this.viewport.Qi(t)}zi(t){this.viewport&&this.viewport.zi(t)}}ViewportCustomElement.inject=[Router,INode,IRenderingEngine],__decorate([bindable],ViewportCustomElement.prototype,"name",void 0),__decorate([bindable],ViewportCustomElement.prototype,"scope",void 0),__decorate([bindable],ViewportCustomElement.prototype,"usedBy",void 0),__decorate([bindable],ViewportCustomElement.prototype,"default",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noLink",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noHistory",void 0),__decorate([bindable],ViewportCustomElement.prototype,"stateful",void 0),CustomElementResource.je({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> </div></template>'},ViewportCustomElement);let NavCustomElement=class{constructor(router){this.router=router,this.name=null,this.ss=null,this.level=0}get Te(){const t=this.router.Ve(this.name);return t?t.ss:[]}active(t){return"Active"}};__decorate([bindable],NavCustomElement.prototype,"name",void 0),__decorate([bindable],NavCustomElement.prototype,"routes",void 0),__decorate([bindable],NavCustomElement.prototype,"level",void 0),NavCustomElement=__decorate([inject(Router,Element),customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],NavCustomElement);export{HistoryBrowser,LinkHandler,Nav,QueuedBrowserHistory,HandlerEntry,RouteGenerator,TypesRecord,RecognizeResult,CharSpec,State,StaticSegment,DynamicSegment,StarSegment,EpsilonSegment,RouteRecognizer,IRouteTransformer,Router,Scope,Viewport,ViewportCustomElement,NavCustomElement};
