(function(e,h){"object"==typeof exports&&"undefined"!=typeof module?h(exports,require("@aurelia/jit"),require("@aurelia/runtime-html"),require("@aurelia/kernel"),require("@aurelia/runtime")):"function"==typeof define&&define.h?define(["exports","@aurelia/jit","@aurelia/runtime-html","@aurelia/kernel","@aurelia/runtime"],h):h((e=e||self).jitHtml={},e.jit,e.runtimeHtml,e.kernel,e.runtime)})(this,function(e,jit,runtimeHtml,kernel,runtime){"use strict";function h(e){const h=e.index,{length:s,input:l}=e;for(;s>e.index&&58!==l.charCodeAt(++e.index););return l.slice(h,e.index).trim()}function s(e){++e.index;const{length:h,input:s}=e;let l="",t=0;for(;h>e.index;){switch(t=s.charCodeAt(e.index)){case 59:return++e.index,l.trim();case 47:t=s.charCodeAt(++e.index),l+=`\\${r(t)}`;break;case 39:l+="'";break;default:l+=r(t)}++e.index}return l.trim()}function stringifyDOM(e,h){let s=" ".repeat(h);if(s+=`Node: ${e.nodeName}`,3===e.nodeType&&(s+=` "${e.textContent}"`),1===e.nodeType){let h,l=0;const t=e.attributes,c=t.length;for(;c>l;++l)s+=` ${(h=t[l]).name}=${h.value}`}if(s+="\n",1===e.nodeType){let l=0,childNodes=e.childNodes,t=childNodes.length;for(;t>l;++l)s+=stringifyDOM(childNodes[l],h+1);if("TEMPLATE"===e.nodeName)for(l=0,t=(childNodes=e.content.childNodes).length;t>l;++l)s+=stringifyDOM(childNodes[l],h+1)}return s}function stringifyInstructions(e,h){let s=" ".repeat(h);switch(e.type){case"ha":s+="textBinding\n";break;case"rh":s+="callBinding\n";break;case"rk":s+="iteratorBinding\n";break;case"hb":s+="listenerBinding\n";break;case"rg":s+="propertyBinding\n";break;case"rj":s+="refBinding\n";break;case"hc":s+="stylePropertyBinding\n";break;case"re":s+="setProperty\n";break;case"hd":s+="setAttribute\n";break;case"rf":s+="interpolation\n";break;case"rd":s+="hydrateLetElement\n",e.instructions.forEach(e=>{s+=stringifyInstructions(e,h+1)});break;case"rb":s+=`hydrateAttribute: ${e.res}\n`,e.instructions.forEach(e=>{s+=stringifyInstructions(e,h+1)});break;case"ra":s+=`hydrateElement: ${e.res}\n`,e.instructions.forEach(e=>{s+=stringifyInstructions(e,h+1)});break;case"rc":s+=`hydrateTemplateController: ${e.res}\n`,s+=stringifyTemplateDefinition(e.def,h+1),e.instructions.forEach(e=>{s+=stringifyInstructions(e,h+1)})}return s}function stringifyTemplateDefinition(def,e){const h=" ".repeat(e);let s=h;return s+=`TemplateDefinition: ${def.name}\n`,s+=stringifyDOM(def.template,e+1),s+=`${h} Instructions:\n`,def.instructions.forEach(l=>{s+=`${h}  Row:\n`,l.forEach(h=>{s+=stringifyInstructions(h,e+3)})}),s}class TriggerBindingCommand{constructor(){this.s=86}compile(e){return new runtimeHtml.TriggerBindingInstruction(e.l,jit.getTarget(e,0))}}jit.BindingCommandResource.t("trigger",TriggerBindingCommand);class DelegateBindingCommand{constructor(){this.s=88}compile(e){return new runtimeHtml.DelegateBindingInstruction(e.l,jit.getTarget(e,0))}}jit.BindingCommandResource.t("delegate",DelegateBindingCommand);class CaptureBindingCommand{constructor(){this.s=87}compile(e){return new runtimeHtml.CaptureBindingInstruction(e.l,jit.getTarget(e,0))}}jit.BindingCommandResource.t("capture",CaptureBindingCommand),kernel.Profiler.o("TemplateBinder");const l={id:1,u:1,i:1},t={k:1,u:1,i:1};class TemplateBinder{constructor(dom,e,h,s){this.dom=dom,this.T=e,this.$=h,this.v=s,this.A=null,this.manifest=null,this.C=null,this.L=null,this.M=null}bind(e){const h=this.A,s=this.L,t=this.C,c=this.manifest,r=this.A=this.manifest=new jit.PlainElementSymbol(e),o=e.attributes;let n=0;for(;o.length>n;){const e=o[n],h=this.$.parse(e.name,e.value);if(1==l[h.target])throw Error(`Invalid surrogate attribute: ${h.target}`);const s=this.T.q(h);if(null===s)this.O(h);else{if(s.isTemplateController)throw Error("Cannot have template controller on surrogate element.");this.B(h,s)}++n}return this.D(e),this.A=h,this.L=s,this.C=t,this.manifest=c,r}F(e,h){switch(h.nodeName){case"LET":return void this._(e,h);case"SLOT":return void(this.A.hasSlots=1)}const s=this.L,l=this.C,t=this.manifest;let c;this.M=h.getAttribute("part");let name=h.getAttribute("as-element");null===name&&(name=h.nodeName.toLowerCase());const r=this.T.G(name);null===r?this.manifest=new jit.PlainElementSymbol(h):(this.L=this.C,c=this.C=this.manifest=new jit.CustomElementSymbol(this.dom,h,r)),this.D(h),this.J(h,e),void 0!==c&&c.K?h.parentNode.replaceChild(c.marker,h):this.manifest.U&&h.classList.add("au"),this.L=s,this.C=l,this.manifest=t}_(e,h){const s=new jit.LetElementSymbol(this.dom,h);e.childNodes.push(s);const l=h.attributes;let t=0;for(;l.length>t;){const e=l[t];if("to-view-model"===e.name){h.removeAttribute("to-view-model"),s.toViewModel=1;continue}const c=this.$.parse(e.name,e.value),r=this.T.W(c),o=this.v.parse(c.X,null===r?2048:r.s),to=kernel.PLATFORM.Y(c.target),n=new jit.BindableInfo(to,runtime.BindingMode.Z);s.H.push(new jit.BindingSymbol(r,n,o,c.X,to)),++t}h.parentNode.replaceChild(s.marker,h)}J(e,h){const{L:s,C:l,manifest:c}=this;let r=c;const o=this.p(e);let n,f;const u=e.attributes;let i=0;for(;u.length>i;){const e=u[i];if(++i,1==t[e.name])continue;const h=this.$.parse(e.name,e.value),s=this.T.q(h);null===s?this.O(h):s.isTemplateController?(f=c.templateController=this.V(h,s),r===c?(f.template=c,r=f):(f.templateController=n,f.template=n.template,n.template=f),n=f):this.B(h,s)}(function(dom,e,h){const s=h.P;let l,t=e;for(;t!==h;)t.template===h?(s.parentNode.replaceChild(t.marker,s),"TEMPLATE"===s.nodeName?(t.P=s,s.remove()):(l=t.P=dom.N()).content.appendChild(s)):(l=t.P=dom.N()).content.appendChild(t.marker),s.removeAttribute(t.R.m),t=t.template})(this.dom,r,c),null===o?h.childNodes.push(r):(o.parent=h,o.template=r,(c===l?s:l).parts.push(o),(function(dom,e,h){let s,l;"TEMPLATE"===(s=512&h.flags?h.marker:h.P).nodeName?e.P=s:(l=e.P=dom.N()).content.appendChild(s)})(this.dom,o,r))}D(e){let h,s;for(h="TEMPLATE"===e.nodeName?e.content.firstChild:e.firstChild;null!==h;)switch(h.nodeType){case 1:s=h.nextSibling,this.F(this.manifest,h),h=s;break;case 3:h=this.j(h).nextSibling;break;case 4:case 7:case 8:case 10:h=h.nextSibling;break;case 9:case 11:h=h.firstChild}}j(e){const h=this.v.parse(e.wholeText,2048);if(null!==h){const s=new jit.TextSymbol(this.dom,e,h);this.manifest.childNodes.push(s),(function(e){const h=e.P,s=h.parentNode;for(;null!==h.nextSibling&&3===h.nextSibling.nodeType;)s.removeChild(h.nextSibling);h.textContent="",s.insertBefore(e.marker,h)})(s)}for(;null!==e.nextSibling&&3===e.nextSibling.nodeType;)e=e.nextSibling;return e}V(e,h){let s;const l=this.T.W(e);if(null===l&&h.I)s=new jit.TemplateControllerSymbol(this.dom,e,h,this.M),this.M=null,this.g(s,h,e.X);else{s=new jit.TemplateControllerSymbol(this.dom,e,h,this.M);const t=this.v.parse(e.X,null===l?2048:l.s);s.H.push(new jit.BindingSymbol(l,h.bindable,t,e.X,e.target)),this.M=null}return s}B(e,h){const s=this.T.W(e);let l;if(null===s&&h.I)l=new jit.CustomAttributeSymbol(e,h),this.g(l,h,e.X);else{l=new jit.CustomAttributeSymbol(e,h);const t=this.v.parse(e.X,null===s?2048:s.s);l.H.push(new jit.BindingSymbol(s,h.bindable,t,e.X,e.target))}this.manifest.attributes.push(l),this.manifest.U=1}g(e,l,value){const t=(function(e){const l=[],t=new c(e),r=t.length;let name,value;for(;r>t.index;){if(0===(name=h(t)).length)return l;value=s(t),l.push({name,value})}return l})(value);let r;for(let h=0,s=t.length;s>h;++h){const s=this.$.parse((r=t[h]).name,r.value),c=this.T.W(s),o=this.v.parse(s.X,null===c?2048:c.s);let bindable=l.bindables[s.target];void 0===bindable&&(bindable=l.bindables[s.target]=new jit.BindableInfo(s.target,runtime.BindingMode.Z)),e.H.push(new jit.BindingSymbol(c,bindable,o,s.X,s.target))}}O(e){if(0===e.X.length)return;const h=this.T.W(e),s=this.manifest,l=this.v.parse(e.X,null===h?2048:h.s);if(16&s.flags){const bindable=s.bindables[e.target];void 0!==bindable?(s.H.push(new jit.BindingSymbol(h,bindable,l,e.X,e.target)),s.U=1):null===l&&"ref"!==e.target||(s.attributes.push(new jit.PlainAttributeSymbol(e,h,l)),s.U=1)}else null!==l||"ref"===e.target?(s.attributes.push(new jit.PlainAttributeSymbol(e,h,l)),s.U=1):s===this.A&&s.attributes.push(new jit.PlainAttributeSymbol(e,h,l))}p(e){const name=e.getAttribute("replace-part");return null===name?null:(e.removeAttribute("replace-part"),new jit.ReplacePartSymbol(name))}}class c{constructor(e){this.input=e,this.index=0,this.length=e.length}}const r=String.fromCharCode;var o;(function(e){e[e.S=34]="DoubleQuote",e[e.ee=39]="SingleQuote",e[e.he=47]="Slash",e[e.se=59]="Semicolon",e[e.le=58]="Colon"})(o||(o={}));const ITemplateElementFactory=kernel.DI.ce("ITemplateElementFactory").te();kernel.Profiler.o("TemplateElementFactory");class n{constructor(dom){this.dom=dom,this.template=dom.N()}static register(e){return kernel.Registration.singleton(ITemplateElementFactory,this).register(e)}N(e){if("string"==typeof e){const template=this.template;template.innerHTML=e;const h=template.content.firstElementChild;return null===h||"TEMPLATE"!==h.nodeName||null!==h.nextElementSibling?(this.template=this.dom.N(),template):(template.content.removeChild(h),h)}if("TEMPLATE"!==e.nodeName){const template=this.dom.N();return template.content.appendChild(e),template}return null!==e.parentNode&&e.parentNode.removeChild(e),e}}n.inject=[runtime.IDOM];const f=Object.freeze({required:0,compiler:"default"});kernel.Profiler.o("TemplateCompiler");class u{constructor(e,h,s){this.re=e,this.$=h,this.v=s,this.oe=null}get name(){return"default"}static register(e){return kernel.Registration.singleton(runtime.ITemplateCompiler,this).register(e)}compile(dom,e,h){const s=new TemplateBinder(dom,new jit.ResourceModel(h),this.$,this.v),template=e.template=this.re.N(e.template),l=s.bind(template);void 0!==e.instructions&&e.instructions!==kernel.PLATFORM.ne||(e.instructions=[]),1==l.hasSlots&&(e.hasSlots=1),this.oe=e.instructions;const t=l.attributes,c=t.length;if(c>0){let surrogates;void 0!==e.surrogates&&e.surrogates!==kernel.PLATFORM.ne||(e.surrogates=Array(c)),surrogates=e.surrogates;for(let e=0;c>e;++e)surrogates[e]=this.fe(t[e])}return this.ue(l),this.oe=null,e}ue(e){if(8192&e.flags){const{childNodes}=e;let h;const s=childNodes.length;for(let e=0;s>e;++e)if(128&(h=childNodes[e]).flags)this.oe.push([new runtimeHtml.TextBindingInstruction(h.ie)]);else if(32&h.flags){const e=h.H,instructions=[];let s;const l=e.length;for(let h=0;l>h;++h)instructions[h]=new runtime.LetBindingInstruction((s=e[h]).l,s.target);this.oe.push([new runtime.LetElementInstruction(instructions,h.toViewModel)])}else this.ke(h)}}we(e){const h=this.Ee(e,1);h[0]=new runtime.HydrateElementInstruction(e.res,this.Te(e),this.$e(e)),this.oe.push(h)}ve(e){const h=this.Ee(e,0);h.length>0&&this.oe.push(h),this.ue(e)}ke(e){switch(511&e.flags){case 16:this.we(e);break;case 64:this.ve(e);break;case 1:this.Ae(e)}}Ae(e){const h=this.Te(e),s=this.oe,l=this.oe=[];this.ke(e.template),this.oe=s,this.oe.push([new runtime.HydrateTemplateController({name:null===e.M?e.res:e.M,template:e.P,instructions:l,build:f},e.res,h,"else"===e.res)])}Te(e){let h;if(4096&e.flags){const{H:s}=e,l=s.length;h=Array(l);let t=0;for(;l>t;++t)h[t]=this.Ce(s[t])}else h=kernel.PLATFORM.ne;return h}Ce(e){return null===e.command?null===e.l?new runtime.SetPropertyInstruction(e.X,e.bindable.Le):new runtime.InterpolationInstruction(e.l,e.bindable.Le):e.command.compile(e)}Ee(e,h){let s;if(2048&e.flags){const{attributes:l}=e,t=l.length;s=Array(h+t);for(let e=0;t>e;++e)s[e+h]=this.fe(l[e])}else s=h>0?Array(h):kernel.PLATFORM.ne;return s}Me(e){const h=this.Te(e);return new runtime.HydrateAttributeInstruction(e.res,h)}qe(e){return null===e.command?null===e.l?new runtimeHtml.SetAttributeInstruction(e.R.X,e.R.target):new runtime.InterpolationInstruction(e.l,e.R.target):e.command.compile(e)}fe(e){return"ref"===e.R.target?new runtime.RefBindingInstruction(e.R.X):4&e.flags?this.Me(e):this.qe(e)}$e(e){let parts;if(16384&e.flags){parts={};const h=e.parts,s=h.length;let l,t,c;for(let e=0;s>e;++e)c=h[e],l=this.oe,t=this.oe=[],this.ke(c.template),parts[c.name]={name:c.name,template:c.P,instructions:t,build:f},this.oe=l}else parts=kernel.PLATFORM.Oe;return parts}}u.inject=[ITemplateElementFactory,jit.IAttributeParser,runtime.IExpressionParser];const ITemplateCompilerRegistration=u,ITemplateElementFactoryRegistration=n,DefaultComponents=[ITemplateCompilerRegistration,ITemplateElementFactoryRegistration],TriggerBindingCommandRegistration=TriggerBindingCommand,DelegateBindingCommandRegistration=DelegateBindingCommand,CaptureBindingCommandRegistration=CaptureBindingCommand,DefaultBindingLanguage=[TriggerBindingCommandRegistration,DelegateBindingCommandRegistration,CaptureBindingCommandRegistration],BasicConfiguration={register:e=>runtimeHtml.BasicConfiguration.register(e).register(...jit.DefaultComponents,...jit.DefaultBindingSyntax,...jit.DefaultBindingLanguage,...DefaultComponents,...DefaultBindingLanguage),Be(){return this.register(kernel.DI.Be())}};e.TriggerBindingCommand=TriggerBindingCommand,e.DelegateBindingCommand=DelegateBindingCommand,e.CaptureBindingCommand=CaptureBindingCommand,e.ITemplateCompilerRegistration=ITemplateCompilerRegistration,e.ITemplateElementFactoryRegistration=ITemplateElementFactoryRegistration,e.DefaultComponents=DefaultComponents,e.TriggerBindingCommandRegistration=TriggerBindingCommandRegistration,e.DelegateBindingCommandRegistration=DelegateBindingCommandRegistration,e.CaptureBindingCommandRegistration=CaptureBindingCommandRegistration,e.DefaultBindingLanguage=DefaultBindingLanguage,e.BasicConfiguration=BasicConfiguration,e.stringifyDOM=stringifyDOM,e.stringifyInstructions=stringifyInstructions,e.stringifyTemplateDefinition=stringifyTemplateDefinition,e.TemplateBinder=TemplateBinder,e.ITemplateElementFactory=ITemplateElementFactory,Object.defineProperty(e,"De",{value:1})});
