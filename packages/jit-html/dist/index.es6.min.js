function processInterpolationText(e){const t=e.t,n=t.parentNode;for(;null!==t.nextSibling&&3===t.nextSibling.nodeType;)n.removeChild(t.nextSibling);t.textContent="",n.insertBefore(e.marker,t)}function processTemplateControllers(dom,e,t){const n=t.t;let i,r=e;for(;r!==t;)r.template===t?(n.parentNode.replaceChild(r.marker,n),"TEMPLATE"===n.nodeName?(r.t=n,n.remove()):(i=r.t=dom.i()).content.appendChild(n)):(i=r.t=dom.i()).content.appendChild(r.marker),n.removeAttribute(r.o.l),r=r.template}function processReplacePart(dom,e,t){let n,i;"TEMPLATE"===(n=512&t.flags?t.marker:t.t).nodeName?e.t=n:(i=e.t=dom.i()).content.appendChild(n)}function parseMultiAttributeBinding(e){const t=[],n=new ParserState(e),i=n.length;let name,value;for(;i>n.index;){if(0===(name=scanAttributeName(n)).length)return t;value=scanAttributeValue(n),t.push({name,value})}return t}function scanAttributeName(e){const t=e.index,{length:n,input:i}=e;for(;n>e.index&&58!==i.charCodeAt(++e.index););return i.slice(t,e.index).trim()}function scanAttributeValue(e){++e.index;const{length:t,input:n}=e;let i="",r=0;for(;t>e.index;){switch(r=n.charCodeAt(e.index)){case 59:return++e.index,i.trim();case 47:r=n.charCodeAt(++e.index),i+=`\\${fromCharCode(r)}`;break;case 39:i+="'";break;default:i+=fromCharCode(r)}++e.index}return i.trim()}function stringifyDOM(e,t){let n=" ".repeat(t);if(n+=`Node: ${e.nodeName}`,3===e.nodeType&&(n+=` "${e.textContent}"`),1===e.nodeType){let t,i=0;const r=e.attributes,l=r.length;for(;l>i;++i)n+=` ${(t=r[i]).name}=${t.value}`}if(n+="\n",1===e.nodeType){let i=0,childNodes=e.childNodes,r=childNodes.length;for(;r>i;++i)n+=stringifyDOM(childNodes[i],t+1);if("TEMPLATE"===e.nodeName)for(i=0,r=(childNodes=e.content.childNodes).length;r>i;++i)n+=stringifyDOM(childNodes[i],t+1)}return n}function stringifyInstructions(e,t){let n=" ".repeat(t);switch(e.type){case"ha":n+="textBinding\n";break;case"rh":n+="callBinding\n";break;case"rk":n+="iteratorBinding\n";break;case"hb":n+="listenerBinding\n";break;case"rg":n+="propertyBinding\n";break;case"rj":n+="refBinding\n";break;case"hc":n+="stylePropertyBinding\n";break;case"re":n+="setProperty\n";break;case"hd":n+="setAttribute\n";break;case"rf":n+="interpolation\n";break;case"rd":n+="hydrateLetElement\n",e.instructions.forEach(e=>{n+=stringifyInstructions(e,t+1)});break;case"rb":n+=`hydrateAttribute: ${e.res}\n`,e.instructions.forEach(e=>{n+=stringifyInstructions(e,t+1)});break;case"ra":n+=`hydrateElement: ${e.res}\n`,e.instructions.forEach(e=>{n+=stringifyInstructions(e,t+1)});break;case"rc":n+=`hydrateTemplateController: ${e.res}\n`,n+=stringifyTemplateDefinition(e.def,t+1),e.instructions.forEach(e=>{n+=stringifyInstructions(e,t+1)})}return n}function stringifyTemplateDefinition(def,e){const t=" ".repeat(e);let n=t;return n+=`TemplateDefinition: ${def.name}\n`,n+=stringifyDOM(def.template,e+1),n+=`${t} Instructions:\n`,def.instructions.forEach(i=>{n+=`${t}  Row:\n`,i.forEach(t=>{n+=stringifyInstructions(t,e+3)})}),n}import{getTarget,BindingCommandResource,PlainElementSymbol,CustomElementSymbol,LetElementSymbol,BindableInfo,BindingSymbol,TextSymbol,TemplateControllerSymbol,CustomAttributeSymbol,PlainAttributeSymbol,ReplacePartSymbol,ResourceModel,IAttributeParser,JitConfiguration}from"@aurelia/jit";import{TriggerBindingInstruction,DelegateBindingInstruction,CaptureBindingInstruction,TextBindingInstruction,SetAttributeInstruction,HTMLRuntimeConfiguration}from"@aurelia/runtime-html";import{PLATFORM,DI,Registration}from"@aurelia/kernel";import{BindingMode,IDOM,LetBindingInstruction,LetElementInstruction,HydrateElementInstruction,HydrateTemplateController,SetPropertyInstruction,InterpolationInstruction,HydrateAttributeInstruction,RefBindingInstruction,IExpressionParser,ITemplateCompiler}from"@aurelia/runtime";class TriggerBindingCommand{constructor(){this.s=86}compile(e){return new TriggerBindingInstruction(e.u,getTarget(e,0))}}BindingCommandResource.h("trigger",TriggerBindingCommand);class DelegateBindingCommand{constructor(){this.s=88}compile(e){return new DelegateBindingInstruction(e.u,getTarget(e,0))}}BindingCommandResource.h("delegate",DelegateBindingCommand);class CaptureBindingCommand{constructor(){this.s=87}compile(e){return new CaptureBindingInstruction(e.u,getTarget(e,0))}}BindingCommandResource.h("capture",CaptureBindingCommand);const invalidSurrogateAttribute={id:1,m:1,T:1},attributesToIgnore={g:1,m:1,T:1};class TemplateBinder{constructor(dom,e,t,n){this.dom=dom,this.C=e,this.B=t,this.p=n,this.A=null,this.manifest=null,this.L=null,this.I=null,this.M=null}bind(e){const t=this.A,n=this.I,i=this.L,r=this.manifest,l=this.A=this.manifest=new PlainElementSymbol(e),o=e.attributes;let s=0;for(;o.length>s;){const e=o[s],t=this.B.parse(e.name,e.value);if(1==invalidSurrogateAttribute[t.target])throw Error(`Invalid surrogate attribute: ${t.target}`);const n=this.C.k(t);if(null===n)this.D(t);else{if(n.isTemplateController)throw Error("Cannot have template controller on surrogate element.");this.H(t,n)}++s}return this.P(e),this.A=t,this.I=n,this.L=i,this.manifest=r,l}O(e,t){switch(t.nodeName){case"LET":return void this.F(e,t);case"SLOT":return void(this.A.hasSlots=1)}const n=this.I,i=this.L,r=this.manifest;let l;this.M=t.getAttribute("part");let name=t.getAttribute("as-element");null===name&&(name=t.nodeName.toLowerCase());const o=this.C.R(name);null===o?this.manifest=new PlainElementSymbol(t):(this.I=this.L,l=this.L=this.manifest=new CustomElementSymbol(this.dom,t,o)),this.P(t),this.$(t,e),void 0!==l&&l.S?t.parentNode.replaceChild(l.marker,t):this.manifest.v&&t.classList.add("au"),this.I=n,this.L=i,this.manifest=r}F(e,t){const n=new LetElementSymbol(this.dom,t);e.childNodes.push(n);const i=t.attributes;let r=0;for(;i.length>r;){const e=i[r];if("to-view-model"===e.name){t.removeAttribute("to-view-model"),n.toViewModel=1;continue}const l=this.B.parse(e.name,e.value),o=this.C.J(l),s=this.p.parse(l.q,null===o?2048:o.s),to=PLATFORM.G(l.target),u=new BindableInfo(to,BindingMode.K);n.U.push(new BindingSymbol(o,u,s,l.q,to)),++r}t.parentNode.replaceChild(n.marker,t)}$(e,t){const{I:n,L:i,manifest:r}=this;let l=r;const o=this.W(e);let s,u;const c=e.attributes;let h=0;for(;c.length>h;){const e=c[h];if(++h,1==attributesToIgnore[e.name])continue;const t=this.B.parse(e.name,e.value),n=this.C.k(t);null===n?this.D(t):n.isTemplateController?(u=r.templateController=this.X(t,n),l===r?(u.template=r,l=u):(u.templateController=s,u.template=s.template,s.template=u),s=u):this.H(t,n)}processTemplateControllers(this.dom,l,r),null===o?t.childNodes.push(l):(o.parent=t,o.template=l,(r===i?n:i).parts.push(o),processReplacePart(this.dom,o,l))}P(e){let t,n;for(t="TEMPLATE"===e.nodeName?e.content.firstChild:e.firstChild;null!==t;)switch(t.nodeType){case 1:n=t.nextSibling,this.O(this.manifest,t),t=n;break;case 3:t=this.Y(t).nextSibling;break;case 4:case 7:case 8:case 10:t=t.nextSibling;break;case 9:case 11:t=t.firstChild}}Y(e){const t=this.p.parse(e.wholeText,2048);if(null!==t){const n=new TextSymbol(this.dom,e,t);this.manifest.childNodes.push(n),processInterpolationText(n)}for(;null!==e.nextSibling&&3===e.nextSibling.nodeType;)e=e.nextSibling;return e}X(e,t){let n;const i=this.C.J(e);if(null===i&&t.Z)n=new TemplateControllerSymbol(this.dom,e,t,this.M),this.M=null,this._(n,t,e.q);else{n=new TemplateControllerSymbol(this.dom,e,t,this.M);const r=this.p.parse(e.q,null===i?2048:i.s);n.U.push(new BindingSymbol(i,t.bindable,r,e.q,e.target)),this.M=null}return n}H(e,t){const n=this.C.J(e);let i;if(null===n&&t.Z)i=new CustomAttributeSymbol(e,t),this._(i,t,e.q);else{i=new CustomAttributeSymbol(e,t);const r=this.p.parse(e.q,null===n?2048:n.s);i.U.push(new BindingSymbol(n,t.bindable,r,e.q,e.target))}this.manifest.attributes.push(i),this.manifest.v=1}_(e,t,value){const n=parseMultiAttributeBinding(value);let i;for(let r=0,l=n.length;l>r;++r){const l=this.B.parse((i=n[r]).name,i.value),o=this.C.J(l),s=this.p.parse(l.q,null===o?2048:o.s);let bindable=t.bindables[l.target];void 0===bindable&&(bindable=t.bindables[l.target]=new BindableInfo(l.target,BindingMode.K)),e.U.push(new BindingSymbol(o,bindable,s,l.q,l.target))}}D(e){if(0===e.q.length)return;const t=this.C.J(e),n=this.manifest,i=this.p.parse(e.q,null===t?2048:t.s);if(16&n.flags){const bindable=n.bindables[e.target];void 0!==bindable?(n.U.push(new BindingSymbol(t,bindable,i,e.q,e.target)),n.v=1):null===i&&"ref"!==e.target||(n.attributes.push(new PlainAttributeSymbol(e,t,i)),n.v=1)}else null!==i||"ref"===e.target?(n.attributes.push(new PlainAttributeSymbol(e,t,i)),n.v=1):n===this.A&&n.attributes.push(new PlainAttributeSymbol(e,t,i))}W(e){const name=e.getAttribute("replace-part");return null===name?null:(e.removeAttribute("replace-part"),new ReplacePartSymbol(name))}}class ParserState{constructor(e){this.input=e,this.index=0,this.length=e.length}}const fromCharCode=String.fromCharCode,ITemplateElementFactory=DI.V("ITemplateElementFactory").N();class HTMLTemplateElementFactory{constructor(dom){this.dom=dom,this.template=dom.i()}i(e){if("string"==typeof e){const template=this.template;template.innerHTML=e;const t=template.content.firstElementChild;return null===t||"TEMPLATE"!==t.nodeName||null!==t.nextElementSibling?(this.template=this.dom.i(),template):(template.content.removeChild(t),t)}if("TEMPLATE"!==e.nodeName){const template=this.dom.i();return template.content.appendChild(e),template}return null!==e.parentNode&&e.parentNode.removeChild(e),e}}HTMLTemplateElementFactory.inject=[IDOM];const buildNotRequired=Object.freeze({required:0,compiler:"default"});class TemplateCompiler{constructor(e,t,n){this.j=e,this.B=t,this.p=n,this.ee=null}get name(){return"default"}compile(dom,e,t){const n=new TemplateBinder(dom,new ResourceModel(t),this.B,this.p),template=e.template=this.j.i(e.template),i=n.bind(template);void 0!==e.instructions&&e.instructions!==PLATFORM.te||(e.instructions=[]),1==i.hasSlots&&(e.hasSlots=1),this.ee=e.instructions;const r=i.attributes,l=r.length;if(l>0){let surrogates;void 0!==e.surrogates&&e.surrogates!==PLATFORM.te||(e.surrogates=Array(l)),surrogates=e.surrogates;for(let e=0;l>e;++e)surrogates[e]=this.ne(r[e])}return this.ie(i),this.ee=null,e}ie(e){if(8192&e.flags){const{childNodes}=e;let t;const n=childNodes.length;for(let e=0;n>e;++e)if(128&(t=childNodes[e]).flags)this.ee.push([new TextBindingInstruction(t.re)]);else if(32&t.flags){const e=t.U,instructions=[];let n;const i=e.length;for(let t=0;i>t;++t)instructions[t]=new LetBindingInstruction((n=e[t]).u,n.target);this.ee.push([new LetElementInstruction(instructions,t.toViewModel)])}else this.le(t)}}oe(e){const t=this.se(e,1);t[0]=new HydrateElementInstruction(e.res,this.ue(e),this.ce(e)),this.ee.push(t)}he(e){const t=this.se(e,0);t.length>0&&this.ee.push(t),this.ie(e)}le(e){switch(511&e.flags){case 16:this.oe(e);break;case 64:this.he(e);break;case 1:this.me(e)}}me(e){const t=this.ue(e),n=this.ee,i=this.ee=[];this.le(e.template),this.ee=n,this.ee.push([new HydrateTemplateController({name:null===e.M?e.res:e.M,template:e.t,instructions:i,build:buildNotRequired},e.res,t,"else"===e.res)])}ue(e){let t;if(4096&e.flags){const{U:n}=e,i=n.length;t=Array(i);let r=0;for(;i>r;++r)t[r]=this.ae(n[r])}else t=PLATFORM.te;return t}ae(e){return null===e.command?null===e.u?new SetPropertyInstruction(e.q,e.bindable.Te):new InterpolationInstruction(e.u,e.bindable.Te):e.command.compile(e)}se(e,t){let n;if(2048&e.flags){const{attributes:i}=e,r=i.length;n=Array(t+r);for(let e=0;r>e;++e)n[e+t]=this.ne(i[e])}else n=t>0?Array(t):PLATFORM.te;return n}fe(e){const t=this.ue(e);return new HydrateAttributeInstruction(e.res,t)}ge(e){return null===e.command?null===e.u?new SetAttributeInstruction(e.o.q,e.o.target):new InterpolationInstruction(e.u,e.o.target):e.command.compile(e)}ne(e){return"ref"===e.o.target?new RefBindingInstruction(e.o.q):4&e.flags?this.fe(e):this.ge(e)}ce(e){let parts;if(16384&e.flags){parts={};const t=e.parts,n=t.length;let i,r,l;for(let e=0;n>e;++e)l=t[e],i=this.ee,r=this.ee=[],this.le(l.template),parts[l.name]={name:l.name,template:l.t,instructions:r,build:buildNotRequired},this.ee=i}else parts=PLATFORM.de;return parts}}TemplateCompiler.inject=[ITemplateElementFactory,IAttributeParser,IExpressionParser];const HTMLBindingLanguage=[TriggerBindingCommand,DelegateBindingCommand,CaptureBindingCommand],HTMLTemplateCompiler=[Registration.singleton(ITemplateCompiler,TemplateCompiler),Registration.singleton(ITemplateElementFactory,HTMLTemplateElementFactory)],HTMLJitConfiguration={register(e){e.register(HTMLRuntimeConfiguration,...HTMLTemplateCompiler,JitConfiguration,...HTMLBindingLanguage)},Ce(){const e=DI.Ce();return e.register(HTMLJitConfiguration),e}};export{TriggerBindingCommand,DelegateBindingCommand,CaptureBindingCommand,HTMLBindingLanguage,HTMLTemplateCompiler,HTMLJitConfiguration,stringifyDOM,stringifyInstructions,stringifyTemplateDefinition,TemplateBinder,ITemplateElementFactory};
