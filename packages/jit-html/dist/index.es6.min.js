function processInterpolationText(t){const e=t.t,n=e.parentNode;for(;null!==e.nextSibling&&3===e.nextSibling.nodeType;)n.removeChild(e.nextSibling);e.textContent="",n.insertBefore(t.marker,e)}function processTemplateControllers(dom,t,e){const n=e.t;let i,r=t;for(;r!==e;)r.template===e?(n.parentNode.replaceChild(r.marker,n),"TEMPLATE"===n.nodeName?(r.t=n,n.remove()):(i=r.t=dom.i()).content.appendChild(n)):(i=r.t=dom.i()).content.appendChild(r.marker),n.removeAttribute(r.l.o),r=r.template}function processReplacePart(dom,t,e){let n,i;"TEMPLATE"===(n=512&e.flags?e.marker:e.t).nodeName?t.t=n:(i=t.t=dom.i()).content.appendChild(n)}function parseMultiAttributeBinding(t){const e=[],n=new ParserState(t),i=n.length;let name,value;for(;i>n.index;){if(0===(name=scanAttributeName(n)).length)return e;value=scanAttributeValue(n),e.push({name,value})}return e}function scanAttributeName(t){const e=t.index,{length:n,input:i}=t;for(;n>t.index&&58!==i.charCodeAt(++t.index););return i.slice(e,t.index).trim()}function scanAttributeValue(t){++t.index;const{length:e,input:n}=t;let i="",r=0;for(;e>t.index;){switch(r=n.charCodeAt(t.index)){case 59:return++t.index,i.trim();case 47:r=n.charCodeAt(++t.index),i+=`\\${fromCharCode(r)}`;break;case 39:i+="'";break;default:i+=fromCharCode(r)}++t.index}return i.trim()}function stringifyDOM(t,e){let n=" ".repeat(e);if(n+=`Node: ${t.nodeName}`,3===t.nodeType&&(n+=` "${t.textContent}"`),1===t.nodeType){let e,i=0;const r=t.attributes,o=r.length;for(;o>i;++i)n+=` ${(e=r[i]).name}=${e.value}`}if(n+="\n",1===t.nodeType){let i=0,childNodes=t.childNodes,r=childNodes.length;for(;r>i;++i)n+=stringifyDOM(childNodes[i],e+1);if("TEMPLATE"===t.nodeName)for(i=0,r=(childNodes=t.content.childNodes).length;r>i;++i)n+=stringifyDOM(childNodes[i],e+1)}return n}function stringifyInstructions(t,e){let n=" ".repeat(e);switch(t.type){case"ha":n+="textBinding\n";break;case"rh":n+="callBinding\n";break;case"rk":n+="iteratorBinding\n";break;case"hb":n+="listenerBinding\n";break;case"rg":n+="propertyBinding\n";break;case"rj":n+="refBinding\n";break;case"hc":n+="stylePropertyBinding\n";break;case"re":n+="setProperty\n";break;case"hd":n+="setAttribute\n";break;case"rf":n+="interpolation\n";break;case"rd":n+="hydrateLetElement\n",t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)});break;case"rb":n+=`hydrateAttribute: ${t.res}\n`,t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)});break;case"ra":n+=`hydrateElement: ${t.res}\n`,t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)});break;case"rc":n+=`hydrateTemplateController: ${t.res}\n`,n+=stringifyTemplateDefinition(t.def,e+1),t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)})}return n}function stringifyTemplateDefinition(def,t){const e=" ".repeat(t);let n=e;return n+=`TemplateDefinition: ${def.name}\n`,n+=stringifyDOM(def.template,t+1),n+=`${e} Instructions:\n`,def.instructions.forEach(i=>{n+=`${e}  Row:\n`,i.forEach(e=>{n+=stringifyInstructions(e,t+3)})}),n}import{getTarget,BindingCommandResource,PlainElementSymbol,CustomElementSymbol,LetElementSymbol,BindableInfo,BindingSymbol,TextSymbol,TemplateControllerSymbol,CustomAttributeSymbol,PlainAttributeSymbol,ReplacePartSymbol,ResourceModel,IAttributeParser,JitConfiguration}from"@aurelia/jit";import{TriggerBindingInstruction,DelegateBindingInstruction,CaptureBindingInstruction,TextBindingInstruction,SetAttributeInstruction,HTMLRuntimeConfiguration}from"@aurelia/runtime-html";import{PLATFORM,DI,Registration}from"@aurelia/kernel";import{BindingMode,IDOM,LetBindingInstruction,LetElementInstruction,HydrateElementInstruction,HydrateTemplateController,SetPropertyInstruction,InterpolationInstruction,HydrateAttributeInstruction,RefBindingInstruction,IExpressionParser,ITemplateCompiler}from"@aurelia/runtime";class TriggerBindingCommand{constructor(){this.s=86}compile(t){return new TriggerBindingInstruction(t.u,getTarget(t,0))}}BindingCommandResource.h("trigger",TriggerBindingCommand);class DelegateBindingCommand{constructor(){this.s=88}compile(t){return new DelegateBindingInstruction(t.u,getTarget(t,0))}}BindingCommandResource.h("delegate",DelegateBindingCommand);class CaptureBindingCommand{constructor(){this.s=87}compile(t){return new CaptureBindingInstruction(t.u,getTarget(t,0))}}BindingCommandResource.h("capture",CaptureBindingCommand);const invalidSurrogateAttribute={id:1,m:1,T:1},attributesToIgnore={g:1,m:1,T:1};class TemplateBinder{constructor(dom,t,e,n){this.dom=dom,this.C=t,this.B=e,this.p=n,this.A=null,this.manifest=null,this.I=null,this.L=null,this.M=null}bind(t){const e=this.A,n=this.L,i=this.I,r=this.manifest,o=this.A=this.manifest=new PlainElementSymbol(t),l=t.attributes;let s=0;for(;l.length>s;){const t=l[s],e=this.B.parse(t.name,t.value);if(1==invalidSurrogateAttribute[e.target])throw Error(`Invalid surrogate attribute: ${e.target}`);const n=this.C.k(e);if(null===n)this.D(e);else{if(n.isTemplateController)throw Error("Cannot have template controller on surrogate element.");this.P(e,n)}++s}return this.H(t),this.A=e,this.L=n,this.I=i,this.manifest=r,o}O(t,e){switch(e.nodeName){case"LET":return void this.F(t,e);case"SLOT":return void(this.A.hasSlots=1)}const n=this.L,i=this.I,r=this.manifest;let o;this.M=e.getAttribute("part");let name=e.getAttribute("as-element");null===name&&(name=e.nodeName.toLowerCase());const l=this.C.R(name);null===l?this.manifest=new PlainElementSymbol(e):(this.L=this.I,o=this.I=this.manifest=new CustomElementSymbol(this.dom,e,l)),this.H(e),this.S(e,t),void 0!==o&&o.$?e.parentNode.replaceChild(o.marker,e):this.manifest.v&&e.classList.add("au"),this.L=n,this.I=i,this.manifest=r}F(t,e){const n=new LetElementSymbol(this.dom,e);t.childNodes.push(n);const i=e.attributes;let r=0;for(;i.length>r;){const t=i[r];if("to-view-model"===t.name){e.removeAttribute("to-view-model"),n.toViewModel=1;continue}const o=this.B.parse(t.name,t.value),l=this.C.J(o),s=this.p.parse(o.q,null===l?2048:l.s),to=PLATFORM.G(o.target),u=new BindableInfo(to,BindingMode.K);n.U.push(new BindingSymbol(l,u,s,o.q,to)),++r}e.parentNode.replaceChild(n.marker,e)}S(t,e){const{L:n,I:i,manifest:r}=this;let o=r;const l=this.W(t);let s,u;const c=t.attributes;let h=0;for(;c.length>h;){const t=c[h];if(++h,1==attributesToIgnore[t.name])continue;const e=this.B.parse(t.name,t.value),n=this.C.k(e);null===n?this.D(e):n.isTemplateController?(u=r.templateController=this.X(e,n),o===r?(u.template=r,o=u):(u.templateController=s,u.template=s.template,s.template=u),s=u):this.P(e,n)}processTemplateControllers(this.dom,o,r),null===l?e.childNodes.push(o):(l.parent=e,l.template=o,(r===i?n:i).parts.push(l),processReplacePart(this.dom,l,o))}H(t){let e,n;for(e="TEMPLATE"===t.nodeName?t.content.firstChild:t.firstChild;null!==e;)switch(e.nodeType){case 1:n=e.nextSibling,this.O(this.manifest,e),e=n;break;case 3:e=this.Y(e).nextSibling;break;case 4:case 7:case 8:case 10:e=e.nextSibling;break;case 9:case 11:e=e.firstChild}}Y(t){const e=this.p.parse(t.wholeText,2048);if(null!==e){const n=new TextSymbol(this.dom,t,e);this.manifest.childNodes.push(n),processInterpolationText(n)}for(;null!==t.nextSibling&&3===t.nextSibling.nodeType;)t=t.nextSibling;return t}X(t,e){let n;const i=this.C.J(t);if(null===i&&e.Z)n=new TemplateControllerSymbol(this.dom,t,e,this.M),this.M=null,this._(n,e,t.q);else{n=new TemplateControllerSymbol(this.dom,t,e,this.M);const r=this.p.parse(t.q,null===i?2048:i.s);n.U.push(new BindingSymbol(i,e.bindable,r,t.q,t.target)),this.M=null}return n}P(t,e){const n=this.C.J(t);let i;if(null===n&&e.Z)i=new CustomAttributeSymbol(t,e),this._(i,e,t.q);else{i=new CustomAttributeSymbol(t,e);const r=this.p.parse(t.q,null===n?2048:n.s);i.U.push(new BindingSymbol(n,e.bindable,r,t.q,t.target))}this.manifest.attributes.push(i),this.manifest.v=1}_(t,e,value){const n=parseMultiAttributeBinding(value);let i;for(let r=0,o=n.length;o>r;++r){const o=this.B.parse((i=n[r]).name,i.value),l=this.C.J(o),s=this.p.parse(o.q,null===l?2048:l.s);let bindable=e.bindables[o.target];void 0===bindable&&(bindable=e.bindables[o.target]=new BindableInfo(o.target,BindingMode.K)),t.U.push(new BindingSymbol(l,bindable,s,o.q,o.target))}}D(t){if(0===t.q.length)return;const e=this.C.J(t),n=this.manifest,i=this.p.parse(t.q,null===e?2048:e.s);if(16&n.flags){const bindable=n.bindables[t.target];void 0!==bindable?(n.U.push(new BindingSymbol(e,bindable,i,t.q,t.target)),n.v=1):null!==i&&(n.attributes.push(new PlainAttributeSymbol(t,e,i)),n.v=1)}else null!==i||"ref"===t.target?(n.attributes.push(new PlainAttributeSymbol(t,e,i)),n.v=1):n===this.A&&n.attributes.push(new PlainAttributeSymbol(t,e,i))}W(t){const name=t.getAttribute("replace-part");return null===name?null:(t.removeAttribute("replace-part"),new ReplacePartSymbol(name))}}class ParserState{constructor(t){this.input=t,this.index=0,this.length=t.length}}const fromCharCode=String.fromCharCode,ITemplateElementFactory=DI.V("ITemplateElementFactory").N();class HTMLTemplateElementFactory{constructor(dom){this.dom=dom,this.template=dom.i()}i(t){if("string"==typeof t){const template=this.template;template.innerHTML=t;const e=template.content.firstElementChild;return null===e||"TEMPLATE"!==e.nodeName||null!==e.nextElementSibling?(this.template=this.dom.i(),template):(template.content.removeChild(e),e)}if("TEMPLATE"!==t.nodeName){const template=this.dom.i();return template.content.appendChild(t),template}return null!==t.parentNode&&t.parentNode.removeChild(t),t}}HTMLTemplateElementFactory.inject=[IDOM];const buildNotRequired=Object.freeze({required:0,compiler:"default"});class TemplateCompiler{constructor(t,e,n){this.j=t,this.B=e,this.p=n,this.tt=null}get name(){return"default"}compile(dom,t,e){const n=new TemplateBinder(dom,new ResourceModel(e),this.B,this.p),template=t.template=this.j.i(t.template),i=n.bind(template);void 0!==t.instructions&&t.instructions!==PLATFORM.et||(t.instructions=[]),1==i.hasSlots&&(t.hasSlots=1),this.tt=t.instructions;const r=i.attributes,o=r.length;if(o>0){let surrogates;void 0!==t.surrogates&&t.surrogates!==PLATFORM.et||(t.surrogates=Array(o)),surrogates=t.surrogates;for(let t=0;o>t;++t)surrogates[t]=this.nt(r[t])}return this.it(i),this.tt=null,t}it(t){if(8192&t.flags){const{childNodes}=t;let e;const n=childNodes.length;for(let t=0;n>t;++t)if(128&(e=childNodes[t]).flags)this.tt.push([new TextBindingInstruction(e.rt)]);else if(32&e.flags){const t=e.U,instructions=[];let n;const i=t.length;for(let e=0;i>e;++e)instructions[e]=new LetBindingInstruction((n=t[e]).u,n.target);this.tt.push([new LetElementInstruction(instructions,e.toViewModel)])}else this.ot(e)}}lt(t){const e=this.st(t,1);e[0]=new HydrateElementInstruction(t.res,this.ut(t),this.ct(t)),this.tt.push(e)}ht(t){const e=this.st(t,0);e.length>0&&this.tt.push(e),this.it(t)}ot(t){switch(511&t.flags){case 16:this.lt(t);break;case 64:this.ht(t);break;case 1:this.at(t)}}at(t){const e=this.ut(t),n=this.tt,i=this.tt=[];this.ot(t.template),this.tt=n,this.tt.push([new HydrateTemplateController({name:null===t.M?t.res:t.M,template:t.t,instructions:i,build:buildNotRequired},t.res,e,"else"===t.res)])}ut(t){let e;if(4096&t.flags){const{U:n}=t,i=n.length;e=Array(i);let r=0;for(;i>r;++r)e[r]=this.Tt(n[r])}else e=PLATFORM.et;return e}Tt(t){return null===t.command?null===t.u?new SetPropertyInstruction(t.q,t.bindable.ft):new InterpolationInstruction(t.u,t.bindable.ft):t.command.compile(t)}st(t,e){let n;if(2048&t.flags){const{attributes:i}=t,r=i.length;n=Array(e+r);for(let t=0;r>t;++t)n[t+e]=this.nt(i[t])}else n=e>0?Array(e):PLATFORM.et;return n}gt(t){const e=this.ut(t);return new HydrateAttributeInstruction(t.res,e)}dt(t){return null===t.command?null===t.u?new SetAttributeInstruction(t.l.q,t.l.target):new InterpolationInstruction(t.u,t.l.target):t.command.compile(t)}nt(t){return"ref"===t.l.target?new RefBindingInstruction(t.l.q):4&t.flags?this.gt(t):this.dt(t)}ct(t){let parts;if(16384&t.flags){parts={};const e=t.parts,n=e.length;let i,r,o;for(let t=0;n>t;++t)o=e[t],i=this.tt,r=this.tt=[],this.ot(o.template),parts[o.name]={name:o.name,template:o.t,instructions:r,build:buildNotRequired},this.tt=i}else parts=PLATFORM.Ct;return parts}}TemplateCompiler.inject=[ITemplateElementFactory,IAttributeParser,IExpressionParser];const HTMLBindingLanguage=[TriggerBindingCommand,DelegateBindingCommand,CaptureBindingCommand],HTMLJitConfiguration={register(t){t.register(HTMLRuntimeConfiguration,JitConfiguration,Registration.singleton(ITemplateCompiler,TemplateCompiler),Registration.singleton(ITemplateElementFactory,HTMLTemplateElementFactory),...HTMLBindingLanguage)},Bt(){const t=DI.Bt();return t.register(HTMLJitConfiguration),t}};export{TriggerBindingCommand,DelegateBindingCommand,CaptureBindingCommand,HTMLJitConfiguration,stringifyDOM,stringifyInstructions,stringifyTemplateDefinition,TemplateBinder,ITemplateElementFactory};
